VYTAH/ORI                                                                                                     PAGE 1

                       1    ; TODO: 
                       2    ; OK - Dorob nulovanie volieb v sachte 
                       3    ; Dorob 3UP a 2 DOWN (tam kde stojis vzdy)
                       4    ; Asi by bolo dobre premenovat PI1, PO1 a PI4 PO4 na alternativy s koncovkami U a D
                       5    ; Poriadne otestuj !!! 
                       6    ; Umo+zni stlacat tlacidla aj ked bezi delay
                       7    
                       8    
                       9    $MOD51
                      10    $DEBUG
                      11    
                =1    12    $include (lift.inc)
                =1    13    ; adresy I/O portov, ktore pridu na port P2 89C52-ky
  0080          =1    14    i8255INA        equ     080h
  0081          =1    15    i8255INB        equ     081h
  0082          =1    16    i8255INC        equ     082h
  0083          =1    17    i8255INCW       equ     083h
  00C0          =1    18    i8255OUTA       equ     0c0h
  00C1          =1    19    i8255OUTB       equ     0c1h
  00C2          =1    20    i8255OUTC       equ     0c2h
  00C3          =1    21    i8255OUTCW      equ     0c3h
                =1    22    
  0028          =1    23    INPORTA         data    28h         ; nutne kvoli emulatoru!!!
  0021          =1    24    INPORTB         data    21h
  0022          =1    25    INPORTC         data    22h
  0023          =1    26    OUTPORTA        data    23h
  0024          =1    27    OUTPORTB        data    24h
  0025          =1    28    OUTPORTC        data    25h
  0026          =1    29    INPORTBold      data    26h
  0027          =1    30    CTRLREG         data    27h
                =1    31    
  0030          =1    32    POSITION        data    30h
  0031          =1    33    LOWEST          data    31h
  0032          =1    34    HIGHEST         data    32h
  0033          =1    35    STOPTIMER       data    33h
  0034          =1    36    OUTPORTBold     data    34h
                =1    37    
  0040          =1    38    STOPNOT         bit     INPORTA.0
  0041          =1    39    PKI1            bit     INPORTA.1
  0042          =1    40    PKI2            bit     INPORTA.2
  0043          =1    41    PKI3            bit     INPORTA.3
  0044          =1    42    PKI4            bit     INPORTA.4
  0045          =1    43    DOORCLSD        bit     INPORTA.5 
                =1    44    
  0009          =1    45    MB1             bit     INPORTB.1       ; clonky maju invertovanu logiku
  000A          =1    46    MB2             bit     INPORTB.2
  000B          =1    47    SKRH            bit     INPORTB.3
  000C          =1    48    SKRD            bit     INPORTB.4
  000D          =1    49    DP              bit     INPORTB.5
  000E          =1    50    DPZK            bit     INPORTB.6
  000F          =1    51    DPK             bit     INPORTB.7
                =1    52    
  0031          =1    53    MB1old          bit     INPORTBold.1
  0032          =1    54    MB2old          bit     INPORTBold.2
  0033          =1    55    SKRHold         bit     INPORTBold.3
  0034          =1    56    SKRDold         bit     INPORTBold.4
                =1    57    
  0010          =1    58    PI1             bit     INPORTC.0
VYTAH/ORI/D                                                                                                  PAGE 2

  0011          =1    59    PI2D            bit     INPORTC.1
  0012          =1    60    PI2U            bit     INPORTC.2
  0013          =1    61    PI3D            bit     INPORTC.3
  0014          =1    62    PI3U            bit     INPORTC.4
  0015          =1    63    PI4             bit     INPORTC.5
                =1    64    
  0018          =1    65    KS              bit     OUTPORTA.0
  0019          =1    66    PKO1            bit     OUTPORTA.1
  001A          =1    67    PKO2            bit     OUTPORTA.2
  001B          =1    68    PKO3            bit     OUTPORTA.3
  001C          =1    69    PKO4            bit     OUTPORTA.4
                =1    70    
  0020          =1    71    UP              bit     OUTPORTB.0
  0021          =1    72    DOWN            bit     OUTPORTB.1
  0022          =1    73    FAST            bit     OUTPORTB.2
  0023          =1    74    SLOW            bit     OUTPORTB.3
  0024          =1    75    FLED1           bit     OUTPORTB.4
  0025          =1    76    FLED2           bit     OUTPORTB.5
  0026          =1    77    FLED3           bit     OUTPORTB.6
  0027          =1    78    FLED4           bit     OUTPORTB.7
                =1    79    
  0028          =1    80    PO1             bit     OUTPORTC.0
  0029          =1    81    PO2D            bit     OUTPORTC.1
  002A          =1    82    PO2U            bit     OUTPORTC.2
  002B          =1    83    PO3D            bit     OUTPORTC.3
  002C          =1    84    PO3U            bit     OUTPORTC.4
  002D          =1    85    PO4             bit     OUTPORTC.5
  002E          =1    86    LEDD            bit     OUTPORTC.6
  002F          =1    87    LEDU            bit     OUTPORTC.7
                =1    88    
  0038          =1    89    CANGO           bit     CTRLREG.0
  0039          =1    90    DOORCLSDold     bit     CTRLREG.1
  003A          =1    91    UPold           bit     CTRLREG.2
  003B          =1    92    DOWNold         bit     CTRLREG.3
  003C          =1    93    FASTold         bit     CTRLREG.4
  003D          =1    94    SLOWold         bit     CTRLREG.5
                =1    95    
  00B6          =1    96    WRNOT           bit     0b6h        ; p3.6
  00B7          =1    97    RDNOT           bit     0b7h        ; p3.7
                =1    98    
                =1    99    ; bitove masky
                =1   100    ; 8255OUT 
                =1   101    ; port A
  0001          =1   102    bmKS              equ    00000001b
  0002          =1   103    bmPKO1            equ    00000010b
  0004          =1   104    bmPKO2            equ    00000100b
  0008          =1   105    bmPKO3            equ    00001000b
  0010          =1   106    bmPKO4            equ    00010000b
                =1   107    
                =1   108    ; port B
  0001          =1   109    bmUP              equ    00000001b
  0002          =1   110    bmDOWN            equ    00000010b
  0004          =1   111    bmFAST            equ    00000100b
  0008          =1   112    bmSLOW            equ    00001000b
  0010          =1   113    bmFLED1           equ    00010000b
  0020          =1   114    bmFLED2           equ    00100000b
  0040          =1   115    bmFLED3           equ    01000000b
  0080          =1   116    bmFLED4           equ    10000000b
VYTAH/ORI                                                                                                     PAGE 3

                =1   117    
                =1   118    ; port C
  0001          =1   119    bmPO1             equ    00000001b
  0002          =1   120    bmPO2D            equ    00000010b
  0004          =1   121    bmPO2U            equ    00000100b
  0008          =1   122    bmPO3D            equ    00001000b
  0010          =1   123    bmPO3U            equ    00010000b
  0020          =1   124    bmPO4             equ    00100000b
  0040          =1   125    bmLEDD            equ    01000000b
  0080          =1   126    bmLEDU            equ    10000000b
                =1   127    
                =1   128    ; 8255IN
                =1   129    ; port A
  0001          =1   130    bmSTOP            equ    00000001b
  0002          =1   131    bmPKI1            equ    00000010b
  0004          =1   132    bmPKI2            equ    00000100b
  0008          =1   133    bmPKI3            equ    00001000b
  0010          =1   134    bmPKI4            equ    00010000b
  0020          =1   135    bmDOORCLSD        equ    00100000b
                =1   136    
                =1   137    ; port B
  0002          =1   138    bmMB1I            equ    00000010b
  0004          =1   139    bmMB2I            equ    00000100b
  0008          =1   140    bmSKRHI           equ    00001000b
  0010          =1   141    bmSKRHD           equ    00010000b
  0020          =1   142    bmDPI             equ    00100000b
  0040          =1   143    bmDPZKI           equ    01000000b
  0080          =1   144    bmDPKI            equ    10000000b
                =1   145    
                =1   146    ; port C
  0001          =1   147    bmPI1             equ    00000001b
  0002          =1   148    bmPI2D            equ    00000010b
  0004          =1   149    bmPI2U            equ    00000100b
  0008          =1   150    bmPI3D            equ    00001000b
  0010          =1   151    bmPI3U            equ    00010000b
  0020          =1   152    bmPI4             equ    00100000b
                =1   153    
                     154    
                     155    _BP_    MACRO 
                     156            clr     P3.3
                     157            setb    EX1
                     158            nop
                     159            nop
                     160    ENDM
                     161    
                     162    LJZ     MACRO   NAVESTIE
                     163            jnz     $+5
                     164            ljmp    NAVESTIE
                     165            nop
                     166    ENDM
                     167    
                     168    LJNZ    MACRO   NAVESTIE
                     169            jz      $+5
                     170            ljmp    NAVESTIE
                     171            nop
                     172    ENDM
                     173    
                     174    LJB     MACRO   TESTBIT, NAVESTIE
VYTAH/ORI/D                                                                                                  PAGE 4

                     175            jnb     TESTBIT, $+6
                     176            ljmp    NAVESTIE
                     177            nop
                     178    ENDM
                     179    
                     180    LJNB    MACRO   TESTBIT, NAVESTIE
                     181            jb      TESTBIT, $+6
                     182            ljmp    NAVESTIE
                     183            nop
                     184    ENDM
                     185    
                     186    CJE     MACRO   OP1, OP2, NAVESTIE
                     187            cjne    OP1, OP2, $+7
                     188            jmp    NAVESTIE
                     189            nop
                     190    ENDM
                     191    
                     192    LCJNE   MACRO   OP1, OP2, NAVESTIE
                     193            cjne    OP1, OP2, $+6
                     194            jmp     $+6
                     195            ljmp    NAVESTIE
                     196            nop
                     197    ENDM
                     198    
                     199    ZAKMITC MACRO   TYPCLONKY
                     200            lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
                     201            lcall   READPORTS       ; Uz sme z tej clonky prec?
                     202            jnb     TYPCLONKY, $-3  ; 
                     203            lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                     204    ENDM
                     205    
                     206    ZASTAV  MACRO  C_POSCH, SMER
                     207                                            ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
                     208            clr     C                       ; | Idem robit cachre-machre s Carry bitom
                     209            mov     A, #0h                  ; | Aj Acc potrebujem prazdny
                     210            orl     C, PKI&C_POSCH          ; | Mam v tomto smere stlacene tlacidlo v kabine?
                     211            orl     C, PI&C_POSCH&SMER      ; | Mam v tomto smere stlacene tlacidlo v sachte?
                     212            anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim) 
                     213            orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
                     214            ;mov     A, bmSmerPI1U
                     215            addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
                     216    ENDM
                     217    
                     218    NAJNIZSIE  MACRO
                     219            mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
                     220            rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
                     221            anl     A, #01111110b   ; Vynulujem nedefinovane bity
                     222            mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
VYTAH/ORI/D                                                                                                  PAGE 5

                     223     ; LL1: 
                     224            jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
                     225            clr     C               ; Inak shiftnem o 2
                     226            rlc     A               ;
                     227            clr     C               ;
                     228            rlc     A               ;
                     229            djnz    R0, $-6         ; ...a pokracujem v zistovani
                     230    ; LL2:
                     231            mov     A, R0           ; vysledne (najnizsie zvolene) poschodie je index v R0
                     232    ENDM
                     233    
                     234    NAJVYSSIE  MACRO
                     235            mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
                     236            rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
                     237            anl     A, #01111110b   ; Vynulujem nedefinovane bity
                     238            mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                     239     ; LL1: 
                     240            jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
                     241            clr     C               ; Inak shiftnem o 2
                     242            rrc     A               ;
                     243            clr     C               ;
                     244            rrc     A               ;
                     245            djnz    R0, $-6         ; ...a pokracujem v zistovani
                     246    ; LL2:
                     247            mov     A, #5           ; vysledne (najnizsie zvolene) poschodie je index v R0
                     248            clr     C               ;
                     249            subb    A, R0           ;
                     250    ENDM
                     251    
                     252    VYSSIE_KABINA  MACRO  POSCH
                     253            mov     A, INPORTA
                     254            anl     A, #00011110b
                     255            clr     C
                     256            rrc     A
                     257    ;LL1    
                     258            mov     R0, #&POSCH
                     259            clr     C
                     260            rrc     A
                     261            djnz    R0, $-2;LL1
                     262    ENDM
                     263    
                     264    NIZSIE_KABINA  MACRO  POSCH
                     265            mov     A, #5
                     266            clr     C
                     267            subb    A, #&POSCH
                     268            mov     R0, A
                     269            mov     A, INPORTA
                     270            anl     A, #00011110b
                     271            clr     C
                     272            rlc     A
                     273            clr     C
                     274            rlc     A
VYTAH/ORI/D                                                                                                  PAGE 6

                     275            clr     C
                     276            rlc     A
                     277    ;LL1   
                     278            clr     C
                     279            rlc     A
                     280            djnz    R0, $-2;LL1
                     281    ENDM
                     282    
                     283    POLOHA_LED  MACRO  POLOHA
                     284            clr     LEDU            
                     285            clr     LEDD 
                     286            clr     FLED1             
                     287            clr     FLED2                
                     288            clr     FLED3           
                     289            clr     FLED4           
                     290            setb    FLED&POLOHA
                     291            lcall   WRITEPORTS
                     292    ENDM
                     293    
  0036               294    FLOORREQ        data    36h
                     295    
                     296    ; hodiny oscilatora v emulatore treba dat na ext a nastavit 11.0592MHz
  00FA               297    TIMERCONST      equ     250     ; udaj pre nastavenie casovaca pre potreby seriovej komunika
                                                                               cie
                     298                                    ; hodnota 250 znamena prenosovu rychlost 4800 baud pri oscil
                                                                               atore 11.0592MHz
                     299                                    ; nastavenie terminalu je 4800 8-N-1, no flow control
                     300    ;osetrenie vektorov preruseni
0000                 301            org     0000h           ; adresa odkial startuje program po resete
0000 020033          302            ljmp    START           ; skok na zaciatok kodu programu
                     303                  
0033                 304            org     0033h           ; od tejto adresy sa zacina kod programu
0033                 305    START:
0033                 306    RESET:  
                     307            ; riadiace signaly do pasivnej urovne 
0033 D2B6            308            setb    WRNOT
0035 D2B7            309            setb    RDNOT
0037 753300          310            mov     STOPTIMER, #0
003A 758140          311            mov     SP, #STACK
                     312    
                     313            ; pockame si na inicializaciu obvodov 8255  
003D 7900            314            mov     R1, #0 
003F 7AFF            315            mov     R2, #0ffh
0041 D9FE            316            djnz    R1, $
0043 DAFC            317            djnz    R2, $-2
                     318            
                     319            ; teraz ich mozeme nastavit
0045 75809B          320            mov     p0, #10011011b      ; nastavenie i8255IN - vsetky porty dnu
0048 75A083          321            mov     p2, #i8255INCW
004B C2B6            322            clr     WRNOT
004D 00              323            nop
004E 00              324            nop
004F 00              325            nop
0050 00              326            nop
0051 D2B6            327            setb    WRNOT
0053 758080          328            mov     p0, #10000000b      ; nastavenie i8255OUT - vsetky porty von
0056 75A0C3          329            mov     p2, #i8255OUTCW
0059 C2B6            330            clr     WRNOT
VYTAH/ORI)D                                                                                                  PAGE 7

005B 00              331            nop
005C 00              332            nop
005D 00              333            nop
005E 00              334            nop
005F D2B6            335            setb    WRNOT
                     336            
                     337 +1         _BP_
0061 C2B3            338 +1         clr     P3.3
0063 D2AA            339 +1         setb    EX1
0065 00              340 +1         nop
0066 00              341 +1         nop
                     343    
                     344            ; pociatocna inicializacia - vynuluj vstupne registre a rozsviet vsetky diody 
0067 752800          345            mov     INPORTA, #0
006A 75211E          346            mov     INPORTB, #01eh      ; vsetky clonky pasivne
006D 752200          347            mov     INPORTC, #0
0070 75231E          348            mov     OUTPORTA, #(bmPKO1 or bmPKO2 or bmPKO3 or bmPKO4)
0073 7524F0          349            mov     OUTPORTB, #(bmFLED1 or bmFLED2 or bmFLED3 or bmFLED4)
0076 7525FF          350            mov     OUTPORTC, #(bmPO1 or bmPO2D or bmPO2U or bmPO3D or bmPO3U or bmPO4 or bmLEDD
                                                                                or bmLEDU)
0079 D218            351            setb    KS
007B 12078E          352            call    WRITEPORTS          ; zapis novu informaciu
                     353    ;;;;;;;;
                     354    
007E 752300          355            mov     OUTPORTA, #0
0081 752400          356            mov     OUTPORTB, #0
0084 752500          357            mov     OUTPORTC, #0
0087 12078E          358            call    WRITEPORTS          ; zapis novu informaciu
                     359    
008A 752800          360            mov     INPORTA, #0
008D 752100          361            mov     INPORTB, #0         
0090 752200          362            mov     INPORTC, #0
0093 120740          363            call    READPORTS           ; prvotne nacitanie udajov
                     364    
0096                 365    CALIB:
                     366            ;kalibracia vytahu podla dolnej porovnavacej clonky
0096 120740          367            lcall   READPORTS                   ; precitaj, co je na portoch
0099 300C11          368            jnb     SKRD, CALIBEND              ; ak sme na dolnej porovnavacej clonke, tak koni
                                                                               ec
009C D221            369            setb    DOWN                        ; inak pod dole
009E D222            370            setb    FAST                        ; a rychlo
00A0 C223            371            clr     SLOW                        ;
00A2 12078E          372            lcall   WRITEPORTS                  ; zapis informaciu 
00A5                 373    CALIBLOOP:
00A5 120740          374            lcall   READPORTS                   ; 
00A8 300C02          375            jnb     SKRD, CALIBEND              ; ak sme dole, konci
00AB 80F8            376            jmp     CALIBLOOP
00AD                 377    CALIBEND:                              
00AD C222            378            clr     FAST                        ; zastavime v tomto smere
00AF C221            379            clr     DOWN                        ;
00B1 D223            380            setb    SLOW                        ; Este sa pohneme kusocek hore, aby sme si 
00B3 D220            381            setb    UP                          ; boli isti, ze sme spravne synchronizovani na p
                                                                               oschodi
00B5 12078E          382            lcall   WRITEPORTS 
00B8                 383    CALIBEND2:
00B8 120740          384            lcall   READPORTS                   ; 
00BB 2009FA          385            jb      MB1, CALIBEND2              ; 
00BE C223            386            clr     SLOW                        ; A teraz sme uz naozaj spravne
VYTAH/ORI,D                                                                                                  PAGE 8

00C0 C220            387            clr     UP                          ; 
00C2 D224            388            setb    FLED1
00C4 12078E          389            lcall   WRITEPORTS                  ; zapis informaciu
                     390    ;        _BP_
00C7                 391    MAIN:
                     392    
                     393    ;            |  7    |  6    |  5    |  4    |  3    |  2    |  1    |  0    |
                     394    ; ****************************************************************************
                     395    ; INPORTA >  |       |       |DOORCLS| PKI4  | PKI3  | PKI2  | PKI1  |STOPNOT|
                     396    ; ----------------------------------------------------------------------------
                     397    ; INPORTB >  | DPK   | DPZK  | DP    | SKRD  | SKRH  | MB2   | MB1   |       |
                     398    ; ----------------------------------------------------------------------------
                     399    ; INPORTC >  |       |       | PI4   | PI3D  | PI3U  | PI2D  | PI2U  | PI1   |
                     400    ; ****************************************************************************
                     401    ; OUTPORTA > |       |       |       | PKO4  | PKO3  | PKO2  | PKO1  | KS    |
                     402    ; ----------------------------------------------------------------------------
                     403    ; OUTPORTB > | FLED4 | FLED3 | FLED2 | FLED1 | SLOW  | FAST  | DOWN  | UP    |
                     404    ; ----------------------------------------------------------------------------
                     405    ; OUTPORTC > | LEDU  | LEDD  | PO4   | PO3D  | PO3U  | PO2D  | PO2U  | PO1   |
                     406    ; ****************************************************************************
                     407    ; POSITION
                     408    ; ****************************************************************************
                     409    
                     410    
                     411    ;------------------------------------------------------------------------------- << 1. posch
                                                                               odie >>
                     412    
00C7                 413    FLOOR1:
                     414 +1                 POLOHA_LED 1  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
00C7 C22F            415 +1         clr     LEDU            
00C9 C22E            416 +1         clr     LEDD 
00CB C224            417 +1         clr     FLED1             
00CD C225            418 +1         clr     FLED2                
00CF C226            419 +1         clr     FLED3           
00D1 C227            420 +1         clr     FLED4           
00D3 D224            421 +1         setb    FLED1
00D5 12078E          422 +1         lcall   WRITEPORTS
00D8 120727          424            lcall   WAITFORTIMER    ; simulacia TIMERu
00DB 120740          425    F1S:    lcall   READPORTS     ;-; nacitanie dat
00DE C219            426            clr     PKO1          ;-; vynulovanie volby poschodia na ktorom stojim
00E0 C228            427            clr     PO1             ;
00E2 12078E          428            lcall   WRITEPORTS      ;
00E5 E528            429            mov     A, INPORTA      ; zistenie, ci bolo stlacene nieco viac ako poschodie na kto
                                                                               rom stojim (Kabina)
00E7 541C            430            anl     A, #00011100b ;-;
00E9 7008            431            jnz     F1OK          ;-; ak ano, podme na to
00EB E522            432            mov     A, INPORTC      ; zistenie, ci bolo stlacene nieco viac ako poschodie na kto
                                                                               rom stojim (Sachta)
00ED 543E            433            anl     A, #00111110b ;-;
00EF 7002            434            jnz     F1OK          ;-; ak ano, podme na to
00F1 80E8            435            jmp     F1S             ; Nemam sa kde hnut, opakujem
00F3 D220            436    F1OK:   setb    UP              ; rychly pohyb hore
00F5 D222            437            setb    FAST            ; 
00F7 C223            438            clr     SLOW            ;
00F9 12078E          439            lcall   WRITEPORTS      ; 
00FC 0200FF          440            jmp     UP1           ;-; prejdi do stavu UP1
00FF                 441    UP1:
VYTAH/ORILDôD©4                                                                                              PAGE 9

                     442 +1                 POLOHA_LED 1  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
00FF C22F            443 +1         clr     LEDU            
0101 C22E            444 +1         clr     LEDD 
0103 C224            445 +1         clr     FLED1             
0105 C225            446 +1         clr     FLED2                
0107 C226            447 +1         clr     FLED3           
0109 C227            448 +1         clr     FLED4           
010B D224            449 +1         setb    FLED1
010D 12078E          450 +1         lcall   WRITEPORTS
                     452 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
0110 120711          453 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0113 120740          454 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0116 3009FA          455 +1         jnb     MB1, $-3  ; 
0119 120711          456 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
011C 120740          458    UP1A:   lcall   READPORTS       ; nacitanie dat
                     459 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
011F 200B03          460 +1         jb      SKRH, $+6
0122 0206F6          461 +1         ljmp    ERR_SKRH
0125 00              462 +1         nop
                     464 +1         ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na z
                                                                               astavovaciu) <<<
0126 200903          465 +1         jb      MB1, $+6
0129 0206C9          466 +1         ljmp    ERR_2SPOM_C
012C 00              467 +1         nop
012D 200AEC          469            jb      MB2, UP1A     ;-; mame uz 1. spomalovaciu clonku?
                     470 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme      
0130 120711          471 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0133 120740          472 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0136 300AFA          473 +1         jnb     MB2, $-3  ; 
0139 120711          474 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
013C D22E            476            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
013E 12078E          477            lcall   WRITEPORTS      ;
0141 020144          478            jmp     UP1_MB2       ;-; a prejdi do stavu UP1_MB2
0144                 479    UP1_MB2:
0144 120740          480            lcall   READPORTS       ; nacitanie dat
                     481 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
0147 200B03          482 +1         jb      SKRH, $+6
014A 0206F6          483 +1         ljmp    ERR_SKRH
014D 00              484 +1         nop
                     486 +1         ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na zas
                                                                               tavovaciu) <<<
014E 200903          487 +1         jb      MB1, $+6
0151 0206BA          488 +1         ljmp    ERR_1SPOM_C
0154 00              489 +1         nop
0155 200AEC          491            jb      MB2, UP1_MB2  ;-; mame uz aj druhu spomalovaciu clonku?     
0158 D22F            492            setb    LEDU            ; Rozsviet LEDku, ze mame druhu MB2
015A 12078E          493            lcall   WRITEPORTS      ;   
                     494 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
015D 120711          495 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0160 120740          496 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0163 300AFA          497 +1         jnb     MB2, $-3  ; 
0166 120711          498 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0169 E528            500            mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
016B 5404            501            anl     A, #00000100b ;-;
VYTAH/ORI<DLG©4                                                                                              PAGE 10

016D 600A            502            jz      UP1_MB1       ;-;       Ak nie, chod do stavu UP1_MB1
016F D223            503            setb    SLOW            ;       Ak ano, spomalme
0171 C222            504            clr     FAST            ; 
0173 12078E          505            lcall   WRITEPORTS      ;         
0176 020179          506            jmp     UP1_MB1       ;-; a prejdi do stavu UP1_MB1 
0179                 507    UP1_MB1:
0179 120740          508            lcall   READPORTS       ; nacitanie dat
                     509 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
017C 200B03          510 +1         jb      SKRH, $+6
017F 0206F6          511 +1         ljmp    ERR_SKRH
0182 00              512 +1         nop
                     514 +1         ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na spo
                                                                               malovaciu) <<<
0183 200A03          515 +1         jb      MB2, $+6
0186 0206D8          516 +1         ljmp    ERR_ZAST_C
0189 00              517 +1         nop
018A 2009EC          519            jb      MB1, UP1_MB1  ;-; Sme na zastavovacej clonke?
                     520            
                     521 +1         ZASTAV  2, U            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0) 
                     522 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
018D C3              523 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
018E 7400            524 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
0190 7242            525 +1         orl     C, PKI2          ; | Mam v tomto smere stlacene tlacidlo v kabine?
0192 7212            526 +1         orl     C, PI2U      ; | Mam v tomto smere stlacene tlacidlo v sachte?
0194 B00E            527 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim) 
0196 720F            528 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
                     529 +1         ;mov     A, bmSmerPI1U
0198 3400            530 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
019A 702E            532            jnz     U1_MB1C       ;-; Ak ano, zastav
                     533 +1         NAJVYSSIE               ; | ..a sme na najvyssom privolanom poschodi? (potom stojime
                                                                                urcite)
019C E522            534 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
019E 33              535 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
019F 547E            536 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
01A1 7805            537 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                     538 +1  ; LL1: 
01A3 6006            539 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
01A5 C3              540 +1         clr     C               ; Inak shiftnem o 2
01A6 13              541 +1         rrc     A               ;
01A7 C3              542 +1         clr     C               ;
01A8 13              543 +1         rrc     A               ;
01A9 D8F8            544 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                     545 +1 ; LL2:
01AB 7405            546 +1         mov     A, #5           ; vysledne (najnizsie zvolene) poschodie je index v R0
01AD C3              547 +1         clr     C               ;
01AE 98              548 +1         subb    A, R0           ;
                     550 +1         LCJNE   A, #2, UP2      ; |   ak nie, nezastavujeme 
VYTAH/ORIDêH©4îH©4ôH©4                                                                                      PAGE 11

01AF B40203          551 +1         cjne    A, #2, $+6
01B2 0201B8          552 +1         jmp     $+6
01B5 020251          553 +1         ljmp    UP2
01B8 00              554 +1         nop
                     556 +1         VYSSIE_KABINA 2         ; | ..ok, sme na najvyssom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
01B9 E528            557 +1         mov     A, INPORTA
01BB 541E            558 +1         anl     A, #00011110b
01BD C3              559 +1         clr     C
01BE 13              560 +1         rrc     A
                     561 +1 ;LL1    
01BF 7802            562 +1         mov     R0, #2
01C1 C3              563 +1         clr     C
01C2 13              564 +1         rrc     A
01C3 D8FC            565 +1         djnz    R0, $-2;LL1
01C5 6003            567            jz      U1_MB1C         ; |   ak neni zastavujem         
01C7 020251          568            ljmp    UP2             ; |   inak nezastavim        
01CA C220            569    U1_MB1C:clr     UP              ; zastav motor
01CC D23A            570            setb    UPOld           ;       (a zalohuj) 
01CE C23B            571            clr     DOWNOld         ;       (a zalohuj)
01D0 C222            572            clr     FAST            ; 
01D2 12078E          573            lcall   WRITEPORTS      ; 
01D5 0201D8          574            jmp     FLOOR2        ;-; a prejdi do stavu FLOOR2
                     575    
                     576    ;------------------------------------------------------------------------------- << 2. posch
                                                                               odie >>
                     577    
01D8                 578    FLOOR2:
                     579 +1                 POLOHA_LED 2  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
01D8 C22F            580 +1         clr     LEDU            
01DA C22E            581 +1         clr     LEDD 
01DC C224            582 +1         clr     FLED1             
01DE C225            583 +1         clr     FLED2                
01E0 C226            584 +1         clr     FLED3           
01E2 C227            585 +1         clr     FLED4           
01E4 D225            586 +1         setb    FLED2
01E6 12078E          587 +1         lcall   WRITEPORTS
01E9 120727          589            lcall   WAITFORTIMER    ; simulacia TIMERu
01EC 120740          590    F2S:    lcall   READPORTS     ;-; nacitanie dat
01EF C21A            591            clr     PKO2          ;-; vynulovanie volby poschodia na ktorom stojim
01F1 C22A            592            clr     PO2U            ;
01F3 C229            593            clr     PO2D            ;
01F5 12078E          594            lcall   WRITEPORTS      ;
                     595            ;_BP_
01F8 79F8            596            mov     R1, #11111000b;-; Default predpokladam, ze mam namierene hore (na 3. a 4.) k
                                                                               abina
01FA 7AF8            597            mov     R2, #11111000b;-; Default predpokladam, ze mam namierene hore (na 3. a 4.) s
                                                                               achta
01FC 203A06          598            jb      UPOld, F2OK     ;   Je to pravda? Naozaj som doteraz isiel hore?
01FF E9              599            mov     A, R1           ;       Ak nie, znegujeme masku kabiny
0200 F4              600            cpl     A               ;       |
0201 F9              601            mov     R1, A           ;       |
0202 EA              602            mov     A, R2           ;       A znegujeme aj masku sachty
0203 F4              603            cpl     A               ;       |
0204 FA              604            mov     R2, A           ;       |
0205                 605    F2OK:   ; Pohyb v jednom smere (nevieme v ktorom)
VYTAH/ORI TDŽI©4                                                                                              PAGE 12

0205 E528            606            mov     A, INPORTA      ; zistenie, ci bolo stlacene nieco viac (menej) ako poschodi
                                                                               e na ktorom stojim (Kabina)
0207 541A            607            anl     A, #00011010b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
0209 59              608            anl     A, R1           ;  | 
020A 7027            609            jnz     F2              ; nasli sme poschodie v tomto smere, mozme ist
                     610                                    ; zistenie, ci bolo stlacene nieco viac (menej) ako poschodi
                                                                               e na ktorom stojim (Sachta)
020C E528            611            mov     A, INPORTA      ; Mam v kabine nieco stlacene?
020E 541A            612            anl     A, #00011010b   ;  | Beriem iba bity predstavujuce tlacidla poschodi (kabina
                                                                               )
0210 7007            613            jnz     F2SW            ;  | Ak ano, idem rovno zistovat opacny smer.
0212 E522            614            mov     A, INPORTC      ; Mam stlacene nieco v sachte (mojim smerom)?    
0214 5439            615            anl     A, #00111001b   ;  | Beriem iba bity predstavujuce tlacidla privolavacov
0216 5A              616            anl     A, R2           ;  |   
0217 701A            617            jnz     F2              ; nasli sme poschodie v tomto smere, mozme ist
                     618            ; Pohyb v opacnom smere (nevieme v ktorom)
0219 B23A            619    F2SW:   cpl     UPOld           ;  Znegujem stary posun
021B B23B            620            cpl     DOWNOld         ;  |
021D E9              621            mov     A, R1           ;  Znegujeme masky
021E F4              622            cpl     A               ;  |
021F F9              623            mov     R1, A           ;  |
0220 EA              624            mov     A, R2           ;  |
0221 F4              625            cpl     A               ;  |
0222 FA              626            mov     R2, A           ;  |               
0223 E528            627            mov     A, INPORTA      ; zistenie, cibolo stlacene nieco viac ako poschodie na ktor
                                                                               om stojim (Kabina)
0225 541A            628            anl     A, #00011010b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
0227 59              629            anl     A, R1           ;  | 
0228 7009            630            jnz     F2              ; nasli sme poschodie v tomto smere, mozme ist
022A E522            631            mov     A, INPORTC      ; zistenie, cibolo stlacene nieco viac ako poschodie na ktor
                                                                               om stojim (Sachta)
022C 5439            632            anl     A, #00111001b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
022E 5A              633            anl     A, R2           ;  | 
022F 7002            634            jnz     F2              ; nasli sme poschodie v tomto smere, mozme ist
0231 80B9            635            jmp     F2S           ;-; nemame sa kde hybat, tak opakujeme zistovanie
0233 203A03          636    F2:     jb      UPOld, F2UP     ;   
0236 020245          637            jmp     F2DOWN          ;
0239 D220            638    F2UP:   setb    UP              ; rychly pohyb hore
023B D222            639            setb    FAST            ; 
023D C223            640            clr     SLOW            ;
023F 12078E          641            lcall   WRITEPORTS      ; 
0242 020251          642            jmp     UP2           ;-; prejdi do stavu UP2    
0245 D221            643    F2DOWN: setb    DOWN            ; rychly pohyb hore
0247 D222            644            setb    FAST            ; 
0249 C223            645            clr     SLOW            ;
024B 12078E          646            lcall   WRITEPORTS      ; 
024E 02032A          647            jmp     DOWN2         ;-; prejdi do stavu DOWN2    
                     648            
                     649                
0251                 650    UP2:
                     651 +1                 POLOHA_LED 2  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
0251 C22F            652 +1         clr     LEDU            
0253 C22E            653 +1         clr     LEDD 
0255 C224            654 +1         clr     FLED1             
0257 C225            655 +1         clr     FLED2                
0259 C226            656 +1         clr     FLED3           
025B C227            657 +1         clr     FLED4           
VYTAH/ORI,DÚI©4                                                                                              PAGE 13

025D D225            658 +1         setb    FLED2
025F 12078E          659 +1         lcall   WRITEPORTS
                     661 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
0262 120711          662 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0265 120740          663 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0268 3009FA          664 +1         jnb     MB1, $-3  ; 
026B 120711          665 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
026E 120740          667    UP2A:   lcall   READPORTS       ; nacitanie dat
                     668 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
0271 200B03          669 +1         jb      SKRH, $+6
0274 0206F6          670 +1         ljmp    ERR_SKRH
0277 00              671 +1         nop
                     673 +1         ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na z
                                                                               astavovaciu) <<<
0278 200903          674 +1         jb      MB1, $+6
027B 0206C9          675 +1         ljmp    ERR_2SPOM_C
027E 00              676 +1         nop
027F 200AEC          678            jb      MB2, UP2A     ;-; mame uz 1. spomalovaciu clonku?
                     679 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
0282 120711          680 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0285 120740          681 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0288 300AFA          682 +1         jnb     MB2, $-3  ; 
028B 120711          683 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
028E D22E            685            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
0290 12078E          686            lcall   WRITEPORTS      ;
0293 020296          687            jmp     UP2_MB2       ;-; a prejdi do stavu UP2_MB2
0296                 688    UP2_MB2:
0296 120740          689            lcall   READPORTS       ; nacitanie dat
                     690 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
0299 200B03          691 +1         jb      SKRH, $+6
029C 0206F6          692 +1         ljmp    ERR_SKRH
029F 00              693 +1         nop
                     695 +1         ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na zas
                                                                               tavovaciu) <<<
02A0 200903          696 +1         jb      MB1, $+6
02A3 0206BA          697 +1         ljmp    ERR_1SPOM_C
02A6 00              698 +1         nop
02A7 200AEC          700            jb      MB2, UP2_MB2  ;-; mame uz aj druhu spomalovaciu clonku?          
02AA D22F            701            setb    LEDU            ; Rozsviet LEDku, ze mame druhu MB2
02AC 12078E          702            lcall   WRITEPORTS      ;
                     703 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
02AF 120711          704 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
02B2 120740          705 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
02B5 300AFA          706 +1         jnb     MB2, $-3  ; 
02B8 120711          707 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
02BB E528            709            mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
02BD 5408            710            anl     A, #00001000b ;-;
02BF 600A            711            jz      UP2_MB1       ;-;       Ak nie, chod do stavu UP2_MB1
02C1 D223            712            setb    SLOW            ;       Ak ano, spomalme
02C3 C222            713            clr     FAST            ; 
02C5 12078E          714            lcall   WRITEPORTS      ;
02C8 0202CB          715            jmp     UP2_MB1       ;-; a prejdi do stavu UP2_MB1 
02CB                 716    UP2_MB1:
02CB 120740          717            lcall   READPORTS       ; nacitanie dat
                     718 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
VYTAH/ORID€L©4ˆL©4                                                                                          PAGE 14

02CE 200B03          719 +1         jb      SKRH, $+6
02D1 0206F6          720 +1         ljmp    ERR_SKRH
02D4 00              721 +1         nop
                     723 +1         ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na spo
                                                                               malovaciu) <<<
02D5 200A03          724 +1         jb      MB2, $+6
02D8 0206D8          725 +1         ljmp    ERR_ZAST_C
02DB 00              726 +1         nop
02DC 2009EC          728            jb      MB1, UP2_MB1  ;-; Sme na zastavovacej clonke?
                     729            
                     730 +1         ZASTAV  3, U            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0)
                     731 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
02DF C3              732 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
02E0 7400            733 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
02E2 7243            734 +1         orl     C, PKI3          ; | Mam v tomto smere stlacene tlacidlo v kabine?
02E4 7214            735 +1         orl     C, PI3U      ; | Mam v tomto smere stlacene tlacidlo v sachte?
02E6 B00E            736 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim) 
02E8 720F            737 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
                     738 +1         ;mov     A, bmSmerPI1U
02EA 3400            739 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
02EC 702E            741            jnz     U2_MB1C       ;-; Ak ano, zastav
                     742 +1         NAJVYSSIE               ; | ..a sme na najvyssom privolanom poschodi z kabiny? (poto
                                                                               m stojime urcite)
02EE E522            743 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
02F0 33              744 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
02F1 547E            745 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
02F3 7805            746 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                     747 +1  ; LL1: 
02F5 6006            748 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
02F7 C3              749 +1         clr     C               ; Inak shiftnem o 2
02F8 13              750 +1         rrc     A               ;
02F9 C3              751 +1         clr     C               ;
02FA 13              752 +1         rrc     A               ;
02FB D8F8            753 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                     754 +1 ; LL2:
02FD 7405            755 +1         mov     A, #5           ; vysledne (najnizsie zvolene) poschodie je index v R0
02FF C3              756 +1         clr     C               ;
0300 98              757 +1         subb    A, R0           ;
                     759 +1         LCJNE   A, #3, UP3      ; |   ak nie, nezastavujeme  
0301 B40303          760 +1         cjne    A, #3, $+6
0304 02030A          761 +1         jmp     $+6
0307 020435          762 +1         ljmp    UP3
030A 00              763 +1         nop
                     765 +1         VYSSIE_KABINA 3         ; | ..ok, sme na najvyssom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
030B E528            766 +1         mov     A, INPORTA
VYTAH/ORI\D(N©4                                                                                              PAGE 15

030D 541E            767 +1         anl     A, #00011110b
030F C3              768 +1         clr     C
0310 13              769 +1         rrc     A
                     770 +1 ;LL1    
0311 7803            771 +1         mov     R0, #3
0313 C3              772 +1         clr     C
0314 13              773 +1         rrc     A
0315 D8FC            774 +1         djnz    R0, $-2;LL1
0317 6003            776            jz      U2_MB1C         ; |   ak neni zastavujem  
0319 020435          777            ljmp    UP3             ; |   inak nezastavim
031C C220            778    U2_MB1C:clr     UP              ; zastav motor
031E D23A            779            setb    UPOld           ;       (a zalohuj)
0320 C23B            780            clr     DOWNOld         ;       (a zalohuj)
0322 C222            781            clr     FAST            ; 
0324 12078E          782            lcall   WRITEPORTS      ; 
0327 0203BC          783            jmp     FLOOR3        ;-; a prejdi do stavu FLOOR3
032A                 784    DOWN2:
                     785 +1                 POLOHA_LED 2  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
032A C22F            786 +1         clr     LEDU            
032C C22E            787 +1         clr     LEDD 
032E C224            788 +1         clr     FLED1             
0330 C225            789 +1         clr     FLED2                
0332 C226            790 +1         clr     FLED3           
0334 C227            791 +1         clr     FLED4           
0336 D225            792 +1         setb    FLED2
0338 12078E          793 +1         lcall   WRITEPORTS
                     795 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
033B 120711          796 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
033E 120740          797 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0341 3009FA          798 +1         jnb     MB1, $-3  ; 
0344 120711          799 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0347 120740          801            lcall   READPORTS       ; nacitanie dat
                     802 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
034A 200C03          803 +1         jb      SKRD, $+6
034D 0206E7          804 +1         ljmp    ERR_SKRD
0350 00              805 +1         nop
                     807 +1         ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na z
                                                                               astavovaciu) <<<
0351 200903          808 +1         jb      MB1, $+6
0354 0206C9          809 +1         ljmp    ERR_2SPOM_C
0357 00              810 +1         nop
0358 200ACF          812            jb      MB2, DOWN2    ;-; mame uz 1. spomalovaciu clonku?
                     813 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme      
035B 120711          814 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
035E 120740          815 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0361 300AFA          816 +1         jnb     MB2, $-3  ; 
0364 120711          817 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0367 D22F            819            setb    LEDU            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
0369 12078E          820            lcall   WRITEPORTS      ;
036C 02036F          821            jmp     DOWN2_MB2     ;-; a prejdi do stavu DOWN2_MB2
036F                 822    DOWN2_MB2:
036F 120740          823            lcall   READPORTS       ; nacitanie dat
                     824 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
0372 200C03          825 +1         jb      SKRD, $+6
0375 0206E7          826 +1         ljmp    ERR_SKRD
VYTAH/ORIFDP©4P©4                                                                                          PAGE 16

0378 00              827 +1         nop
                     829 +1         ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na zas
                                                                               tavovaciu) <<<
0379 200903          830 +1         jb      MB1, $+6
037C 0206BA          831 +1         ljmp    ERR_1SPOM_C
037F 00              832 +1         nop
0380 200AEC          834            jb      MB2, DOWN2_MB2;-; mame uz aj druhu spomalovaciu clonku?          
0383 D22E            835            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame druhu MB2
0385 12078E          836            lcall   WRITEPORTS      ;
                     837 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
0388 120711          838 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
038B 120740          839 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
038E 300AFA          840 +1         jnb     MB2, $-3  ; 
0391 120711          841 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0394 E528            843            mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
0396 5402            844            anl     A, #00000010b ;-;
0398 600A            845            jz      DOWN2_MB1     ;-;       Ak nie, chod do stavu DOWN2_MB1
039A D223            846            setb    SLOW            ;       Ak ano, spomalme
039C C222            847            clr     FAST            ; 
039E 12078E          848            lcall   WRITEPORTS      ;
03A1 0203A4          849            jmp     DOWN2_MB1     ;-; a prejdi do stavu DOWN2_MB1
03A4                 850    DOWN2_MB1:    
03A4 120740          851            lcall   READPORTS       ; nacitanie dat
03A7 300C05          852            jnb     SKRD, D2_MB1C   ; Sme na hornej porovnavacej clonke? (tu zastavujeme v kazdo
                                                                               m pripade)
03AA 300902          853            jnb     MB1, D2_MB1C  ;-; Sme na zastavovacej clonke? (tu zastavujeme v kazdom pripa
                                                                               de)
03AD 80F5            854            jmp     DOWN2_MB1       ; Ak sme nechytili ani jednu clonku, opakujeme
03AF C221            855    D2_MB1C:clr     DOWN            ; zastav motor
03B1 D23B            856            setb    DOWNOld         ;       (a zalohuj)
03B3 C23A            857            clr     UPOld           ;       (a zalohuj)
03B5 C222            858            clr     FAST            ; 
03B7 12078E          859            lcall   WRITEPORTS      ; 
03BA 01C7            860            jmp     FLOOR1        ;-; a prejdi do stavu FLOOR2      
                     861    
                     862    
                     863    ;------------------------------------------------------------------------------- << 3. posch
                                                                               odie >>
                     864    
03BC                 865    FLOOR3:
                     866 +1                 POLOHA_LED 3  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
03BC C22F            867 +1         clr     LEDU            
03BE C22E            868 +1         clr     LEDD 
03C0 C224            869 +1         clr     FLED1             
03C2 C225            870 +1         clr     FLED2                
03C4 C226            871 +1         clr     FLED3           
03C6 C227            872 +1         clr     FLED4           
03C8 D226            873 +1         setb    FLED3
03CA 12078E          874 +1         lcall   WRITEPORTS
03CD 120727          876            lcall   WAITFORTIMER    ; simulacia TIMERu
03D0 120740          877    F3S:    lcall   READPORTS     ;-; nacitanie dat
03D3 C21B            878            clr     PKO3          ;-; vynulovanie volby poschodia na ktorom stojim
03D5 C22C            879            clr     PO3U            ;
03D7 C22B            880            clr     PO3D            ;
03D9 12078E          881            lcall   WRITEPORTS      ;
                     882           ;_BP_
VYTAH/ORI+DQ©4                                                                                              PAGE 17

03DC 79F0            883            mov     R1, #11110000b;-; Default predpokladam, ze mam namierene hore (na 3. a 4.) k
                                                                               abina
03DE 7AE0            884            mov     R2, #11100000b;-; Default predpokladam, ze mam namierene hore (na 3. a 4.) s
                                                                               achta
03E0 203A06          885            jb      UPOld, F3OK     ;   Je to pravda? Naozaj som doteraz isiel hore?
03E3 E9              886            mov     A, R1           ;       Ak nie, znegujeme masku kabiny
03E4 F4              887            cpl     A               ;       |
03E5 F9              888            mov     R1, A           ;       |
03E6 EA              889            mov     A, R2           ;       A znegujeme aj masku sachty
03E7 F4              890            cpl     A               ;       |
03E8 FA              891            mov     R2, A           ;       |        
03E9                 892    F3OK:   ; Pohyb v jednom smere (nevieme v ktorom)
03E9 E528            893            mov     A, INPORTA      ; zistenie, ci bolo stlacene nieco viac (menej) ako poschodi
                                                                               e na ktorom stojim (Kabina)
03EB 5416            894            anl     A, #00010110b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
03ED 59              895            anl     A, R1           ;  | 
03EE 7027            896            jnz     F3              ; nasli sme poschodie v tomto smere, mozme ist
                     897                                    ; zistenie, ci bolo stlacene nieco viac (menej) ako poschodi
                                                                               e na ktorom stojim (Sachta)
03F0 E528            898            mov     A, INPORTA      ; Mam v kabine nieco stlacene?
03F2 5416            899            anl     A, #00010110b   ;  | Beriem iba bity predstavujuce tlacidla poschodi (kabina
                                                                               )
03F4 7007            900            jnz     F3SW            ;  | Ak ano, idem rovno zistovat opacny smer.
03F6 E522            901            mov     A, INPORTC      ; Mam stlacene nieco v sachte (mojim smerom)?    
03F8 5427            902            anl     A, #00100111b   ;  | Beriem iba bity predstavujuce tlacidla privolavacov
03FA 5A              903            anl     A, R2           ;  |   
03FB 701A            904            jnz     F3              ; nasli sme poschodie v tomto smere, mozme ist
                     905            ; Pohyb v opacnom smere (nevieme v ktorom)
03FD B23A            906    F3SW:   cpl     UPOld           ;  Znegujem stary posun
03FF B23B            907            cpl     DOWNOld         ;  |
0401 E9              908            mov     A, R1           ;  Znegujeme masky
0402 F4              909            cpl     A               ;  |
0403 F9              910            mov     R1, A           ;  |
0404 EA              911            mov     A, R2           ;  |
0405 F4              912            cpl     A               ;  |
0406 FA              913            mov     R2, A           ;  |               
0407 E528            914            mov     A, INPORTA      ; zistenie, cibolo stlacene nieco viac ako poschodie na ktor
                                                                               om stojim (Kabina)
0409 5416            915            anl     A, #00010110b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
040B 59              916            anl     A, R1           ;  | 
040C 7009            917            jnz     F3              ; nasli sme poschodie v tomto smere, mozme ist
040E E522            918            mov     A, INPORTC      ; zistenie, cibolo stlacene nieco viac ako poschodie na ktor
                                                                               om stojim (Sachta)
0410 5427            919            anl     A, #00100111b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
0412 5A              920            anl     A, R2           ;  | 
0413 7002            921            jnz     F3              ; nasli sme poschodie v tomto smere, mozme ist
0415 80B9            922            jmp     F3S           ;-; nemame sa kde hybat, tak opakujeme zistovanie
0417 203A03          923    F3:     jb      UPOld, F3UP     ;   
041A 020429          924            jmp     F3DOWN          ;
041D D220            925    F3UP:   setb    UP              ; rychly pohyb hore
041F D222            926            setb    FAST            ; 
0421 C223            927            clr     SLOW            ;
0423 12078E          928            lcall   WRITEPORTS      ; 
0426 020435          929            jmp     UP3           ;-; prejdi do stavu UP2    
0429 D221            930    F3DOWN: setb    DOWN            ; rychly pohyb hore
042B D222            931            setb    FAST            ; 
042D C223            932            clr     SLOW            ;
042F 12078E          933            lcall   WRITEPORTS      ; 
VYTAH/ORIDQ©4                                                                                              PAGE 18

0432 0204C8          934            jmp     DOWN3         ;-; prejdi do stavu UP2    
                     935         
                     936         
0435                 937    UP3:
                     938 +1                 POLOHA_LED 3  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
0435 C22F            939 +1         clr     LEDU            
0437 C22E            940 +1         clr     LEDD 
0439 C224            941 +1         clr     FLED1             
043B C225            942 +1         clr     FLED2                
043D C226            943 +1         clr     FLED3           
043F C227            944 +1         clr     FLED4           
0441 D226            945 +1         setb    FLED3
0443 12078E          946 +1         lcall   WRITEPORTS
                     948 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
0446 120711          949 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0449 120740          950 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
044C 3009FA          951 +1         jnb     MB1, $-3  ; 
044F 120711          952 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0452 120740          954    UP3A:   lcall   READPORTS       ; nacitanie dat
                     955 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
0455 200B03          956 +1         jb      SKRH, $+6
0458 0206F6          957 +1         ljmp    ERR_SKRH
045B 00              958 +1         nop
                     960 +1         ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na z
                                                                               astavovaciu) <<<
045C 200903          961 +1         jb      MB1, $+6
045F 0206C9          962 +1         ljmp    ERR_2SPOM_C
0462 00              963 +1         nop
0463 200AEC          965            jb      MB2, UP3A     ;-; mame uz 1. spomalovaciu clonku?
                     966 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
0466 120711          967 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0469 120740          968 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
046C 300AFA          969 +1         jnb     MB2, $-3  ; 
046F 120711          970 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0472 D22E            972            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
0474 12078E          973            lcall   WRITEPORTS      ;
0477 02047A          974            jmp     UP3_MB2       ;-; a prejdi do stavu UP3_MB2
047A                 975    UP3_MB2:
047A 120740          976            lcall   READPORTS       ; nacitanie dat
                     977 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
047D 200B03          978 +1         jb      SKRH, $+6
0480 0206F6          979 +1         ljmp    ERR_SKRH
0483 00              980 +1         nop
                     982 +1         ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na zas
                                                                               tavovaciu) <<<
0484 200903          983 +1         jb      MB1, $+6
0487 0206BA          984 +1         ljmp    ERR_1SPOM_C
048A 00              985 +1         nop
048B 200AEC          987            jb      MB2, UP3_MB2  ;-; mame uz aj druhu spomalovaciu clonku?          
048E D22F            988            setb    LEDU            ; Rozsviet LEDku, ze mame druhu MB2
0490 12078E          989            lcall   WRITEPORTS      ;
                     990 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme 
0493 120711          991 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0496 120740          992 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0499 300AFA          993 +1         jnb     MB2, $-3  ; 
VYTAH/ORI lD¾S©4                                                                                              PAGE 19

049C 120711          994 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
049F E528            996            mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
04A1 5410            997            anl     A, #00010000b ;-;
04A3 600A            998            jz      UP3_MB1       ;-;       Ak nie, chod do stavu UP3_MB1
04A5 D223            999            setb    SLOW            ;       Ak ano, spomalme
04A7 C222           1000            clr     FAST            ; 
04A9 12078E         1001            lcall   WRITEPORTS      ;
04AC 0204AF         1002            jmp     UP3_MB1       ;-; a prejdi do stavu UP3_MB1 
04AF                1003    UP3_MB1:
04AF 120740         1004            lcall   READPORTS       ; nacitanie dat
04B2 300B05         1005            jnb     SKRH, U3_MB1C  ;  Sme na hornej porovnavacej clonke? (tu zastavujeme v kazdo
                                                                               m pripade)
04B5 300902         1006            jnb     MB1, U3_MB1C  ;-; Sme na zastavovacej clonke? (tu zastavujeme v kazdom pripa
                                                                               de)
04B8 80F5           1007            jmp     UP3_MB1         ; Ak sme nechytili ani jednu clonku, opakujeme. 
04BA C220           1008    U3_MB1C:clr     UP              ; zastav motor
04BC D23A           1009            setb    UPOld           ;       (a zalohuj)
04BE C23B           1010            clr     DOWNOld         ;       (a zalohuj)
04C0 C222           1011            clr     FAST            ; 
04C2 12078E         1012            lcall   WRITEPORTS      ; 
04C5 0205A5         1013            jmp     FLOOR4        ;-; a prejdi do stavu FLOOR4   
04C8                1014    DOWN3:
                    1015 +1                 POLOHA_LED 3  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
04C8 C22F           1016 +1         clr     LEDU            
04CA C22E           1017 +1         clr     LEDD 
04CC C224           1018 +1         clr     FLED1             
04CE C225           1019 +1         clr     FLED2                
04D0 C226           1020 +1         clr     FLED3           
04D2 C227           1021 +1         clr     FLED4           
04D4 D226           1022 +1         setb    FLED3
04D6 12078E         1023 +1         lcall   WRITEPORTS
                    1025 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
04D9 120711         1026 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
04DC 120740         1027 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
04DF 3009FA         1028 +1         jnb     MB1, $-3  ; 
04E2 120711         1029 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
04E5 120740         1031            lcall   READPORTS       ; nacitanie dat
                    1032 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
04E8 200C03         1033 +1         jb      SKRD, $+6
04EB 0206E7         1034 +1         ljmp    ERR_SKRD
04EE 00             1035 +1         nop
                    1037 +1         ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na z
                                                                               astavovaciu) <<<
04EF 200903         1038 +1         jb      MB1, $+6
04F2 0206C9         1039 +1         ljmp    ERR_2SPOM_C
04F5 00             1040 +1         nop
04F6 200ACF         1042            jb      MB2, DOWN3    ;-; mame uz 1. spomalovaciu clonku?
                    1043 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme   
04F9 120711         1044 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
04FC 120740         1045 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
04FF 300AFA         1046 +1         jnb     MB2, $-3  ; 
0502 120711         1047 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0505 D22F           1049            setb    LEDU            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
0507 12078E         1050            lcall   WRITEPORTS      ;
VYTAH/ORIZD^U©4                                                                                              PAGE 20

050A 02050D         1051            jmp     DOWN3_MB2     ;-; a prejdi do stavu DOWN3_MB2
050D                1052    DOWN3_MB2:
050D 120740         1053            lcall   READPORTS       ; nacitanie dat
                    1054 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
0510 200C03         1055 +1         jb      SKRD, $+6
0513 0206E7         1056 +1         ljmp    ERR_SKRD
0516 00             1057 +1         nop
                    1059 +1         ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na zas
                                                                               tavovaciu) <<<
0517 200903         1060 +1         jb      MB1, $+6
051A 0206BA         1061 +1         ljmp    ERR_1SPOM_C
051D 00             1062 +1         nop
051E 200AEC         1064            jb      MB2, DOWN3_MB2;-; mame uz aj druhu spomalovaciu clonku?          
0521 D22E           1065            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame druhu MB2
0523 12078E         1066            lcall   WRITEPORTS      ;
                    1067 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
0526 120711         1068 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0529 120740         1069 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
052C 300AFA         1070 +1         jnb     MB2, $-3  ; 
052F 120711         1071 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0532 E528           1073            mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
0534 5404           1074            anl     A, #00000100b ;-;
0536 600A           1075            jz      DOWN3_MB1     ;-;       Ak nie, chod do stavu DOWN3_MB1
0538 D223           1076            setb    SLOW            ;       Ak ano, spomalme
053A C222           1077            clr     FAST            ; 
053C 12078E         1078            lcall   WRITEPORTS      ;
053F 020542         1079            jmp     DOWN3_MB1     ;-; a prejdi do stavu DOWN3_MB1
0542                1080    DOWN3_MB1:    
0542 120740         1081            lcall   READPORTS       ; nacitanie dat
                    1082 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
0545 200C03         1083 +1         jb      SKRD, $+6
0548 0206E7         1084 +1         ljmp    ERR_SKRD
054B 00             1085 +1         nop
                    1087 +1         ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na spo
                                                                               malovaciu) <<<
054C 200A03         1088 +1         jb      MB2, $+6
054F 0206D8         1089 +1         ljmp    ERR_ZAST_C
0552 00             1090 +1         nop
0553 2009EC         1092            jb      MB1, DOWN3_MB1;-; Sme na zastavovacej clonke?
                    1093 +1         ZASTAV  2, D            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0)
                    1094 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
0556 C3             1095 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
0557 7400           1096 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
0559 7242           1097 +1         orl     C, PKI2          ; | Mam v tomto smere stlacene tlacidlo v kabine?
055B 7211           1098 +1         orl     C, PI2D      ; | Mam v tomto smere stlacene tlacidlo v sachte?
055D B00E           1099 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim) 
055F 720F           1100 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
                    1101 +1         ;mov     A, bmSmerPI1U
0561 3400           1102 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
0563 7033           1104            jnz     D3_MB1C         ; Ak ano, zastav
                    1105 +1         NAJNIZSIE               ; | ..a sme na najnizsom privolanom poschodi z kabiny? (poto
VYTAH/ORI 2D                                                                                                  PAGE 21

                                                                               m stojime urcite)
0565 E522           1106 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
0567 33             1107 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
0568 547E           1108 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
056A 7805           1109 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                    1110 +1  ; LL1: 
056C 6006           1111 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
056E C3             1112 +1         clr     C               ; Inak shiftnem o 2
056F 33             1113 +1         rlc     A               ;
0570 C3             1114 +1         clr     C               ;
0571 33             1115 +1         rlc     A               ;
0572 D8F8           1116 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                    1117 +1 ; LL2:
0574 E8             1118 +1         mov     A, R0           ; vysledne (najnizsie zvolene) poschodie je index v R0
                    1120 +1         LCJNE   A, #2, DOWN2    ; |   ak nie, nezastavujeme  
0575 B40203         1121 +1         cjne    A, #2, $+6
0578 02057E         1122 +1         jmp     $+6
057B 02032A         1123 +1         ljmp    DOWN2
057E 00             1124 +1         nop
                    1126 +1         NIZSIE_KABINA 2         ; | ..ok, sme na najnizsom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
057F 7405           1127 +1         mov     A, #5
0581 C3             1128 +1         clr     C
0582 9402           1129 +1         subb    A, #2
0584 F8             1130 +1         mov     R0, A
0585 E528           1131 +1         mov     A, INPORTA
0587 541E           1132 +1         anl     A, #00011110b
0589 C3             1133 +1         clr     C
058A 33             1134 +1         rlc     A
058B C3             1135 +1         clr     C
058C 33             1136 +1         rlc     A
058D C3             1137 +1         clr     C
058E 33             1138 +1         rlc     A
                    1139 +1 ;LL1   
058F C3             1140 +1         clr     C
0590 33             1141 +1         rlc     A
0591 D8FC           1142 +1         djnz    R0, $-2;LL1
0593 6003           1144            jz      D3_MB1C         ; |   ak neni zastavujem                  
0595 02032A         1145            ljmp    DOWN2         ;-; |        
0598 C221           1146    D3_MB1C:clr     DOWN            ; zastav motor
059A D23B           1147            setb    DOWNOld         ;       (a zalohuj)
059C C23A           1148            clr     UPOld           ;       (a zalohuj)
059E C222           1149            clr     FAST            ; 
05A0 12078E         1150            lcall   WRITEPORTS      ; 
05A3 21D8           1151            jmp     FLOOR2        ;-; a prejdi do stavu FLOOR2      
                    1152          
                    1153            
                    1154    ;------------------------------------------------------------------------------- << 4. posch
                                                                               odie >>
                    1155    
05A5                1156    FLOOR4:
                    1157 +1                 POLOHA_LED 4  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
VYTAH/ORIrD¨X©4                                                                                              PAGE 22

                                                                               ny", nechaj len aktualne poschodie)
05A5 C22F           1158 +1         clr     LEDU            
05A7 C22E           1159 +1         clr     LEDD 
05A9 C224           1160 +1         clr     FLED1             
05AB C225           1161 +1         clr     FLED2                
05AD C226           1162 +1         clr     FLED3           
05AF C227           1163 +1         clr     FLED4           
05B1 D227           1164 +1         setb    FLED4
05B3 12078E         1165 +1         lcall   WRITEPORTS
05B6 120727         1167            lcall   WAITFORTIMER    ; simulacia TIMERu
05B9 120740         1168    F4S:    lcall   READPORTS     ;-; nacitanie dat
05BC C21C           1169            clr     PKO4          ;-; vynulovanie volby poschodia na ktorom stojim
05BE C22D           1170            clr     PO4            ;
05C0 12078E         1171            lcall   WRITEPORTS      ;
05C3 E528           1172            mov     A, INPORTA      ; zistenie, ci bolo stlacene nieco menej ako poschodie na kt
                                                                               orom stojim (Kabina)
05C5 540E           1173            anl     A, #00001110b ;-;
05C7 7008           1174            jnz     F4OK          ;-; ak ano, ideme na to
05C9 E522           1175            mov     A, INPORTC      ; zistenie, ci bolo stlacene nieco menej ako poschodie na kt
                                                                               orom stojim (Sachta)
05CB 541F           1176            anl     A, #00011111b ;-;
05CD 7002           1177            jnz     F4OK          ;-; ak ano, ideme na to
05CF 80E8           1178            jmp     F4S             ; Nemam sa kde hnut, opakujem
05D1 D221           1179    F4OK:   setb    DOWN            ; rychly pohyb dole
05D3 D222           1180            setb    FAST            ;
05D5 C223           1181            clr     SLOW            ; 
05D7 12078E         1182            lcall   WRITEPORTS      ; 
05DA 0205DD         1183            jmp     DOWN4         ;-; prejdi do stavu DOWN4 
05DD                1184    DOWN4:
                    1185 +1                 POLOHA_LED 4  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
05DD C22F           1186 +1         clr     LEDU            
05DF C22E           1187 +1         clr     LEDD 
05E1 C224           1188 +1         clr     FLED1             
05E3 C225           1189 +1         clr     FLED2                
05E5 C226           1190 +1         clr     FLED3           
05E7 C227           1191 +1         clr     FLED4           
05E9 D227           1192 +1         setb    FLED4
05EB 12078E         1193 +1         lcall   WRITEPORTS
                    1195 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
05EE 120711         1196 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
05F1 120740         1197 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
05F4 3009FA         1198 +1         jnb     MB1, $-3  ; 
05F7 120711         1199 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
05FA 120740         1201            lcall   READPORTS       ; nacitanie dat
                    1202 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
05FD 200C03         1203 +1         jb      SKRD, $+6
0600 0206E7         1204 +1         ljmp    ERR_SKRD
0603 00             1205 +1         nop
                    1207 +1         ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na z
                                                                               astavovaciu) <<<
0604 200903         1208 +1         jb      MB1, $+6
0607 0206C9         1209 +1         ljmp    ERR_2SPOM_C
060A 00             1210 +1         nop
060B 200ACF         1212            jb      MB2, DOWN4    ;-; mame uz 1. spomalovaciu clonku?
                    1213 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme      
060E 120711         1214 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
VYTAH/ORI aDFZ©4                                                                                              PAGE 23

0611 120740         1215 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0614 300AFA         1216 +1         jnb     MB2, $-3  ; 
0617 120711         1217 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
061A D22F           1219            setb    LEDU            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
061C 12078E         1220            lcall   WRITEPORTS      ;
061F 020622         1221            jmp     DOWN4_MB2     ;-; a prejdi do stavu DOWN4_MB2
0622                1222    DOWN4_MB2:
0622 120740         1223            lcall   READPORTS       ; nacitanie dat
                    1224 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
0625 200C03         1225 +1         jb      SKRD, $+6
0628 0206E7         1226 +1         ljmp    ERR_SKRD
062B 00             1227 +1         nop
                    1229 +1         ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na zas
                                                                               tavovaciu) <<<
062C 200903         1230 +1         jb      MB1, $+6
062F 0206BA         1231 +1         ljmp    ERR_1SPOM_C
0632 00             1232 +1         nop
0633 200AEC         1234            jb      MB2, DOWN4_MB2;-; mame uz aj druhu spomalovaciu clonku?          
0636 D22E           1235            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame druhu MB2
0638 12078E         1236            lcall   WRITEPORTS      ;
                    1237 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
063B 120711         1238 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
063E 120740         1239 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0641 300AFA         1240 +1         jnb     MB2, $-3  ; 
0644 120711         1241 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0647 E528           1243            mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
0649 5408           1244            anl     A, #00001000b ;-;
064B 600A           1245            jz      DOWN4_MB1     ;-;       Ak nie, chod do stavu DOWN4_MB1
064D D223           1246            setb    SLOW            ;       Ak ano, spomalme
064F C222           1247            clr     FAST            ; 
0651 12078E         1248            lcall   WRITEPORTS      ;
0654 020657         1249            jmp     DOWN4_MB1     ;-; a prejdi do stavu DOWN4_MB1
0657                1250    DOWN4_MB1:    
0657 120740         1251            lcall   READPORTS       ; nacitanie dat
                    1252 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
065A 200C03         1253 +1         jb      SKRD, $+6
065D 0206E7         1254 +1         ljmp    ERR_SKRD
0660 00             1255 +1         nop
                    1257 +1         ljnb    MB2, ERR_ZAST_C; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na spom
                                                                               alovaciu) <<<
0661 200A03         1258 +1         jb      MB2, $+6
0664 0206D8         1259 +1         ljmp    ERR_ZAST_C
0667 00             1260 +1         nop
0668 2009EC         1262            jb      MB1, DOWN4_MB1 ;-; Sme na zastavovacej clonke?
                    1263 +1         ZASTAV  3, D            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0) 
                    1264 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
066B C3             1265 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
066C 7400           1266 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
066E 7243           1267 +1         orl     C, PKI3          ; | Mam v tomto smere stlacene tlacidlo v kabine?
0670 7213           1268 +1         orl     C, PI3D      ; | Mam v tomto smere stlacene tlacidlo v sachte?
0672 B00E           1269 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim) 
0674 720F           1270 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
VYTAH/ORICDR\©4V\©4                                                                                          PAGE 24

                    1271 +1         ;mov     A, bmSmerPI1U
0676 3400           1272 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
0678 7033           1274            jnz     D4_MB1C       ;-; Ak ano, zastav
                    1275 +1         NAJNIZSIE               ; | ..a sme na najnizsom privolanom poschodi z kabiny? (poto
                                                                               m stojime urcite)
067A E522           1276 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
067C 33             1277 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
067D 547E           1278 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
067F 7805           1279 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                    1280 +1  ; LL1: 
0681 6006           1281 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
0683 C3             1282 +1         clr     C               ; Inak shiftnem o 2
0684 33             1283 +1         rlc     A               ;
0685 C3             1284 +1         clr     C               ;
0686 33             1285 +1         rlc     A               ;
0687 D8F8           1286 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                    1287 +1 ; LL2:
0689 E8             1288 +1         mov     A, R0           ; vysledne (najnizsie zvolene) poschodie je index v R0
                    1290 +1         LCJNE   A, #3, DOWN3    ; |   ak nie, nezastavujeme  
068A B40303         1291 +1         cjne    A, #3, $+6
068D 020693         1292 +1         jmp     $+6
0690 0204C8         1293 +1         ljmp    DOWN3
0693 00             1294 +1         nop
                    1296 +1         NIZSIE_KABINA 3         ; | ..ok, sme na najnizsom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
0694 7405           1297 +1         mov     A, #5
0696 C3             1298 +1         clr     C
0697 9403           1299 +1         subb    A, #3
0699 F8             1300 +1         mov     R0, A
069A E528           1301 +1         mov     A, INPORTA
069C 541E           1302 +1         anl     A, #00011110b
069E C3             1303 +1         clr     C
069F 33             1304 +1         rlc     A
06A0 C3             1305 +1         clr     C
06A1 33             1306 +1         rlc     A
06A2 C3             1307 +1         clr     C
06A3 33             1308 +1         rlc     A
                    1309 +1 ;LL1   
06A4 C3             1310 +1         clr     C
06A5 33             1311 +1         rlc     A
06A6 D8FC           1312 +1         djnz    R0, $-2;LL1
06A8 6003           1314            jz      D4_MB1C         ; |   ak neni zastavujem          
06AA 0204C8         1315            ljmp    DOWN3         ;-; |       
06AD C221           1316    D4_MB1C:clr     DOWN            ; zastav motor
06AF D23B           1317            setb    DOWNOld         ;       (a zalohuj)
06B1 C23A           1318            clr     UPOld           ;       (a zalohuj)
06B3 C222           1319            clr     FAST            ; 
06B5 12078E         1320            lcall   WRITEPORTS      ; 
06B8 61BC           1321            jmp     FLOOR3        ;-; a prejdi do stavu FLOOR3                 
                    1322                    
VYTAH/ORIDD]©4                                                                                              PAGE 25

                    1323      
06BA                1324    ERR_1SPOM_C: 
06BA C220           1325            clr     UP              ; zastav motor
06BC C221           1326            clr     DOWN            ; 
06BE 12078E         1327            lcall   WRITEPORTS      ; 
                    1328 +1         _BP_
06C1 C2B3           1329 +1         clr     P3.3
06C3 D2AA           1330 +1         setb    EX1
06C5 00             1331 +1         nop
06C6 00             1332 +1         nop
06C7 00             1334            nop
06C8 00             1335            nop 
                    1336            
06C9                1337    ERR_2SPOM_C: 
06C9 C220           1338            clr     UP              ; zastav motor
06CB C221           1339            clr     DOWN            ; 
06CD 12078E         1340            lcall   WRITEPORTS      ; 
                    1341 +1         _BP_
06D0 C2B3           1342 +1         clr     P3.3
06D2 D2AA           1343 +1         setb    EX1
06D4 00             1344 +1         nop
06D5 00             1345 +1         nop
06D6 00             1347            nop
06D7 00             1348            nop 
                    1349            
06D8                1350    ERR_ZAST_C: 
06D8 C220           1351            clr     UP              ; zastav motor
06DA C221           1352            clr     DOWN            ; 
06DC 12078E         1353            lcall   WRITEPORTS      ; 
                    1354 +1         _BP_
06DF C2B3           1355 +1         clr     P3.3
06E1 D2AA           1356 +1         setb    EX1
06E3 00             1357 +1         nop
06E4 00             1358 +1         nop
06E5 00             1360            nop
06E6 00             1361            nop 
                    1362            
06E7                1363    ERR_SKRD: 
06E7 C220           1364            clr     UP              ; zastav motor
06E9 C221           1365            clr     DOWN            ; 
06EB 12078E         1366            lcall   WRITEPORTS      ; 
                    1367 +1         _BP_
06EE C2B3           1368 +1         clr     P3.3
06F0 D2AA           1369 +1         setb    EX1
06F2 00             1370 +1         nop
06F3 00             1371 +1         nop
06F4 00             1373            nop
06F5 00             1374            nop    
                    1375            
06F6                1376    ERR_SKRH: 
06F6 C220           1377            clr     UP              ; zastav motor
06F8 C221           1378            clr     DOWN            ; 
06FA 12078E         1379            lcall   WRITEPORTS      ; 
                    1380 +1         _BP_
06FD C2B3           1381 +1         clr     P3.3
06FF D2AA           1382 +1         setb    EX1
0701 00             1383 +1         nop
0702 00             1384 +1         nop
VYTAH/ORIQD                                                                                                  PAGE 26

0703 00             1386            nop
0704 00             1387            nop             
                    1388                    
                    1389                    
0705                1390    ENDPROG:
0705 D218           1391            setb    KS
0707 12078E         1392            call    WRITEPORTS                ; zapis novu informaciu
                    1393 +1         _BP_
070A C2B3           1394 +1         clr     P3.3
070C D2AA           1395 +1         setb    EX1
070E 00             1396 +1         nop
070F 00             1397 +1         nop
0710 22             1399            ret
                    1400            
                    1401    ; rutina time delay 1 ms pre oscilator s frekvenciou 11.0592 MHz
                    1402    ; 1 instrukcia 2 takty? => 11.0592/2 = pocet instrukcii potrebnych na 1 sekundu
                    1403    ; 11.0592MHz/2000 = zdrzanie 1 ms
0711                1404    TIME10MS:
0711 7963           1405            mov     R1,#063h        ; 2
                    1406                                    ; *** 100x
0713 7AFF           1407    TIME0:  mov     R2,#0FFh        ; 2 
0715 DAFE           1408    TIME1:  djnz    R2,TIME1        ; 256*2   
0717 7AFF           1409            mov     R2,#0FFh        ; 2       
0719 DAFE           1410    TIME2:  djnz    R2,TIME2        ; 256*2 
071B 7A24           1411            mov     R2,#024h        ; 2       
071D DAFE           1412    TIME3:  djnz    R2,TIME3        ; 36*2
071F 00             1413            nop                     ; 1
0720 D9F1           1414            djnz    R1,TIME0        ; 2
                    1415                                    ; ***
0722 792A           1416            mov     R1,#02Ah        ; 2 
0724 D9FE           1417    TIME4:  djnz    R1,TIME4        ; 43*2  
0726 22             1418            ret                     ; koniec
                    1419            
                    1420            
                    1421    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    1422    ; DELAY
                    1423    ; Pocka na stlacenie tlacidla na 1. poschodi  - signal PO1 (v buducnosti to 
                    1424    ; bude timer)
                    1425    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0727                1426    WAITFORTIMER:
0727 7B10           1427            mov     R3, #10h
0729 120711         1428    DEL1:   lcall   TIME10MS
072C DBFB           1429            djnz    R3, DEL1
072E 22             1430            ret
                    1431    
                    1432    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    1433    ; WAITFORTIMER
                    1434    ; Pocka na stlacenie tlacidla na 1. poschodi  - signal PO1 (v buducnosti to 
                    1435    ; bude timer)
                    1436    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
072F                1437    WAITFORTIMER2:
072F D22C           1438            setb    PO3U                        ; rozsvieti indikator cakania (poschodie 4)
0731 12078E         1439            lcall   WRITEPORTS                  ;
0734 120740         1440    WAIT:   lcall   READPORTS                   ; 
0737 3013ED         1441            jnb     PI3D, WAITFORTIMER          ; ak nebolo stlacene tlacidlo PO1, cakaj 
073A C22C           1442            clr     PO3U                         ; zhasne indikator cakania (poschodie 4)
073C 12078E         1443            lcall   WRITEPORTS
073F 22             1444            ret
VYTAH/ORI                                                                                                     PAGE 27

                    1445    
                    1446    
                    1447    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    1448    ; READPORTS
                    1449    ; precita nove hodnoty na portoch
                    1450    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0740                1451    READPORTS:
0740 75A080         1452            mov     p2, #i8255INA       ; citaj data z portu A
0743 75803F         1453            mov     p0, #(bmSTOP or bmPKI1 or bmPKI2 or bmPKI3 or bmPKI4 or bmDOORCLSD)
0746 C2B7           1454            clr     RDNOT
0748 00             1455            nop
0749 00             1456            nop
074A 00             1457            nop
074B 00             1458            nop
074C 858028         1459            mov     INPORTA, p0         ; uloz informaciu z datovej zbernice 
074F D2B7           1460            setb    RDNOT
                    1461            
0751 75A081         1462            mov     p2, #i8255INB       ; citaj data z portu B
0754 7580FE         1463            mov     p0, #(bmMB1I or bmMB2I or bmSKRHI or bmSKRHD or bmDPI or bmDPKI or bmDPZKI)
                                                                               
0757 C2B7           1464            clr     RDNOT
0759 00             1465            nop
075A 00             1466            nop
075B 00             1467            nop
075C 00             1468            nop
075D 858021         1469            mov     INPORTB, p0         ; uloz informaciu z datovej zbernice 
0760 D2B7           1470            setb    RDNOT
                    1471    
0762 75A082         1472            mov     p2, #i8255INC       ; citaj data z portu C
0765 75803F         1473            mov     p0, #(bmPI1 or bmPI2D or bmPI2U or bmPI3D or bmPI3U or bmPI4)
0768 C2B7           1474            clr     RDNOT
076A 00             1475            nop
076B 00             1476            nop
076C 00             1477            nop
076D 00             1478            nop
076E 858022         1479            mov     INPORTC, p0         ; uloz informaciu z datovej zbernice 
0771 D2B7           1480            setb    RDNOT
0773 00             1481            nop
0774 00             1482            nop
0775 00             1483            nop
0776 00             1484            nop
0777 00             1485            nop
0778 00             1486            nop
0779 00             1487            nop
077A 00             1488            nop
077B E528           1489            mov     A, INPORTA
077D 541E           1490            anl     A, #00011110b
077F 4223           1491            orl     OUTPORTA, A
0781 12078E         1492            call    WRITEPORTS              ; aktualizuj signalizaciu na ovladacom paneli
0784 E522           1493            mov     A, INPORTC
0786 543F           1494            anl     A, #00111111b
0788 4225           1495            orl     OUTPORTC, A
078A 12078E         1496            call    WRITEPORTS              ; aktualizuj signalizaciu na ovladacom paneli
                    1497            
078D 22             1498            ret
                    1499            
                    1500    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    1501    ; WRITEPORTS
VYTAH/ORI                                                                                                     PAGE 28

                    1502    ; spravi zalohu vystupnych registrov a posle data von
                    1503    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
078E                1504    WRITEPORTS:
078E 852380         1505            mov     p0, OUTPORTA        ; teraz postupne posli data najprv na port A,
0791 75A0C0         1506            mov     p2, #i8255OUTA
0794 C2B6           1507            clr     WRNOT
0796 00             1508            nop
0797 00             1509            nop
0798 00             1510            nop
0799 00             1511            nop
079A D2B6           1512            setb    WRNOT
                    1513            
079C 852480         1514            mov     p0, OUTPORTB        ; potom port B
079F 75A0C1         1515            mov     p2, #i8255OUTB
07A2 C2B6           1516            clr     WRNOT
07A4 00             1517            nop
07A5 00             1518            nop
07A6 00             1519            nop
07A7 00             1520            nop
07A8 D2B6           1521            setb    WRNOT
                    1522    
07AA 852580         1523            mov     p0, OUTPORTC        ; a nakoniec port C
07AD 75A0C2         1524            mov     p2, #i8255OUTC
07B0 C2B6           1525            clr     WRNOT
07B2 00             1526            nop
07B3 00             1527            nop
07B4 00             1528            nop
07B5 00             1529            nop
07B6 D2B6           1530            setb    WRNOT
07B8 00             1531            nop
07B9 00             1532            nop
07BA 00             1533            nop
07BB 00             1534            nop
07BC 00             1535            nop
07BD 00             1536            nop
07BE 00             1537            nop
07BF 00             1538            nop
07C0 22             1539            ret
                    1540    
                    1541    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    1542    
07C1 0D0A5269       1543    STR_INIT:   db  0dh, 0ah, 'Riadiaci system je inicializovany.', 0dh, 0ah, 00h
07C5 61646961   
07C9 63692073   
07CD 79737465   
07D1 6D206A65   
07D5 20696E69   
07D9 6369616C   
07DD 697A6F76   
07E1 616E792E   
07E5 0D0A00     
07E8 52696164       1544    STR_STOP:   db  'Riadiaci system je reinicializovany po stlaceni tlacidla STOP.', 0dh, 0ah, 
                                                                               00h
07EC 69616369   
07F0 20737973   
07F4 74656D20   
07F8 6A652072   
07FC 65696E69   
VYTAH/ORICD                                                                                                  PAGE 29

0800 6369616C   
0804 697A6F76   
0808 616E7920   
080C 706F2073   
0810 746C6163   
0814 656E6920   
0818 746C6163   
081C 69646C61   
0820 2053544F   
0824 502E0D0A   
0828 00         
0829 4B616C69       1545    STR_CALIB:  db  'Kalibracia vytahu je ukoncena.', 0dh, 0ah, 00h
082D 62726163   
0831 69612076   
0835 79746168   
0839 75206A65   
083D 20756B6F   
0841 6E63656E   
0845 612E0D0A   
0849 00         
                    1546    
----                1547            DSEG
0040                1548            org     40h
0040                1549    STACK:  DS      10h
                    1550    
                    1551    end

VERSION 1.2h ASSEMBLY COMPLETE, 0 ERRORS FOUND
VYTAH/ORI                                                                                                     PAGE 30

BMDOORCLSD . . . . . . . . . . .    NUMB  0020H  
BMDOWN . . . . . . . . . . . . .    NUMB  0002H  NOT USED  
BMDPI. . . . . . . . . . . . . .    NUMB  0020H  
BMDPKI . . . . . . . . . . . . .    NUMB  0080H  
BMDPZKI. . . . . . . . . . . . .    NUMB  0040H  
BMFAST . . . . . . . . . . . . .    NUMB  0004H  NOT USED  
BMFLED1. . . . . . . . . . . . .    NUMB  0010H  
BMFLED2. . . . . . . . . . . . .    NUMB  0020H  
BMFLED3. . . . . . . . . . . . .    NUMB  0040H  
BMFLED4. . . . . . . . . . . . .    NUMB  0080H  
BMKS . . . . . . . . . . . . . .    NUMB  0001H  NOT USED  
BMLEDD . . . . . . . . . . . . .    NUMB  0040H  
BMLEDU . . . . . . . . . . . . .    NUMB  0080H  
BMMB1I . . . . . . . . . . . . .    NUMB  0002H  
BMMB2I . . . . . . . . . . . . .    NUMB  0004H  
BMPI1. . . . . . . . . . . . . .    NUMB  0001H  
BMPI2D . . . . . . . . . . . . .    NUMB  0002H  
BMPI2U . . . . . . . . . . . . .    NUMB  0004H  
BMPI3D . . . . . . . . . . . . .    NUMB  0008H  
BMPI3U . . . . . . . . . . . . .    NUMB  0010H  
BMPI4. . . . . . . . . . . . . .    NUMB  0020H  
BMPKI1 . . . . . . . . . . . . .    NUMB  0002H  
BMPKI2 . . . . . . . . . . . . .    NUMB  0004H  
BMPKI3 . . . . . . . . . . . . .    NUMB  0008H  
BMPKI4 . . . . . . . . . . . . .    NUMB  0010H  
BMPKO1 . . . . . . . . . . . . .    NUMB  0002H  
BMPKO2 . . . . . . . . . . . . .    NUMB  0004H  
BMPKO3 . . . . . . . . . . . . .    NUMB  0008H  
BMPKO4 . . . . . . . . . . . . .    NUMB  0010H  
BMPO1. . . . . . . . . . . . . .    NUMB  0001H  
BMPO2D . . . . . . . . . . . . .    NUMB  0002H  
BMPO2U . . . . . . . . . . . . .    NUMB  0004H  
BMPO3D . . . . . . . . . . . . .    NUMB  0008H  
BMPO3U . . . . . . . . . . . . .    NUMB  0010H  
BMPO4. . . . . . . . . . . . . .    NUMB  0020H  
BMSKRHD. . . . . . . . . . . . .    NUMB  0010H  
BMSKRHI. . . . . . . . . . . . .    NUMB  0008H  
BMSLOW . . . . . . . . . . . . .    NUMB  0008H  NOT USED  
BMSTOP . . . . . . . . . . . . .    NUMB  0001H  
BMUP . . . . . . . . . . . . . .    NUMB  0001H  NOT USED  
CALIB. . . . . . . . . . . . . .  C ADDR  0096H  NOT USED  
CALIBEND . . . . . . . . . . . .  C ADDR  00ADH  
CALIBEND2. . . . . . . . . . . .  C ADDR  00B8H  
CALIBLOOP. . . . . . . . . . . .  C ADDR  00A5H  
CANGO. . . . . . . . . . . . . .  B ADDR  0038H  NOT USED  
CTRLREG. . . . . . . . . . . . .  D ADDR  0027H  
D2_MB1C. . . . . . . . . . . . .  C ADDR  03AFH  
D3_MB1C. . . . . . . . . . . . .  C ADDR  0598H  
D4_MB1C. . . . . . . . . . . . .  C ADDR  06ADH  
DEL1 . . . . . . . . . . . . . .  C ADDR  0729H  
DOORCLSD . . . . . . . . . . . .  B ADDR  0045H  NOT USED  
DOORCLSDOLD. . . . . . . . . . .  B ADDR  0039H  NOT USED  
DOWN . . . . . . . . . . . . . .  B ADDR  0021H  
DOWN2. . . . . . . . . . . . . .  C ADDR  032AH  
DOWN2_MB1. . . . . . . . . . . .  C ADDR  03A4H  
DOWN2_MB2. . . . . . . . . . . .  C ADDR  036FH  
DOWN3. . . . . . . . . . . . . .  C ADDR  04C8H  
DOWN3_MB1. . . . . . . . . . . .  C ADDR  0542H  
VYTAH/ORI                                                                                                     PAGE 31

DOWN3_MB2. . . . . . . . . . . .  C ADDR  050DH  
DOWN4. . . . . . . . . . . . . .  C ADDR  05DDH  
DOWN4_MB1. . . . . . . . . . . .  C ADDR  0657H  
DOWN4_MB2. . . . . . . . . . . .  C ADDR  0622H  
DOWNOLD. . . . . . . . . . . . .  B ADDR  003BH  
DP . . . . . . . . . . . . . . .  B ADDR  000DH  NOT USED  
DPK. . . . . . . . . . . . . . .  B ADDR  000FH  
DPZK . . . . . . . . . . . . . .  B ADDR  000EH  
ENDPROG. . . . . . . . . . . . .  C ADDR  0705H  NOT USED  
ERR_1SPOM_C. . . . . . . . . . .  C ADDR  06BAH  
ERR_2SPOM_C. . . . . . . . . . .  C ADDR  06C9H  
ERR_SKRD . . . . . . . . . . . .  C ADDR  06E7H  
ERR_SKRH . . . . . . . . . . . .  C ADDR  06F6H  
ERR_ZAST_C . . . . . . . . . . .  C ADDR  06D8H  
EX1. . . . . . . . . . . . . . .  B ADDR  00AAH  PREDEFINED  
F1OK . . . . . . . . . . . . . .  C ADDR  00F3H  
F1S. . . . . . . . . . . . . . .  C ADDR  00DBH  
F2 . . . . . . . . . . . . . . .  C ADDR  0233H  
F2DOWN . . . . . . . . . . . . .  C ADDR  0245H  
F2OK . . . . . . . . . . . . . .  C ADDR  0205H  
F2S. . . . . . . . . . . . . . .  C ADDR  01ECH  
F2SW . . . . . . . . . . . . . .  C ADDR  0219H  
F2UP . . . . . . . . . . . . . .  C ADDR  0239H  
F3 . . . . . . . . . . . . . . .  C ADDR  0417H  
F3DOWN . . . . . . . . . . . . .  C ADDR  0429H  
F3OK . . . . . . . . . . . . . .  C ADDR  03E9H  
F3S. . . . . . . . . . . . . . .  C ADDR  03D0H  
F3SW . . . . . . . . . . . . . .  C ADDR  03FDH  
F3UP . . . . . . . . . . . . . .  C ADDR  041DH  
F4OK . . . . . . . . . . . . . .  C ADDR  05D1H  
F4S. . . . . . . . . . . . . . .  C ADDR  05B9H  
FAST . . . . . . . . . . . . . .  B ADDR  0022H  
FASTOLD. . . . . . . . . . . . .  B ADDR  003CH  NOT USED  
FLED1. . . . . . . . . . . . . .  B ADDR  0024H  
FLED2. . . . . . . . . . . . . .  B ADDR  0025H  
FLED3. . . . . . . . . . . . . .  B ADDR  0026H  
FLED4. . . . . . . . . . . . . .  B ADDR  0027H  
FLOOR1 . . . . . . . . . . . . .  C ADDR  00C7H  
FLOOR2 . . . . . . . . . . . . .  C ADDR  01D8H  
FLOOR3 . . . . . . . . . . . . .  C ADDR  03BCH  
FLOOR4 . . . . . . . . . . . . .  C ADDR  05A5H  
FLOORREQ . . . . . . . . . . . .  D ADDR  0036H  NOT USED  
HIGHEST. . . . . . . . . . . . .  D ADDR  0032H  NOT USED  
I8255INA . . . . . . . . . . . .    NUMB  0080H  
I8255INB . . . . . . . . . . . .    NUMB  0081H  
I8255INC . . . . . . . . . . . .    NUMB  0082H  
I8255INCW. . . . . . . . . . . .    NUMB  0083H  
I8255OUTA. . . . . . . . . . . .    NUMB  00C0H  
I8255OUTB. . . . . . . . . . . .    NUMB  00C1H  
I8255OUTC. . . . . . . . . . . .    NUMB  00C2H  
I8255OUTCW . . . . . . . . . . .    NUMB  00C3H  
INPORTA. . . . . . . . . . . . .  D ADDR  0028H  
INPORTB. . . . . . . . . . . . .  D ADDR  0021H  
INPORTBOLD . . . . . . . . . . .  D ADDR  0026H  
INPORTC. . . . . . . . . . . . .  D ADDR  0022H  
KS . . . . . . . . . . . . . . .  B ADDR  0018H  
LEDD . . . . . . . . . . . . . .  B ADDR  002EH  
LEDU . . . . . . . . . . . . . .  B ADDR  002FH  
VYTAH/ORI                                                                                                     PAGE 32

LOWEST . . . . . . . . . . . . .  D ADDR  0031H  NOT USED  
MAIN . . . . . . . . . . . . . .  C ADDR  00C7H  NOT USED  
MB1. . . . . . . . . . . . . . .  B ADDR  0009H  
MB1OLD . . . . . . . . . . . . .  B ADDR  0031H  NOT USED  
MB2. . . . . . . . . . . . . . .  B ADDR  000AH  
MB2OLD . . . . . . . . . . . . .  B ADDR  0032H  NOT USED  
OUTPORTA . . . . . . . . . . . .  D ADDR  0023H  
OUTPORTB . . . . . . . . . . . .  D ADDR  0024H  
OUTPORTBOLD. . . . . . . . . . .  D ADDR  0034H  NOT USED  
OUTPORTC . . . . . . . . . . . .  D ADDR  0025H  
P0 . . . . . . . . . . . . . . .  D ADDR  0080H  PREDEFINED  
P2 . . . . . . . . . . . . . . .  D ADDR  00A0H  PREDEFINED  
P3 . . . . . . . . . . . . . . .  D ADDR  00B0H  PREDEFINED  
PI1. . . . . . . . . . . . . . .  B ADDR  0010H  NOT USED  
PI2D . . . . . . . . . . . . . .  B ADDR  0011H  
PI2U . . . . . . . . . . . . . .  B ADDR  0012H  
PI3D . . . . . . . . . . . . . .  B ADDR  0013H  
PI3U . . . . . . . . . . . . . .  B ADDR  0014H  
PI4. . . . . . . . . . . . . . .  B ADDR  0015H  NOT USED  
PKI1 . . . . . . . . . . . . . .  B ADDR  0041H  NOT USED  
PKI2 . . . . . . . . . . . . . .  B ADDR  0042H  
PKI3 . . . . . . . . . . . . . .  B ADDR  0043H  
PKI4 . . . . . . . . . . . . . .  B ADDR  0044H  NOT USED  
PKO1 . . . . . . . . . . . . . .  B ADDR  0019H  
PKO2 . . . . . . . . . . . . . .  B ADDR  001AH  
PKO3 . . . . . . . . . . . . . .  B ADDR  001BH  
PKO4 . . . . . . . . . . . . . .  B ADDR  001CH  
PO1. . . . . . . . . . . . . . .  B ADDR  0028H  
PO2D . . . . . . . . . . . . . .  B ADDR  0029H  
PO2U . . . . . . . . . . . . . .  B ADDR  002AH  
PO3D . . . . . . . . . . . . . .  B ADDR  002BH  
PO3U . . . . . . . . . . . . . .  B ADDR  002CH  
PO4. . . . . . . . . . . . . . .  B ADDR  002DH  
POSITION . . . . . . . . . . . .  D ADDR  0030H  NOT USED  
RDNOT. . . . . . . . . . . . . .  B ADDR  00B7H  
READPORTS. . . . . . . . . . . .  C ADDR  0740H  
RESET. . . . . . . . . . . . . .  C ADDR  0033H  NOT USED  
SKRD . . . . . . . . . . . . . .  B ADDR  000CH  
SKRDOLD. . . . . . . . . . . . .  B ADDR  0034H  NOT USED  
SKRH . . . . . . . . . . . . . .  B ADDR  000BH  
SKRHOLD. . . . . . . . . . . . .  B ADDR  0033H  NOT USED  
SLOW . . . . . . . . . . . . . .  B ADDR  0023H  
SLOWOLD. . . . . . . . . . . . .  B ADDR  003DH  NOT USED  
SP . . . . . . . . . . . . . . .  D ADDR  0081H  PREDEFINED  
STACK. . . . . . . . . . . . . .  D ADDR  0040H  
START. . . . . . . . . . . . . .  C ADDR  0033H  
STOPNOT. . . . . . . . . . . . .  B ADDR  0040H  NOT USED  
STOPTIMER. . . . . . . . . . . .  D ADDR  0033H  
STR_CALIB. . . . . . . . . . . .  C ADDR  0829H  NOT USED  
STR_INIT . . . . . . . . . . . .  C ADDR  07C1H  NOT USED  
STR_STOP . . . . . . . . . . . .  C ADDR  07E8H  NOT USED  
TIME0. . . . . . . . . . . . . .  C ADDR  0713H  
TIME1. . . . . . . . . . . . . .  C ADDR  0715H  
TIME10MS . . . . . . . . . . . .  C ADDR  0711H  
TIME2. . . . . . . . . . . . . .  C ADDR  0719H  
TIME3. . . . . . . . . . . . . .  C ADDR  071DH  
TIME4. . . . . . . . . . . . . .  C ADDR  0724H  
TIMERCONST . . . . . . . . . . .    NUMB  00FAH  NOT USED  
VYTAH/ORI                                                                                                     PAGE 33

U1_MB1C. . . . . . . . . . . . .  C ADDR  01CAH  
U2_MB1C. . . . . . . . . . . . .  C ADDR  031CH  
U3_MB1C. . . . . . . . . . . . .  C ADDR  04BAH  
UP . . . . . . . . . . . . . . .  B ADDR  0020H  
UP1. . . . . . . . . . . . . . .  C ADDR  00FFH  
UP1A . . . . . . . . . . . . . .  C ADDR  011CH  
UP1_MB1. . . . . . . . . . . . .  C ADDR  0179H  
UP1_MB2. . . . . . . . . . . . .  C ADDR  0144H  
UP2. . . . . . . . . . . . . . .  C ADDR  0251H  
UP2A . . . . . . . . . . . . . .  C ADDR  026EH  
UP2_MB1. . . . . . . . . . . . .  C ADDR  02CBH  
UP2_MB2. . . . . . . . . . . . .  C ADDR  0296H  
UP3. . . . . . . . . . . . . . .  C ADDR  0435H  
UP3A . . . . . . . . . . . . . .  C ADDR  0452H  
UP3_MB1. . . . . . . . . . . . .  C ADDR  04AFH  
UP3_MB2. . . . . . . . . . . . .  C ADDR  047AH  
UPOLD. . . . . . . . . . . . . .  B ADDR  003AH  
WAIT . . . . . . . . . . . . . .  C ADDR  0734H  NOT USED  
WAITFORTIMER . . . . . . . . . .  C ADDR  0727H  
WAITFORTIMER2. . . . . . . . . .  C ADDR  072FH  NOT USED  
WRITEPORTS . . . . . . . . . . .  C ADDR  078EH  
WRNOT. . . . . . . . . . . . . .  B ADDR  00B6H  
