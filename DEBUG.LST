VYTAH/ORI                                                                                                     PAGE 1

                       1    ; TODO: 
                       2    ; OK - Dorob nulovanie volieb v sachte 
                       3    ; Dorob 3UP a 2 DOWN (tam kde stojis vzdy)
                       4    ; Asi by bolo dobre premenovat PI1, PO1 a PI4 PO4 na alternativy s koncovkami U a D
                       5    ; Poriadne otestuj !!! 
                       6    ; Umo+zni stlacat tlacidla aj ked bezi delay
                       7    
                       8    
                       9    $MOD51
                      10    $DEBUG
                      11    
                =1    12    $include (lift.inc)
                =1    13    ; adresy I/O portov, ktore pridu na port P2 89C52-ky
  0080          =1    14    i8255INA        equ     080h
  0081          =1    15    i8255INB        equ     081h
  0082          =1    16    i8255INC        equ     082h
  0083          =1    17    i8255INCW       equ     083h
  00C0          =1    18    i8255OUTA       equ     0c0h
  00C1          =1    19    i8255OUTB       equ     0c1h
  00C2          =1    20    i8255OUTC       equ     0c2h
  00C3          =1    21    i8255OUTCW      equ     0c3h
                =1    22    
  0028          =1    23    INPORTA         data    28h         ; nutne kvoli emulatoru!!!
  0021          =1    24    INPORTB         data    21h
  0022          =1    25    INPORTC         data    22h
  0023          =1    26    OUTPORTA        data    23h
  0024          =1    27    OUTPORTB        data    24h
  0025          =1    28    OUTPORTC        data    25h
  0026          =1    29    INPORTBold      data    26h
  0027          =1    30    CTRLREG         data    27h
                =1    31    
  0030          =1    32    POSITION        data    30h
  0031          =1    33    LOWEST          data    31h
  0032          =1    34    HIGHEST         data    32h
  0033          =1    35    STOPTIMER       data    33h
  0034          =1    36    OUTPORTBold     data    34h
                =1    37    
                =1    38    ;----------------
  0036          =1    39    FLOORREQ        data    36h
                =1    40    ;----------------
                =1    41    
  0040          =1    42    STOPNOT         bit     INPORTA.0
  0041          =1    43    PKI1            bit     INPORTA.1
  0042          =1    44    PKI2            bit     INPORTA.2
  0043          =1    45    PKI3            bit     INPORTA.3
  0044          =1    46    PKI4            bit     INPORTA.4
  0045          =1    47    DOORCLSD        bit     INPORTA.5 
                =1    48    
  0009          =1    49    MB1             bit     INPORTB.1       ; clonky maju invertovanu logiku
  000A          =1    50    MB2             bit     INPORTB.2
  000B          =1    51    SKRH            bit     INPORTB.3
  000C          =1    52    SKRD            bit     INPORTB.4
  000D          =1    53    DP              bit     INPORTB.5
  000E          =1    54    DPZK            bit     INPORTB.6
  000F          =1    55    DPK             bit     INPORTB.7
                =1    56    
  0031          =1    57    MB1old          bit     INPORTBold.1
  0032          =1    58    MB2old          bit     INPORTBold.2
VYTAH/ORI/D                                                                                                  PAGE 2

  0033          =1    59    SKRHold         bit     INPORTBold.3
  0034          =1    60    SKRDold         bit     INPORTBold.4
                =1    61    
                =1    62    
                =1    63    
                =1    64    
                =1    65    
  0010          =1    66    PI1             bit     INPORTC.0       
  0011          =1    67    PI2D            bit     INPORTC.1
  0012          =1    68    PI2U            bit     INPORTC.2
  0013          =1    69    PI3D            bit     INPORTC.3
  0014          =1    70    PI3U            bit     INPORTC.4
  0015          =1    71    PI4             bit     INPORTC.5
                =1    72    
                =1    73    
                =1    74    ;            |  7    |  6    |  5    |  4    |  3    |  2    |  1    |  0    |
                =1    75    ; ****************************************************************************
                =1    76    ; INPORTA >  |       |       |DOORCLS| PKI4  | PKI3  | PKI2  | PKI1  |STOPNOT|
                =1    77    ; ----------------------------------------------------------------------------
                =1    78    ; INPORTB >  | DPK   | DPZK  | DP    | SKRD  | SKRH  | MB2   | MB1   |       |
                =1    79    ; ----------------------------------------------------------------------------
                =1    80    ; INPORTC >  |       |       | PI4   | PI3D  | PI3U  | PI2D  | PI2U  | PI1   |
                =1    81    ; ****************************************************************************
                =1    82    ; OUTPORTA > |       |       |       | PKO4  | PKO3  | PKO2  | PKO1  | KS    |
                =1    83    ; ----------------------------------------------------------------------------
                =1    84    ; OUTPORTB > | FLED4 | FLED3 | FLED2 | FLED1 | SLOW  | FAST  | DOWN  | UP    |
                =1    85    ; ----------------------------------------------------------------------------
                =1    86    ; OUTPORTC > | LEDU  | LEDD  | PO4   | PO3D  | PO3U  | PO2D  | PO2U  | PO1   |
                =1    87    ; ----------------------------------------------------------------------------
                =1    88    
                =1    89    
  0018          =1    90    KS              bit     OUTPORTA.0
  0019          =1    91    PKO1            bit     OUTPORTA.1
  001A          =1    92    PKO2            bit     OUTPORTA.2
  001B          =1    93    PKO3            bit     OUTPORTA.3
  001C          =1    94    PKO4            bit     OUTPORTA.4
                =1    95    
  0020          =1    96    UP              bit     OUTPORTB.0
  0021          =1    97    DOWN            bit     OUTPORTB.1
  0022          =1    98    FAST            bit     OUTPORTB.2
  0023          =1    99    SLOW            bit     OUTPORTB.3
  0024          =1   100    FLED1           bit     OUTPORTB.4
  0025          =1   101    FLED2           bit     OUTPORTB.5
  0026          =1   102    FLED3           bit     OUTPORTB.6
  0027          =1   103    FLED4           bit     OUTPORTB.7
                =1   104    
  0028          =1   105    PO1             bit     OUTPORTC.0
  0029          =1   106    PO2D            bit     OUTPORTC.1
  002A          =1   107    PO2U            bit     OUTPORTC.2
  002B          =1   108    PO3D            bit     OUTPORTC.3
  002C          =1   109    PO3U            bit     OUTPORTC.4
  002D          =1   110    PO4             bit     OUTPORTC.5
  002E          =1   111    LEDD            bit     OUTPORTC.6
  002F          =1   112    LEDU            bit     OUTPORTC.7
                =1   113    
  0038          =1   114    STOPPED         bit     CTRLREG.0
  0039          =1   115    DOORCLSDold     bit     CTRLREG.1
  003A          =1   116    UPold           bit     CTRLREG.2
VYTAH/ORI/D                                                                                                  PAGE 3

  003B          =1   117    DOWNold         bit     CTRLREG.3
  003C          =1   118    FASTold         bit     CTRLREG.4
  003D          =1   119    SLOWold         bit     CTRLREG.5
                =1   120    
  00B6          =1   121    WRNOT           bit     0b6h        ; p3.6
  00B7          =1   122    RDNOT           bit     0b7h        ; p3.7
                =1   123    
                =1   124    ; bitove masky
                =1   125    ; 8255OUT 
                =1   126    ; port A
  0001          =1   127    bmKS              equ    00000001b
  0002          =1   128    bmPKO1            equ    00000010b
  0004          =1   129    bmPKO2            equ    00000100b
  0008          =1   130    bmPKO3            equ    00001000b
  0010          =1   131    bmPKO4            equ    00010000b
                =1   132    
                =1   133    ; port B
  0001          =1   134    bmUP              equ    00000001b
  0002          =1   135    bmDOWN            equ    00000010b
  0004          =1   136    bmFAST            equ    00000100b
  0008          =1   137    bmSLOW            equ    00001000b
  0010          =1   138    bmFLED1           equ    00010000b
  0020          =1   139    bmFLED2           equ    00100000b
  0040          =1   140    bmFLED3           equ    01000000b
  0080          =1   141    bmFLED4           equ    10000000b
                =1   142    
                =1   143    ; port C
  0001          =1   144    bmPO1             equ    00000001b
  0002          =1   145    bmPO2D            equ    00000010b
  0004          =1   146    bmPO2U            equ    00000100b
  0008          =1   147    bmPO3D            equ    00001000b
  0010          =1   148    bmPO3U            equ    00010000b
  0020          =1   149    bmPO4             equ    00100000b
  0040          =1   150    bmLEDD            equ    01000000b
  0080          =1   151    bmLEDU            equ    10000000b
                =1   152    
                =1   153    ; 8255IN
                =1   154    ; port A
  0001          =1   155    bmSTOP            equ    00000001b
  0002          =1   156    bmPKI1            equ    00000010b
  0004          =1   157    bmPKI2            equ    00000100b
  0008          =1   158    bmPKI3            equ    00001000b
  0010          =1   159    bmPKI4            equ    00010000b
  0020          =1   160    bmDOORCLSD        equ    00100000b
                =1   161    
                =1   162    ; port B
  0002          =1   163    bmMB1I            equ    00000010b
  0004          =1   164    bmMB2I            equ    00000100b
  0008          =1   165    bmSKRHI           equ    00001000b
  0010          =1   166    bmSKRHD           equ    00010000b
  0020          =1   167    bmDPI             equ    00100000b
  0040          =1   168    bmDPZKI           equ    01000000b
  0080          =1   169    bmDPKI            equ    10000000b
                =1   170    
                =1   171    ; port C
  0001          =1   172    bmPI1             equ    00000001b
  0002          =1   173    bmPI2D            equ    00000010b
  0004          =1   174    bmPI2U            equ    00000100b
VYTAH/ORI/D                                                                                                  PAGE 4

  0008          =1   175    bmPI3D            equ    00001000b
  0010          =1   176    bmPI3U            equ    00010000b
  0020          =1   177    bmPI4             equ    00100000b
                =1   178    
                =1   179    ; Sachta - masky
  003E          =1   180    bmSmerPI1U            equ    00111110b
  0001          =1   181    bmSmerPI2D            equ    00000001b
  0038          =1   182    bmSmerPI2U            equ    00111000b
  0007          =1   183    bmSmerPI3D            equ    00000111b
  0020          =1   184    bmSmerPI3U            equ    00100000b
  001F          =1   185    bmSmerPI4D            equ    00011111b
                =1   186    
                =1   187    ; Kabina - masky
  001C          =1   188    bmSmerPKI1U           equ    00011100b
  0002          =1   189    bmSmerPKI2D           equ    00000010b
  0018          =1   190    bmSmerPKI2U           equ    00011000b
  0006          =1   191    bmSmerPKI3D           equ    00000110b
  0010          =1   192    bmSmerPKI3U           equ    00010000b
  000E          =1   193    bmSmerPKI4D           equ    00001110b
                     194    
                     195    _BP_    MACRO 
                     196            clr     P3.3
                     197            setb    EX1
                     198            nop
                     199            nop
                     200    ENDM
                     201    
                     202    LJZ     MACRO   NAVESTIE
                     203            jnz     $+5
                     204            ljmp    NAVESTIE
                     205            nop
                     206    ENDM
                     207    
                     208    LJNZ    MACRO   NAVESTIE
                     209            jz      $+5
                     210            ljmp    NAVESTIE
                     211            nop
                     212    ENDM
                     213    
                     214    LJB     MACRO   TESTBIT, NAVESTIE
                     215            jnb     TESTBIT, $+6
                     216            ljmp    NAVESTIE
                     217            nop
                     218    ENDM
                     219    
                     220    LJNB    MACRO   TESTBIT, NAVESTIE
                     221            jb      TESTBIT, $+6
                     222            ljmp    NAVESTIE
                     223            nop
                     224    ENDM
                     225    
                     226    CJE     MACRO   OP1, OP2, NAVESTIE
                     227            cjne    OP1, OP2, $+7
                     228            jmp    NAVESTIE
                     229            nop
                     230    ENDM
                     231    
                     232    LCJNE   MACRO   OP1, OP2, NAVESTIE
VYTAH/ORI/D                                                                                                  PAGE 5

                     233            cjne    OP1, OP2, $+6
                     234            jmp     $+6
                     235            ljmp    NAVESTIE
                     236            nop
                     237    ENDM
                     238    
                     239    ZAKMITC MACRO   TYPCLONKY
                     240            lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
                     241            lcall   READPORTS       ; Uz sme z tej clonky prec?
                     242            jnb     TYPCLONKY, $-3  ; 
                     243            lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                     244    ENDM
                     245    
                     246    ZASTAV  MACRO  C_POSCH, SMER
                     247                                            ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
                     248            clr     C                       ; | Idem robit cachre-machre s Carry bitom
                     249            mov     A, #0h                  ; | Aj Acc potrebujem prazdny
                     250            orl     C, PI&C_POSCH&SMER      ; | Mam v tomto smere stlacene tlacidlo v sachte?
                     251            anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
                     252            orl     C, PKI&C_POSCH          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
                     253            orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
                     254            orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
                     255            addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
                     256    ENDM
                     257    
                     258    NAJNIZSIE  MACRO
                     259            mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
                     260            rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
                     261            anl     A, #01111110b   ; Vynulujem nedefinovane bity
                     262            mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                     263     ; LL1: 
                     264            jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
                     265            clr     C               ; Inak shiftnem o 2
                     266            rlc     A               ;
                     267            clr     C               ;
                     268            rlc     A               ;
                     269            djnz    R0, $-6         ; ...a pokracujem v zistovani
                     270    ; LL2:
                     271            mov     A, R0           ; vysledne (najnizsie zvolene) poschodie je index v R0
                     272    ENDM
                     273    
                     274    NAJVYSSIE  MACRO
                     275            mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
                     276            rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
VYTAH/ORI /D                                                                                                  PAGE 6

                     277            anl     A, #01111110b   ; Vynulujem nedefinovane bity
                     278            mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                     279     ; LL1: 
                     280            jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
                     281            clr     C               ; Inak shiftnem o 2
                     282            rrc     A               ;
                     283            clr     C               ;
                     284            rrc     A               ;
                     285            djnz    R0, $-6         ; ...a pokracujem v zistovani
                     286    ; LL2:
                     287            mov     A, #5           ; vysledne (najnizsie zvolene) poschodie je index v R0
                     288            clr     C               ;
                     289            subb    A, R0           ;
                     290    ENDM
                     291    
                     292    VYSSIE_KABINA  MACRO  POSCH
                     293            mov     A, INPORTA
                     294            anl     A, #00011110b
                     295            clr     C
                     296            rrc     A
                     297    ;LL1    
                     298            mov     R0, #&POSCH
                     299            clr     C
                     300            rrc     A
                     301            djnz    R0, $-2;LL1
                     302    ENDM
                     303    
                     304    NIZSIE_KABINA  MACRO  POSCH
                     305            mov     A, #5
                     306            clr     C
                     307            subb    A, #&POSCH
                     308            mov     R0, A
                     309            mov     A, INPORTA
                     310            anl     A, #00011110b
                     311            clr     C
                     312            rlc     A
                     313            clr     C
                     314            rlc     A
                     315            clr     C
                     316            rlc     A
                     317    ;LL1   
                     318            clr     C
                     319            rlc     A
                     320            djnz    R0, $-2;LL1
                     321    ENDM
                     322    
                     323    POLOHA_LED  MACRO  POLOHA
                     324            clr     LEDU            
                     325            clr     LEDD 
                     326            clr     FLED1             
                     327            clr     FLED2                
                     328            clr     FLED3           
                     329            clr     FLED4           
                     330            setb    FLED&POLOHA
                     331            lcall   WRITEPORTS
VYTAH/ORI                                                                                                     PAGE 7

                     332    ENDM
                     333    
                     334    ; hodiny oscilatora v emulatore treba dat na ext a nastavit 11.0592MHz
  00FA               335    TIMERCONST      equ     250     ; udaj pre nastavenie casovaca pre potreby seriovej komunika
                                                                               cie
                     336                                    ; hodnota 250 znamena prenosovu rychlost 4800 baud pri oscil
                                                                               atore 11.0592MHz
                     337                                    ; nastavenie terminalu je 4800 8-N-1, no flow control
                     338    ;osetrenie vektorov preruseni
0000                 339            org     0000h           ; adresa odkial startuje program po resete
0000 020033          340            ljmp    START           ; skok na zaciatok kodu programu
                     341                  
0033                 342            org     0033h           ; od tejto adresy sa zacina kod programu
0033                 343    START:
0033                 344    RESET:  
                     345            ; riadiace signaly do pasivnej urovne 
0033 D2B6            346            setb    WRNOT
0035 D2B7            347            setb    RDNOT
0037 753300          348            mov     STOPTIMER, #0
003A 758140          349            mov     SP, #STACK
                     350    
                     351            ; pockame si na inicializaciu obvodov 8255  
003D 7900            352            mov     R1, #0 
003F 7AFF            353            mov     R2, #0ffh
0041 D9FE            354            djnz    R1, $
0043 DAFC            355            djnz    R2, $-2
                     356            
                     357            ; teraz ich mozeme nastavit
0045 75809B          358            mov     p0, #10011011b      ; nastavenie i8255IN - vsetky porty dnu
0048 75A083          359            mov     p2, #i8255INCW
004B C2B6            360            clr     WRNOT
004D 00              361            nop
004E 00              362            nop
004F 00              363            nop
0050 00              364            nop
0051 D2B6            365            setb    WRNOT
0053 758080          366            mov     p0, #10000000b      ; nastavenie i8255OUT - vsetky porty von
0056 75A0C3          367            mov     p2, #i8255OUTCW
0059 C2B6            368            clr     WRNOT
005B 00              369            nop
005C 00              370            nop
005D 00              371            nop
005E 00              372            nop
005F D2B6            373            setb    WRNOT
                     374            
                     375 +1         _BP_
0061 C2B3            376 +1         clr     P3.3
0063 D2AA            377 +1         setb    EX1
0065 00              378 +1         nop
0066 00              379 +1         nop
                     381    
                     382            ; pociatocna inicializacia - vynuluj vstupne registre a rozsviet vsetky diody 
0067 752800          383            mov     INPORTA, #0
006A 75211E          384            mov     INPORTB, #01eh      ; vsetky clonky pasivne
006D 752200          385            mov     INPORTC, #0
0070 75231E          386            mov     OUTPORTA, #(bmPKO1 or bmPKO2 or bmPKO3 or bmPKO4)
0073 7524F0          387            mov     OUTPORTB, #(bmFLED1 or bmFLED2 or bmFLED3 or bmFLED4)
0076 7525FF          388            mov     OUTPORTC, #(bmPO1 or bmPO2D or bmPO2U or bmPO3D or bmPO3U or bmPO4 or bmLEDD
VYTAH/ORIgFD                                                                                                  PAGE 8

                                                                                or bmLEDU)
0079 D218            389            setb    KS
007B C238            390            clr     STOPPED
007D 1208E9          391            call    WRITEPORTS          ; zapis novu informaciu
                     392    ;;;;;;;;
                     393    
0080 752300          394            mov     OUTPORTA, #0
0083 752400          395            mov     OUTPORTB, #0
0086 752500          396            mov     OUTPORTC, #0
0089 1208E9          397            call    WRITEPORTS          ; zapis novu informaciu
                     398    
008C 752800          399            mov     INPORTA, #0
008F 752100          400            mov     INPORTB, #0         
0092 752200          401            mov     INPORTC, #0
0095 12088E          402            call    READPORTS           ; prvotne nacitanie udajov
                     403    
0098                 404    CALIB:
                     405            ;kalibracia vytahu podla dolnej porovnavacej clonky
0098 12088E          406            lcall   READPORTS                   ; precitaj, co je na portoch
009B 300C11          407            jnb     SKRD, CALIBEND              ; ak sme na dolnej porovnavacej clonke, tak koni
                                                                               ec
009E D221            408            setb    DOWN                        ; inak pod dole
00A0 D222            409            setb    FAST                        ; a rychlo
00A2 C223            410            clr     SLOW                        ;
00A4 1208E9          411            lcall   WRITEPORTS                  ; zapis informaciu 
00A7                 412    CALIBLOOP:
00A7 12088E          413            lcall   READPORTS                   ; 
00AA 300C02          414            jnb     SKRD, CALIBEND              ; ak sme dole, konci
00AD 80F8            415            jmp     CALIBLOOP
00AF                 416    CALIBEND:                              
00AF C222            417            clr     FAST                        ; zastavime v tomto smere
00B1 C221            418            clr     DOWN                        ;
00B3 D223            419            setb    SLOW                        ; Este sa pohneme kusocek hore, aby sme si 
00B5 D220            420            setb    UP                          ; boli isti, ze sme spravne synchronizovani na p
                                                                               oschodi
00B7 1208E9          421            lcall   WRITEPORTS 
00BA                 422    CALIBEND2:
00BA 12088E          423            lcall   READPORTS                   ; 
00BD 2009FA          424            jb      MB1, CALIBEND2              ; 
00C0 C223            425            clr     SLOW                        ; A teraz sme uz naozaj spravne
00C2 C220            426            clr     UP                          ; 
00C4 D224            427            setb    FLED1
00C6 1208E9          428            lcall   WRITEPORTS                  ; zapis informaciu
                     429    ;        _BP_
00C9                 430    MAIN:
                     431    
                     432    ;            |  7    |  6    |  5    |  4    |  3    |  2    |  1    |  0    |
                     433    ; ****************************************************************************
                     434    ; INPORTA >  |       |       |DOORCLS| PKI4  | PKI3  | PKI2  | PKI1  |STOPNOT|
                     435    ; ----------------------------------------------------------------------------
                     436    ; INPORTB >  | DPK   | DPZK  | DP    | SKRD  | SKRH  | MB2   | MB1   |       |
                     437    ; ----------------------------------------------------------------------------
                     438    ; INPORTC >  |       |       | PI4   | PI3D  | PI3U  | PI2D  | PI2U  | PI1   |
                     439    ; ****************************************************************************
                     440    ; OUTPORTA > |       |       |       | PKO4  | PKO3  | PKO2  | PKO1  | KS    |
                     441    ; ----------------------------------------------------------------------------
                     442    ; OUTPORTB > | FLED4 | FLED3 | FLED2 | FLED1 | SLOW  | FAST  | DOWN  | UP    |
                     443    ; ----------------------------------------------------------------------------
VYTAH/ORI                                                                                                     PAGE 9

                     444    ; OUTPORTC > | LEDU  | LEDD  | PO4   | PO3D  | PO3U  | PO2D  | PO2U  | PO1   |
                     445    ; ****************************************************************************
                     446    ; POSITION
                     447    ; ****************************************************************************
                     448    
                     449    
                     450    ;------------------------------------------------------------------------------- << 1. posch
                                                                               odie >>
                     451    
00C9                 452    FLOOR1:
                     453 +1                 POLOHA_LED 1  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
00C9 C22F            454 +1         clr     LEDU            
00CB C22E            455 +1         clr     LEDD 
00CD C224            456 +1         clr     FLED1             
00CF C225            457 +1         clr     FLED2                
00D1 C226            458 +1         clr     FLED3           
00D3 C227            459 +1         clr     FLED4           
00D5 D224            460 +1         setb    FLED1
00D7 1208E9          461 +1         lcall   WRITEPORTS
00DA 12084A          463            lcall   WAITFORTIMER    ; simulacia TIMERu
00DD 12088E          464    F1S:    lcall   READPORTS     ;-; nacitanie dat
00E0 C219            465            clr     PKO1          ;-; vynulovanie volby poschodia na ktorom stojim
00E2 C228            466            clr     PO1             ;
00E4 1208E9          467            lcall   WRITEPORTS      ;
00E7 200FF3          468            jb      DPK, F1S        ; Mam pretazenu kabinu? (Ak ano, tak sa nepohnem)
00EA E528            469            mov     A, INPORTA      ; zistenie, ci bolo stlacene nieco viac ako poschodie na kto
                                                                               rom stojim (Kabina)
00EC 541C            470            anl     A, #00011100b ;-;
00EE 7008            471            jnz     F1OK          ;-; ak ano, podme na to
00F0 E522            472            mov     A, INPORTC      ; zistenie, ci bolo stlacene nieco viac ako poschodie na kto
                                                                               rom stojim (Sachta)
00F2 543E            473            anl     A, #00111110b ;-;
00F4 7002            474            jnz     F1OK          ;-; ak ano, podme na to
00F6 80E5            475            jmp     F1S             ; Nemam sa kde hnut, opakujem
00F8 D220            476    F1OK:   setb    UP              ; rychly pohyb hore
00FA D222            477            setb    FAST            ; 
00FC C223            478            clr     SLOW            ;
00FE 1208E9          479            lcall   WRITEPORTS      ; 
0101 020104          480            jmp     UP1           ;-; prejdi do stavu UP1
0104                 481    UP1:
                     482 +1                 POLOHA_LED 1  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
0104 C22F            483 +1         clr     LEDU            
0106 C22E            484 +1         clr     LEDD 
0108 C224            485 +1         clr     FLED1             
010A C225            486 +1         clr     FLED2                
010C C226            487 +1         clr     FLED3           
010E C227            488 +1         clr     FLED4           
0110 D224            489 +1         setb    FLED1
0112 1208E9          490 +1         lcall   WRITEPORTS
                     492 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
0115 120815          493 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0118 12088E          494 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
011B 3009FA          495 +1         jnb     MB1, $-3  ; 
011E 120815          496 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0121 12088E          498    UP1A:   lcall   READPORTS       ; nacitanie dat
VYTAH/ORIqDàE©4èE©4                                                                                          PAGE 10

                     499 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
0124 200B03          500 +1         jb      SKRH, $+6
0127 0207FA          501 +1         ljmp    ERR_SKRH
012A 00              502 +1         nop
                     504 +1         ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na z
                                                                               astavovaciu) <<<
012B 200903          505 +1         jb      MB1, $+6
012E 0207CD          506 +1         ljmp    ERR_2SPOM_C
0131 00              507 +1         nop
0132 200AEC          509            jb      MB2, UP1A     ;-; mame uz 1. spomalovaciu clonku?
                     510 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme      
0135 120815          511 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0138 12088E          512 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
013B 300AFA          513 +1         jnb     MB2, $-3  ; 
013E 120815          514 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0141 D22E            516            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
0143 1208E9          517            lcall   WRITEPORTS      ;
0146 020149          518            jmp     UP1_MB2       ;-; a prejdi do stavu UP1_MB2
0149                 519    UP1_MB2:
0149 12088E          520            lcall   READPORTS       ; nacitanie dat
                     521 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
014C 200B03          522 +1         jb      SKRH, $+6
014F 0207FA          523 +1         ljmp    ERR_SKRH
0152 00              524 +1         nop
                     526 +1         ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na zas
                                                                               tavovaciu) <<<
0153 200903          527 +1         jb      MB1, $+6
0156 0207BE          528 +1         ljmp    ERR_1SPOM_C
0159 00              529 +1         nop
015A 200AEC          531            jb      MB2, UP1_MB2  ;-; mame uz aj druhu spomalovaciu clonku?     
015D D22F            532            setb    LEDU            ; Rozsviet LEDku, ze mame druhu MB2
015F 1208E9          533            lcall   WRITEPORTS      ;   
                     534 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
0162 120815          535 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0165 12088E          536 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0168 300AFA          537 +1         jnb     MB2, $-3  ; 
016B 120815          538 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                     540    ;        mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
                     541    ;        anl     A, #00000100b ;-;
                     542    ;        jz      UP1_MB1       ;-;       Ak nie, chod do stavu UP1_MB1        
                     543 +1         ZASTAV  2, U            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0) 
                     544 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
016E C3              545 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
016F 7400            546 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
0171 7212            547 +1         orl     C, PI2U      ; | Mam v tomto smere stlacene tlacidlo v sachte?
0173 B00E            548 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
0175 7242            549 +1         orl     C, PKI2          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
0177 720F            550 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
0179 7238            551 +1         orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
017B 3400            552 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
VYTAH/ORI(JDìG©4ðG©4                                                                                          PAGE 11

                                                                               iny
017D 702E            554            jnz     U1_MB2C       ;-; Ak ano, zastav
                     555 +1         NAJVYSSIE               ; | ..a sme na najvyssom privolanom poschodi? (potom stojime
                                                                                urcite)
017F E522            556 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
0181 33              557 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
0182 547E            558 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
0184 7805            559 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                     560 +1  ; LL1: 
0186 6006            561 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
0188 C3              562 +1         clr     C               ; Inak shiftnem o 2
0189 13              563 +1         rrc     A               ;
018A C3              564 +1         clr     C               ;
018B 13              565 +1         rrc     A               ;
018C D8F8            566 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                     567 +1 ; LL2:
018E 7405            568 +1         mov     A, #5           ; vysledne (najnizsie zvolene) poschodie je index v R0
0190 C3              569 +1         clr     C               ;
0191 98              570 +1         subb    A, R0           ;
                     572 +1         LCJNE   A, #2, UP1_MB1  ; |   ak nie, nezastavujeme 
0192 B40203          573 +1         cjne    A, #2, $+6
0195 02019B          574 +1         jmp     $+6
0198 0201B7          575 +1         ljmp    UP1_MB1
019B 00              576 +1         nop
                     578 +1         VYSSIE_KABINA 2         ; | ..ok, sme na najvyssom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
019C E528            579 +1         mov     A, INPORTA
019E 541E            580 +1         anl     A, #00011110b
01A0 C3              581 +1         clr     C
01A1 13              582 +1         rrc     A
                     583 +1 ;LL1    
01A2 7802            584 +1         mov     R0, #2
01A4 C3              585 +1         clr     C
01A5 13              586 +1         rrc     A
01A6 D8FC            587 +1         djnz    R0, $-2;LL1
01A8 6003            589            jz      U1_MB2C         ; |   ak neni zastavujem         
01AA 0201B7          590            jmp     UP1_MB1          ; |   inak nezastavim        
01AD D223            591    U1_MB2C:setb    SLOW            ;       Ak ano, spomalme
01AF C222            592            clr     FAST            ; 
01B1 1208E9          593            lcall   WRITEPORTS      ;         
01B4 0201B7          594            jmp     UP1_MB1       ;-; a prejdi do stavu UP1_MB1 
01B7                 595    UP1_MB1:
01B7 12088E          596            lcall   READPORTS       ; nacitanie dat
                     597 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
01BA 200B03          598 +1         jb      SKRH, $+6
01BD 0207FA          599 +1         ljmp    ERR_SKRH
01C0 00              600 +1         nop
                     602 +1         ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na spo
                                                                               malovaciu) <<<
01C1 200A03          603 +1         jb      MB2, $+6
01C4 0207DC          604 +1         ljmp    ERR_ZAST_C
01C7 00              605 +1         nop
VYTAH/ORIDˆI©4ŽI©4                                                                                          PAGE 12

01C8 2009EC          607            jb      MB1, UP1_MB1  ;-; Sme na zastavovacej clonke?
                     608    
                     609 +1         ZASTAV  2, U            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0) 
                     610 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
01CB C3              611 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
01CC 7400            612 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
01CE 7212            613 +1         orl     C, PI2U      ; | Mam v tomto smere stlacene tlacidlo v sachte?
01D0 B00E            614 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
01D2 7242            615 +1         orl     C, PKI2          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
01D4 720F            616 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
01D6 7238            617 +1         orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
01D8 3400            618 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
01DA C238            620            clr     STOPPED         ; Priznak STOPPED vynulujem, uz som ho osetril
01DC 702E            621            jnz     U1_MB1C       ;-; Ak ano, zastav
                     622 +1         NAJVYSSIE               ; | ..a sme na najvyssom privolanom poschodi? (potom stojime
                                                                                urcite)
01DE E522            623 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
01E0 33              624 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
01E1 547E            625 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
01E3 7805            626 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                     627 +1  ; LL1: 
01E5 6006            628 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
01E7 C3              629 +1         clr     C               ; Inak shiftnem o 2
01E8 13              630 +1         rrc     A               ;
01E9 C3              631 +1         clr     C               ;
01EA 13              632 +1         rrc     A               ;
01EB D8F8            633 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                     634 +1 ; LL2:
01ED 7405            635 +1         mov     A, #5           ; vysledne (najnizsie zvolene) poschodie je index v R0
01EF C3              636 +1         clr     C               ;
01F0 98              637 +1         subb    A, R0           ;
                     639 +1         LCJNE   A, #2, UP2      ; |   ak nie, nezastavujeme 
01F1 B40203          640 +1         cjne    A, #2, $+6
01F4 0201FA          641 +1         jmp     $+6
01F7 020296          642 +1         ljmp    UP2
01FA 00              643 +1         nop
                     645 +1         VYSSIE_KABINA 2         ; | ..ok, sme na najvyssom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
01FB E528            646 +1         mov     A, INPORTA
01FD 541E            647 +1         anl     A, #00011110b
01FF C3              648 +1         clr     C
0200 13              649 +1         rrc     A
                     650 +1 ;LL1    
0201 7802            651 +1         mov     R0, #2
0203 C3              652 +1         clr     C
VYTAH/ORIRDÔJ©4                                                                                              PAGE 13

0204 13              653 +1         rrc     A
0205 D8FC            654 +1         djnz    R0, $-2;LL1
0207 6003            656            jz      U1_MB1C         ; |   ak neni zastavujem         
0209 020296          657            ljmp    UP2             ; |   inak nezastavim        
020C C220            658    U1_MB1C:clr     UP              ; zastav motor
020E D23A            659            setb    UPOld           ;       (a zalohuj) 
0210 C23B            660            clr     DOWNOld         ;       (a zalohuj)
0212 C222            661            clr     FAST            ; 
0214 1208E9          662            lcall   WRITEPORTS      ; 
0217 02021A          663            jmp     FLOOR2        ;-; a prejdi do stavu FLOOR2
                     664    
                     665    ;------------------------------------------------------------------------------- << 2. posch
                                                                               odie >>
                     666    
021A                 667    FLOOR2:
                     668 +1                 POLOHA_LED 2  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
021A C22F            669 +1         clr     LEDU            
021C C22E            670 +1         clr     LEDD 
021E C224            671 +1         clr     FLED1             
0220 C225            672 +1         clr     FLED2                
0222 C226            673 +1         clr     FLED3           
0224 C227            674 +1         clr     FLED4           
0226 D225            675 +1         setb    FLED2
0228 1208E9          676 +1         lcall   WRITEPORTS
022B 12084A          678            lcall   WAITFORTIMER    ; simulacia TIMERu
022E 12088E          679    F2S:    lcall   READPORTS     ;-; nacitanie dat
0231 C21A            680            clr     PKO2          ;-; vynulovanie volby poschodia na ktorom stojim
0233 C22A            681            clr     PO2U            ;
0235 C229            682            clr     PO2D            ;
0237 1208E9          683            lcall   WRITEPORTS      ;
023A 200FF1          684            jb      DPK, F2S        ; Mam pretazenu kabinu? (Ak ano, tak sa nepohnem)
023D 79F8            685            mov     R1, #11111000b;-; Default predpokladam, ze mam namierene hore (na 3. a 4.) k
                                                                               abina
023F 7AF8            686            mov     R2, #11111000b;-; Default predpokladam, ze mam namierene hore (na 3. a 4.) s
                                                                               achta
0241 203A06          687            jb      UPOld, F2OK     ;   Je to pravda? Naozaj som doteraz isiel hore?
0244 E9              688            mov     A, R1           ;       Ak nie, znegujeme masku kabiny
0245 F4              689            cpl     A               ;       |
0246 F9              690            mov     R1, A           ;       |
0247 EA              691            mov     A, R2           ;       A znegujeme aj masku sachty
0248 F4              692            cpl     A               ;       |
0249 FA              693            mov     R2, A           ;       |
024A                 694    F2OK:   ; Pohyb v jednom smere (nevieme v ktorom)
024A E528            695            mov     A, INPORTA      ; zistenie, ci bolo stlacene nieco viac (menej) ako poschodi
                                                                               e na ktorom stojim (Kabina)
024C 541A            696            anl     A, #00011010b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
024E 59              697            anl     A, R1           ;  | 
024F 7027            698            jnz     F2              ; nasli sme poschodie v tomto smere, mozme ist
                     699                                    ; zistenie, ci bolo stlacene nieco viac (menej) ako poschodi
                                                                               e na ktorom stojim (Sachta)
0251 E528            700            mov     A, INPORTA      ; Mam v kabine nieco stlacene?
0253 541A            701            anl     A, #00011010b   ;  | Beriem iba bity predstavujuce tlacidla poschodi (kabina
                                                                               )
0255 7007            702            jnz     F2SW            ;  | Ak ano, idem rovno zistovat opacny smer.
0257 E522            703            mov     A, INPORTC      ; Mam stlacene nieco v sachte (mojim smerom)?    
0259 5439            704            anl     A, #00111001b   ;  | Beriem iba bity predstavujuce tlacidla privolavacov
025B 5A              705            anl     A, R2           ;  |   
VYTAH/ORI +D K©4                                                                                              PAGE 14

025C 701A            706            jnz     F2              ; nasli sme poschodie v tomto smere, mozme ist
                     707            ; Pohyb v opacnom smere (nevieme v ktorom)
025E B23A            708    F2SW:   cpl     UPOld           ;  Znegujem stary posun
0260 B23B            709            cpl     DOWNOld         ;  |
0262 E9              710            mov     A, R1           ;  Znegujeme masky
0263 F4              711            cpl     A               ;  |
0264 F9              712            mov     R1, A           ;  |
0265 EA              713            mov     A, R2           ;  |
0266 F4              714            cpl     A               ;  |
0267 FA              715            mov     R2, A           ;  |               
0268 E528            716            mov     A, INPORTA      ; zistenie, cibolo stlacene nieco viac ako poschodie na ktor
                                                                               om stojim (Kabina)
026A 541A            717            anl     A, #00011010b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
026C 59              718            anl     A, R1           ;  | 
026D 7009            719            jnz     F2              ; nasli sme poschodie v tomto smere, mozme ist
026F E522            720            mov     A, INPORTC      ; zistenie, cibolo stlacene nieco viac ako poschodie na ktor
                                                                               om stojim (Sachta)
0271 5439            721            anl     A, #00111001b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
0273 5A              722            anl     A, R2           ;  | 
0274 7002            723            jnz     F2              ; nasli sme poschodie v tomto smere, mozme ist
0276 80B6            724            jmp     F2S           ;-; nemame sa kde hybat, tak opakujeme zistovanie
0278 203A03          725    F2:     jb      UPOld, F2UP     ;   
027B 02028A          726            jmp     F2DOWN          ;
027E D220            727    F2UP:   setb    UP              ; rychly pohyb hore
0280 D222            728            setb    FAST            ; 
0282 C223            729            clr     SLOW            ;
0284 1208E9          730            lcall   WRITEPORTS      ; 
0287 020296          731            jmp     UP2           ;-; prejdi do stavu UP2    
028A D221            732    F2DOWN: setb    DOWN            ; rychly pohyb hore
028C D222            733            setb    FAST            ; 
028E C223            734            clr     SLOW            ;
0290 1208E9          735            lcall   WRITEPORTS      ; 
0293 0203AC          736            jmp     DOWN2         ;-; prejdi do stavu DOWN2    
                     737            
                     738                
0296                 739    UP2:
                     740 +1                 POLOHA_LED 2  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
0296 C22F            741 +1         clr     LEDU            
0298 C22E            742 +1         clr     LEDD 
029A C224            743 +1         clr     FLED1             
029C C225            744 +1         clr     FLED2                
029E C226            745 +1         clr     FLED3           
02A0 C227            746 +1         clr     FLED4           
02A2 D225            747 +1         setb    FLED2
02A4 1208E9          748 +1         lcall   WRITEPORTS
                     750 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
02A7 120815          751 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
02AA 12088E          752 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
02AD 3009FA          753 +1         jnb     MB1, $-3  ; 
02B0 120815          754 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
02B3 12088E          756    UP2A:   lcall   READPORTS       ; nacitanie dat
                     757 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
02B6 200B03          758 +1         jb      SKRH, $+6
02B9 0207FA          759 +1         ljmp    ERR_SKRH
02BC 00              760 +1         nop
                     762 +1         ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na z
VYTAH/ORI
DbL©4hL©4                                                                                          PAGE 15

                                                                               astavovaciu) <<<
02BD 200903          763 +1         jb      MB1, $+6
02C0 0207CD          764 +1         ljmp    ERR_2SPOM_C
02C3 00              765 +1         nop
02C4 200AEC          767            jb      MB2, UP2A     ;-; mame uz 1. spomalovaciu clonku?
                     768 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
02C7 120815          769 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
02CA 12088E          770 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
02CD 300AFA          771 +1         jnb     MB2, $-3  ; 
02D0 120815          772 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
02D3 D22E            774            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
02D5 1208E9          775            lcall   WRITEPORTS      ;
02D8 0202DB          776            jmp     UP2_MB2       ;-; a prejdi do stavu UP2_MB2
02DB                 777    UP2_MB2:
02DB 12088E          778            lcall   READPORTS       ; nacitanie dat
                     779 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
02DE 200B03          780 +1         jb      SKRH, $+6
02E1 0207FA          781 +1         ljmp    ERR_SKRH
02E4 00              782 +1         nop
                     784 +1         ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na zas
                                                                               tavovaciu) <<<
02E5 200903          785 +1         jb      MB1, $+6
02E8 0207BE          786 +1         ljmp    ERR_1SPOM_C
02EB 00              787 +1         nop
02EC 200AEC          789            jb      MB2, UP2_MB2  ;-; mame uz aj druhu spomalovaciu clonku?          
02EF D22F            790            setb    LEDU            ; Rozsviet LEDku, ze mame druhu MB2
02F1 1208E9          791            lcall   WRITEPORTS      ;
                     792 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
02F4 120815          793 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
02F7 12088E          794 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
02FA 300AFA          795 +1         jnb     MB2, $-3  ; 
02FD 120815          796 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                     798    ;        mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
                     799    ;        anl     A, #00001000b ;-;
                     800    ;        jz      UP2_MB1       ;-;       Ak nie, chod do stavu UP2_MB1
                     801 +1         ZASTAV  3, U            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0)
                     802 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
0300 C3              803 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
0301 7400            804 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
0303 7214            805 +1         orl     C, PI3U      ; | Mam v tomto smere stlacene tlacidlo v sachte?
0305 B00E            806 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
0307 7243            807 +1         orl     C, PKI3          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
0309 720F            808 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
030B 7238            809 +1         orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
030D 3400            810 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
030F 702E            812            jnz     U2_MB2C       ;-; Ak ano, zastav
                     813 +1         NAJVYSSIE               ; | ..a sme na najvyssom privolanom poschodi z kabiny? (poto
                                                                               m stojime urcite)
0311 E522            814 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
VYTAH/ORI aD                                                                                                  PAGE 16

0313 33              815 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
0314 547E            816 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
0316 7805            817 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                     818 +1  ; LL1: 
0318 6006            819 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
031A C3              820 +1         clr     C               ; Inak shiftnem o 2
031B 13              821 +1         rrc     A               ;
031C C3              822 +1         clr     C               ;
031D 13              823 +1         rrc     A               ;
031E D8F8            824 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                     825 +1 ; LL2:
0320 7405            826 +1         mov     A, #5           ; vysledne (najnizsie zvolene) poschodie je index v R0
0322 C3              827 +1         clr     C               ;
0323 98              828 +1         subb    A, R0           ;
                     830 +1         LCJNE   A, #3, UP2_MB1  ; |   ak nie, nezastavujeme  
0324 B40303          831 +1         cjne    A, #3, $+6
0327 02032D          832 +1         jmp     $+6
032A 020349          833 +1         ljmp    UP2_MB1
032D 00              834 +1         nop
                     836 +1         VYSSIE_KABINA 3         ; | ..ok, sme na najvyssom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
032E E528            837 +1         mov     A, INPORTA
0330 541E            838 +1         anl     A, #00011110b
0332 C3              839 +1         clr     C
0333 13              840 +1         rrc     A
                     841 +1 ;LL1    
0334 7803            842 +1         mov     R0, #3
0336 C3              843 +1         clr     C
0337 13              844 +1         rrc     A
0338 D8FC            845 +1         djnz    R0, $-2;LL1
033A 6003            847            jz      U2_MB2C         ; |   ak neni zastavujem  
033C 020349          848            ljmp    UP2_MB1         ; |   inak nezastavim
033F D223            849    U2_MB2C:setb    SLOW            ;       Ak ano, spomalme
0341 C222            850            clr     FAST            ; 
0343 1208E9          851            lcall   WRITEPORTS      ;
0346 020349          852            jmp     UP2_MB1       ;-; a prejdi do stavu UP2_MB1 
0349                 853    UP2_MB1:
0349 12088E          854            lcall   READPORTS       ; nacitanie dat
                     855 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
034C 200B03          856 +1         jb      SKRH, $+6
034F 0207FA          857 +1         ljmp    ERR_SKRH
0352 00              858 +1         nop
                     860 +1         ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na spo
                                                                               malovaciu) <<<
0353 200A03          861 +1         jb      MB2, $+6
0356 0207DC          862 +1         ljmp    ERR_ZAST_C
0359 00              863 +1         nop
035A 2009EC          865            jb      MB1, UP2_MB1  ;-; Sme na zastavovacej clonke?
                     866            
                     867 +1         ZASTAV  3, U            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0)
                     868 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
VYTAH/ORI(*D
P©4P©4                                                                                          PAGE 17

                                                                               
035D C3              869 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
035E 7400            870 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
0360 7214            871 +1         orl     C, PI3U      ; | Mam v tomto smere stlacene tlacidlo v sachte?
0362 B00E            872 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
0364 7243            873 +1         orl     C, PKI3          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
0366 720F            874 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
0368 7238            875 +1         orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
036A 3400            876 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
036C C238            878            clr     STOPPED         ; Priznak STOPPED vynulujem, uz som ho osetril
036E 702E            879            jnz     U2_MB1C       ;-; Ak ano, zastav
                     880 +1         NAJVYSSIE               ; | ..a sme na najvyssom privolanom poschodi z kabiny? (poto
                                                                               m stojime urcite)
0370 E522            881 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
0372 33              882 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
0373 547E            883 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
0375 7805            884 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                     885 +1  ; LL1: 
0377 6006            886 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
0379 C3              887 +1         clr     C               ; Inak shiftnem o 2
037A 13              888 +1         rrc     A               ;
037B C3              889 +1         clr     C               ;
037C 13              890 +1         rrc     A               ;
037D D8F8            891 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                     892 +1 ; LL2:
037F 7405            893 +1         mov     A, #5           ; vysledne (najnizsie zvolene) poschodie je index v R0
0381 C3              894 +1         clr     C               ;
0382 98              895 +1         subb    A, R0           ;
                     897 +1         LCJNE   A, #3, UP3      ; |   ak nie, nezastavujeme  
0383 B40303          898 +1         cjne    A, #3, $+6
0386 02038C          899 +1         jmp     $+6
0389 0204B6          900 +1         ljmp    UP3
038C 00              901 +1         nop
                     903 +1         VYSSIE_KABINA 3         ; | ..ok, sme na najvyssom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
038D E528            904 +1         mov     A, INPORTA
038F 541E            905 +1         anl     A, #00011110b
0391 C3              906 +1         clr     C
0392 13              907 +1         rrc     A
                     908 +1 ;LL1    
0393 7803            909 +1         mov     R0, #3
0395 C3              910 +1         clr     C
0396 13              911 +1         rrc     A
0397 D8FC            912 +1         djnz    R0, $-2;LL1
0399 6003            914            jz      U2_MB1C         ; |   ak neni zastavujem  
039B 0204B6          915            ljmp    UP3             ; |   inak nezastavim
039E C220            916    U2_MB1C:clr     UP              ; zastav motor
VYTAH/ORI oDúP©4                                                                                              PAGE 18

03A0 D23A            917            setb    UPOld           ;       (a zalohuj)
03A2 C23B            918            clr     DOWNOld         ;       (a zalohuj)
03A4 C222            919            clr     FAST            ; 
03A6 1208E9          920            lcall   WRITEPORTS      ; 
03A9 02043A          921            jmp     FLOOR3        ;-; a prejdi do stavu FLOOR3
03AC                 922    DOWN2:
                     923 +1                 POLOHA_LED 2  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
03AC C22F            924 +1         clr     LEDU            
03AE C22E            925 +1         clr     LEDD 
03B0 C224            926 +1         clr     FLED1             
03B2 C225            927 +1         clr     FLED2                
03B4 C226            928 +1         clr     FLED3           
03B6 C227            929 +1         clr     FLED4           
03B8 D225            930 +1         setb    FLED2
03BA 1208E9          931 +1         lcall   WRITEPORTS
                     933 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
03BD 120815          934 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
03C0 12088E          935 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
03C3 3009FA          936 +1         jnb     MB1, $-3  ; 
03C6 120815          937 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
03C9 12088E          939            lcall   READPORTS       ; nacitanie dat
                     940 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
03CC 200C03          941 +1         jb      SKRD, $+6
03CF 0207EB          942 +1         ljmp    ERR_SKRD
03D2 00              943 +1         nop
                     945 +1         ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na z
                                                                               astavovaciu) <<<
03D3 200903          946 +1         jb      MB1, $+6
03D6 0207CD          947 +1         ljmp    ERR_2SPOM_C
03D9 00              948 +1         nop
03DA 200ACF          950            jb      MB2, DOWN2    ;-; mame uz 1. spomalovaciu clonku?
                     951 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme      
03DD 120815          952 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
03E0 12088E          953 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
03E3 300AFA          954 +1         jnb     MB2, $-3  ; 
03E6 120815          955 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
03E9 D22F            957            setb    LEDU            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
03EB 1208E9          958            lcall   WRITEPORTS      ;
03EE 0203F1          959            jmp     DOWN2_MB2     ;-; a prejdi do stavu DOWN2_MB2
03F1                 960    DOWN2_MB2:
03F1 12088E          961            lcall   READPORTS       ; nacitanie dat
                     962 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
03F4 200C03          963 +1         jb      SKRD, $+6
03F7 0207EB          964 +1         ljmp    ERR_SKRD
03FA 00              965 +1         nop
                     967 +1         ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na zas
                                                                               tavovaciu) <<<
03FB 200903          968 +1         jb      MB1, $+6
03FE 0207BE          969 +1         ljmp    ERR_1SPOM_C
0401 00              970 +1         nop
0402 200AEC          972            jb      MB2, DOWN2_MB2;-; mame uz aj druhu spomalovaciu clonku?          
0405 D22E            973            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame druhu MB2
0407 1208E9          974            lcall   WRITEPORTS      ;
                     975 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
040A 120815          976 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
VYTAH/ORI ]DžS©4                                                                                              PAGE 19

040D 12088E          977 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0410 300AFA          978 +1         jnb     MB2, $-3  ; 
0413 120815          979 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                     981    ;        mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
                     982    ;        anl     A, #00000010b ;-;
                     983    ;        jz      DOWN2_MB1     ;-;       Ak nie, chod do stavu DOWN2_MB1
0416 D223            984            setb    SLOW            ;       Ak ano, spomalme
0418 C222            985            clr     FAST            ; 
041A 1208E9          986            lcall   WRITEPORTS      ;
041D 020420          987            jmp     DOWN2_MB1     ;-; a prejdi do stavu DOWN2_MB1
0420                 988    DOWN2_MB1:    
0420 12088E          989            lcall   READPORTS       ; nacitanie dat
0423 300C05          990            jnb     SKRD, D2_MB1C   ; Sme na hornej porovnavacej clonke? (tu zastavujeme v kazdo
                                                                               m pripade)
0426 300902          991            jnb     MB1, D2_MB1C  ;-; Sme na zastavovacej clonke? (tu zastavujeme v kazdom pripa
                                                                               de)
0429 80F5            992            jmp     DOWN2_MB1       ; Ak sme nechytili ani jednu clonku, opakujeme
042B C238            993    D2_MB1C:clr     STOPPED         ; Priznak STOPPED vynulujem, uz som ho osetril
042D C221            994            clr     DOWN            ; zastav motor
042F D23B            995            setb    DOWNOld         ;       (a zalohuj)
0431 C23A            996            clr     UPOld           ;       (a zalohuj)
0433 C222            997            clr     FAST            ; 
0435 1208E9          998            lcall   WRITEPORTS      ; 
0438 01C9            999            jmp     FLOOR1        ;-; a prejdi do stavu FLOOR2      
                    1000    
                    1001    
                    1002    ;------------------------------------------------------------------------------- << 3. posch
                                                                               odie >>
                    1003    
043A                1004    FLOOR3:
                    1005 +1                 POLOHA_LED 3  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
043A C22F           1006 +1         clr     LEDU            
043C C22E           1007 +1         clr     LEDD 
043E C224           1008 +1         clr     FLED1             
0440 C225           1009 +1         clr     FLED2                
0442 C226           1010 +1         clr     FLED3           
0444 C227           1011 +1         clr     FLED4           
0446 D226           1012 +1         setb    FLED3
0448 1208E9         1013 +1         lcall   WRITEPORTS
044B 12084A         1015            lcall   WAITFORTIMER    ; simulacia TIMERu
044E 12088E         1016    F3S:    lcall   READPORTS     ;-; nacitanie dat
0451 C21B           1017            clr     PKO3          ;-; vynulovanie volby poschodia na ktorom stojim
0453 C22C           1018            clr     PO3U            ;
0455 C22B           1019            clr     PO3D            ;
0457 1208E9         1020            lcall   WRITEPORTS      ;
045A 200FF1         1021            jb      DPK, F3S        ; Mam pretazenu kabinu? (Ak ano, tak sa nepohnem)
045D 79F0           1022            mov     R1, #11110000b;-; Default predpokladam, ze mam namierene hore (na 3. a 4.) k
                                                                               abina
045F 7AE0           1023            mov     R2, #11100000b;-; Default predpokladam, ze mam namierene hore (na 3. a 4.) s
                                                                               achta
0461 203A06         1024            jb      UPOld, F3OK     ;   Je to pravda? Naozaj som doteraz isiel hore?
0464 E9             1025            mov     A, R1           ;       Ak nie, znegujeme masku kabiny
0465 F4             1026            cpl     A               ;       |
0466 F9             1027            mov     R1, A           ;       |
0467 EA             1028            mov     A, R2           ;       A znegujeme aj masku sachty
0468 F4             1029            cpl     A               ;       |
VYTAH/ORI 7DìS©4                                                                                              PAGE 20

0469 FA             1030            mov     R2, A           ;       |        
046A                1031    F3OK:   ; Pohyb v jednom smere (nevieme v ktorom)
046A E528           1032            mov     A, INPORTA      ; zistenie, ci bolo stlacene nieco viac (menej) ako poschodi
                                                                               e na ktorom stojim (Kabina)
046C 5416           1033            anl     A, #00010110b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
046E 59             1034            anl     A, R1           ;  | 
046F 7027           1035            jnz     F3              ; nasli sme poschodie v tomto smere, mozme ist
                    1036                                    ; zistenie, ci bolo stlacene nieco viac (menej) ako poschodi
                                                                               e na ktorom stojim (Sachta)
0471 E528           1037            mov     A, INPORTA      ; Mam v kabine nieco stlacene?
0473 5416           1038            anl     A, #00010110b   ;  | Beriem iba bity predstavujuce tlacidla poschodi (kabina
                                                                               )
0475 7007           1039            jnz     F3SW            ;  | Ak ano, idem rovno zistovat opacny smer.
0477 E522           1040            mov     A, INPORTC      ; Mam stlacene nieco v sachte (mojim smerom)?    
0479 5427           1041            anl     A, #00100111b   ;  | Beriem iba bity predstavujuce tlacidla privolavacov
047B 5A             1042            anl     A, R2           ;  |   
047C 701A           1043            jnz     F3              ; nasli sme poschodie v tomto smere, mozme ist
                    1044            ; Pohyb v opacnom smere (nevieme v ktorom)
047E B23A           1045    F3SW:   cpl     UPOld           ;  Znegujem stary posun
0480 B23B           1046            cpl     DOWNOld         ;  |
0482 E9             1047            mov     A, R1           ;  Znegujeme masky
0483 F4             1048            cpl     A               ;  |
0484 F9             1049            mov     R1, A           ;  |
0485 EA             1050            mov     A, R2           ;  |
0486 F4             1051            cpl     A               ;  |
0487 FA             1052            mov     R2, A           ;  |               
0488 E528           1053            mov     A, INPORTA      ; zistenie, cibolo stlacene nieco viac ako poschodie na ktor
                                                                               om stojim (Kabina)
048A 5416           1054            anl     A, #00010110b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
048C 59             1055            anl     A, R1           ;  | 
048D 7009           1056            jnz     F3              ; nasli sme poschodie v tomto smere, mozme ist
048F E522           1057            mov     A, INPORTC      ; zistenie, cibolo stlacene nieco viac ako poschodie na ktor
                                                                               om stojim (Sachta)
0491 5427           1058            anl     A, #00100111b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
0493 5A             1059            anl     A, R2           ;  | 
0494 7002           1060            jnz     F3              ; nasli sme poschodie v tomto smere, mozme ist
0496 80B6           1061            jmp     F3S           ;-; nemame sa kde hybat, tak opakujeme zistovanie
0498 203A03         1062    F3:     jb      UPOld, F3UP     ;   
049B 0204AA         1063            jmp     F3DOWN          ;
049E D220           1064    F3UP:   setb    UP              ; rychly pohyb hore
04A0 D222           1065            setb    FAST            ; 
04A2 C223           1066            clr     SLOW            ;
04A4 1208E9         1067            lcall   WRITEPORTS      ; 
04A7 0204B6         1068            jmp     UP3           ;-; prejdi do stavu UP2    
04AA D221           1069    F3DOWN: setb    DOWN            ; rychly pohyb hore
04AC D222           1070            setb    FAST            ; 
04AE C223           1071            clr     SLOW            ;
04B0 1208E9         1072            lcall   WRITEPORTS      ; 
04B3 020545         1073            jmp     DOWN3         ;-; prejdi do stavu UP2    
                    1074         
                    1075         
04B6                1076    UP3:
                    1077 +1                 POLOHA_LED 3  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
04B6 C22F           1078 +1         clr     LEDU            
04B8 C22E           1079 +1         clr     LEDD 
04BA C224           1080 +1         clr     FLED1             
04BC C225           1081 +1         clr     FLED2                
VYTAH/ORI D8T©4                                                                                              PAGE 21

04BE C226           1082 +1         clr     FLED3           
04C0 C227           1083 +1         clr     FLED4           
04C2 D226           1084 +1         setb    FLED3
04C4 1208E9         1085 +1         lcall   WRITEPORTS
                    1087 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
04C7 120815         1088 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
04CA 12088E         1089 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
04CD 3009FA         1090 +1         jnb     MB1, $-3  ; 
04D0 120815         1091 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
04D3 12088E         1093    UP3A:   lcall   READPORTS       ; nacitanie dat
                    1094 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
04D6 200B03         1095 +1         jb      SKRH, $+6
04D9 0207FA         1096 +1         ljmp    ERR_SKRH
04DC 00             1097 +1         nop
                    1099 +1         ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na z
                                                                               astavovaciu) <<<
04DD 200903         1100 +1         jb      MB1, $+6
04E0 0207CD         1101 +1         ljmp    ERR_2SPOM_C
04E3 00             1102 +1         nop
04E4 200AEC         1104            jb      MB2, UP3A     ;-; mame uz 1. spomalovaciu clonku?
                    1105 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
04E7 120815         1106 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
04EA 12088E         1107 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
04ED 300AFA         1108 +1         jnb     MB2, $-3  ; 
04F0 120815         1109 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
04F3 D22E           1111            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
04F5 1208E9         1112            lcall   WRITEPORTS      ;
04F8 0204FB         1113            jmp     UP3_MB2       ;-; a prejdi do stavu UP3_MB2
04FB                1114    UP3_MB2:
04FB 12088E         1115            lcall   READPORTS       ; nacitanie dat
                    1116 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
04FE 200B03         1117 +1         jb      SKRH, $+6
0501 0207FA         1118 +1         ljmp    ERR_SKRH
0504 00             1119 +1         nop
                    1121 +1         ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na zas
                                                                               tavovaciu) <<<
0505 200903         1122 +1         jb      MB1, $+6
0508 0207BE         1123 +1         ljmp    ERR_1SPOM_C
050B 00             1124 +1         nop
050C 200AEC         1126            jb      MB2, UP3_MB2  ;-; mame uz aj druhu spomalovaciu clonku?          
050F D22F           1127            setb    LEDU            ; Rozsviet LEDku, ze mame druhu MB2
0511 1208E9         1128            lcall   WRITEPORTS      ;
                    1129 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme 
0514 120815         1130 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0517 12088E         1131 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
051A 300AFA         1132 +1         jnb     MB2, $-3  ; 
051D 120815         1133 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                    1135    ;        mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
                    1136    ;        anl     A, #00010000b ;-;
                    1137    ;        jz      UP3_MB1       ;-;       Ak nie, chod do stavu UP3_MB1
0520 D223           1138            setb    SLOW            ;       Ak ano, spomalme
0522 C222           1139            clr     FAST            ; 
0524 1208E9         1140            lcall   WRITEPORTS      ;
0527 02052A         1141            jmp     UP3_MB1       ;-; a prejdi do stavu UP3_MB1 
052A                1142    UP3_MB1:
VYTAH/ORI zDV©4                                                                                              PAGE 22

052A 12088E         1143            lcall   READPORTS       ; nacitanie dat
052D 300B05         1144            jnb     SKRH, U3_MB1C  ;  Sme na hornej porovnavacej clonke? (tu zastavujeme v kazdo
                                                                               m pripade)
0530 300902         1145            jnb     MB1, U3_MB1C  ;-; Sme na zastavovacej clonke? (tu zastavujeme v kazdom pripa
                                                                               de)
0533 80F5           1146            jmp     UP3_MB1         ; Ak sme nechytili ani jednu clonku, opakujeme. 
0535 C238           1147    U3_MB1C:clr     STOPPED         ; Priznak STOPPED vynulujem, uz som ho osetril
0537 C220           1148            clr     UP              ; zastav motor
0539 D23A           1149            setb    UPOld           ;       (a zalohuj)
053B C23B           1150            clr     DOWNOld         ;       (a zalohuj)
053D C222           1151            clr     FAST            ; 
053F 1208E9         1152            lcall   WRITEPORTS      ; 
0542 020664         1153            jmp     FLOOR4        ;-; a prejdi do stavu FLOOR4   
0545                1154    DOWN3:
                    1155 +1                 POLOHA_LED 3  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
0545 C22F           1156 +1         clr     LEDU            
0547 C22E           1157 +1         clr     LEDD 
0549 C224           1158 +1         clr     FLED1             
054B C225           1159 +1         clr     FLED2                
054D C226           1160 +1         clr     FLED3           
054F C227           1161 +1         clr     FLED4           
0551 D226           1162 +1         setb    FLED3
0553 1208E9         1163 +1         lcall   WRITEPORTS
                    1165 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
0556 120815         1166 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0559 12088E         1167 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
055C 3009FA         1168 +1         jnb     MB1, $-3  ; 
055F 120815         1169 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0562 12088E         1171            lcall   READPORTS       ; nacitanie dat
                    1172 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
0565 200C03         1173 +1         jb      SKRD, $+6
0568 0207EB         1174 +1         ljmp    ERR_SKRD
056B 00             1175 +1         nop
                    1177 +1         ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na z
                                                                               astavovaciu) <<<
056C 200903         1178 +1         jb      MB1, $+6
056F 0207CD         1179 +1         ljmp    ERR_2SPOM_C
0572 00             1180 +1         nop
0573 200ACF         1182            jb      MB2, DOWN3    ;-; mame uz 1. spomalovaciu clonku?
                    1183 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme   
0576 120815         1184 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0579 12088E         1185 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
057C 300AFA         1186 +1         jnb     MB2, $-3  ; 
057F 120815         1187 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0582 D22F           1189            setb    LEDU            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
0584 1208E9         1190            lcall   WRITEPORTS      ;
0587 02058A         1191            jmp     DOWN3_MB2     ;-; a prejdi do stavu DOWN3_MB2
058A                1192    DOWN3_MB2:
058A 12088E         1193            lcall   READPORTS       ; nacitanie dat
                    1194 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
058D 200C03         1195 +1         jb      SKRD, $+6
0590 0207EB         1196 +1         ljmp    ERR_SKRD
0593 00             1197 +1         nop
                    1199 +1         ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na zas
                                                                               tavovaciu) <<<
VYTAH/ORIdDÚX©4àX©4                                                                                          PAGE 23

0594 200903         1200 +1         jb      MB1, $+6
0597 0207BE         1201 +1         ljmp    ERR_1SPOM_C
059A 00             1202 +1         nop
059B 200AEC         1204            jb      MB2, DOWN3_MB2;-; mame uz aj druhu spomalovaciu clonku?          
059E D22E           1205            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame druhu MB2
05A0 1208E9         1206            lcall   WRITEPORTS      ;
                    1207 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
05A3 120815         1208 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
05A6 12088E         1209 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
05A9 300AFA         1210 +1         jnb     MB2, $-3  ; 
05AC 120815         1211 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                    1213    ;        mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
                    1214    ;        anl     A, #00000100b ;-;
                    1215    ;        jz      DOWN3_MB1     ;-;       Ak nie, chod do stavu DOWN3_MB1
                    1216 +1         ZASTAV  2, D            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0)
                    1217 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
05AF C3             1218 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
05B0 7400           1219 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
05B2 7211           1220 +1         orl     C, PI2D      ; | Mam v tomto smere stlacene tlacidlo v sachte?
05B4 B00E           1221 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
05B6 7242           1222 +1         orl     C, PKI2          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
05B8 720F           1223 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
05BA 7238           1224 +1         orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
05BC 3400           1225 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
05BE 7033           1227            jnz     D3_MB2C         ; Ak ano, zastav
                    1228 +1         NAJNIZSIE               ; | ..a sme na najnizsom privolanom poschodi z kabiny? (poto
                                                                               m stojime urcite)
05C0 E522           1229 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
05C2 33             1230 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
05C3 547E           1231 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
05C5 7805           1232 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                    1233 +1  ; LL1: 
05C7 6006           1234 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
05C9 C3             1235 +1         clr     C               ; Inak shiftnem o 2
05CA 33             1236 +1         rlc     A               ;
05CB C3             1237 +1         clr     C               ;
05CC 33             1238 +1         rlc     A               ;
05CD D8F8           1239 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                    1240 +1 ; LL2:
05CF E8             1241 +1         mov     A, R0           ; vysledne (najnizsie zvolene) poschodie je index v R0
                    1243 +1         LCJNE   A, #2, DOWN3_MB1; |   ak nie, nezastavujeme  
05D0 B40203         1244 +1         cjne    A, #2, $+6
05D3 0205D9         1245 +1         jmp     $+6
05D6 0205FD         1246 +1         ljmp    DOWN3_MB1
05D9 00             1247 +1         nop
VYTAH/ORI'DzZ©4                                                                                              PAGE 24

                    1249 +1         NIZSIE_KABINA 2         ; | ..ok, sme na najnizsom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
05DA 7405           1250 +1         mov     A, #5
05DC C3             1251 +1         clr     C
05DD 9402           1252 +1         subb    A, #2
05DF F8             1253 +1         mov     R0, A
05E0 E528           1254 +1         mov     A, INPORTA
05E2 541E           1255 +1         anl     A, #00011110b
05E4 C3             1256 +1         clr     C
05E5 33             1257 +1         rlc     A
05E6 C3             1258 +1         clr     C
05E7 33             1259 +1         rlc     A
05E8 C3             1260 +1         clr     C
05E9 33             1261 +1         rlc     A
                    1262 +1 ;LL1   
05EA C3             1263 +1         clr     C
05EB 33             1264 +1         rlc     A
05EC D8FC           1265 +1         djnz    R0, $-2;LL1
05EE 6003           1267            jz      D3_MB2C         ; |   ak neni zastavujem                  
05F0 0205FD         1268            ljmp    DOWN3_MB1       ;-; |        
05F3 D223           1269    D3_MB2C:setb    SLOW            ;       Ak ano, spomalme
05F5 C222           1270            clr     FAST            ; 
05F7 1208E9         1271            lcall   WRITEPORTS      ;
05FA 0205FD         1272            jmp     DOWN3_MB1     ;-; a prejdi do stavu DOWN3_MB1
05FD                1273    DOWN3_MB1:    
05FD 12088E         1274            lcall   READPORTS       ; nacitanie dat
                    1275 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
0600 200C03         1276 +1         jb      SKRD, $+6
0603 0207EB         1277 +1         ljmp    ERR_SKRD
0606 00             1278 +1         nop
                    1280 +1         ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na spo
                                                                               malovaciu) <<<
0607 200A03         1281 +1         jb      MB2, $+6
060A 0207DC         1282 +1         ljmp    ERR_ZAST_C
060D 00             1283 +1         nop
060E 2009EC         1285            jb      MB1, DOWN3_MB1;-; Sme na zastavovacej clonke?
                    1286 +1         ZASTAV  2, D            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0)
                    1287 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
0611 C3             1288 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
0612 7400           1289 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
0614 7211           1290 +1         orl     C, PI2D      ; | Mam v tomto smere stlacene tlacidlo v sachte?
0616 B00E           1291 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
0618 7242           1292 +1         orl     C, PKI2          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
061A 720F           1293 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
061C 7238           1294 +1         orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
061E 3400           1295 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
0620 C238           1297            clr     STOPPED         ; Priznak STOPPED vynulujem, uz som ho osetril
0622 7033           1298            jnz     D3_MB1C         ; Ak ano, zastav
                    1299 +1         NAJNIZSIE               ; | ..a sme na najnizsom privolanom poschodi z kabiny? (poto
                                                                               m stojime urcite)
VYTAH/ORI sD                                                                                                  PAGE 25

0624 E522           1300 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
0626 33             1301 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
0627 547E           1302 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
0629 7805           1303 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                    1304 +1  ; LL1: 
062B 6006           1305 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
062D C3             1306 +1         clr     C               ; Inak shiftnem o 2
062E 33             1307 +1         rlc     A               ;
062F C3             1308 +1         clr     C               ;
0630 33             1309 +1         rlc     A               ;
0631 D8F8           1310 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                    1311 +1 ; LL2:
0633 E8             1312 +1         mov     A, R0           ; vysledne (najnizsie zvolene) poschodie je index v R0
                    1314 +1         LCJNE   A, #2, DOWN2    ; |   ak nie, nezastavujeme  
0634 B40203         1315 +1         cjne    A, #2, $+6
0637 02063D         1316 +1         jmp     $+6
063A 0203AC         1317 +1         ljmp    DOWN2
063D 00             1318 +1         nop
                    1320 +1         NIZSIE_KABINA 2         ; | ..ok, sme na najnizsom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
063E 7405           1321 +1         mov     A, #5
0640 C3             1322 +1         clr     C
0641 9402           1323 +1         subb    A, #2
0643 F8             1324 +1         mov     R0, A
0644 E528           1325 +1         mov     A, INPORTA
0646 541E           1326 +1         anl     A, #00011110b
0648 C3             1327 +1         clr     C
0649 33             1328 +1         rlc     A
064A C3             1329 +1         clr     C
064B 33             1330 +1         rlc     A
064C C3             1331 +1         clr     C
064D 33             1332 +1         rlc     A
                    1333 +1 ;LL1   
064E C3             1334 +1         clr     C
064F 33             1335 +1         rlc     A
0650 D8FC           1336 +1         djnz    R0, $-2;LL1
0652 6003           1338            jz      D3_MB1C         ; |   ak neni zastavujem                  
0654 0203AC         1339            ljmp    DOWN2         ;-; |        
0657 C221           1340    D3_MB1C:clr     DOWN            ; zastav motor
0659 D23B           1341            setb    DOWNOld         ;       (a zalohuj)
065B C23A           1342            clr     UPOld           ;       (a zalohuj)
065D C222           1343            clr     FAST            ; 
065F 1208E9         1344            lcall   WRITEPORTS      ; 
0662 411A           1345            jmp     FLOOR2        ;-; a prejdi do stavu FLOOR2      
                    1346          
                    1347            
                    1348    ;------------------------------------------------------------------------------- << 4. posch
                                                                               odie >>
                    1349    
0664                1350    FLOOR4:
                    1351 +1                 POLOHA_LED 4  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
VYTAH/ORI 3D¼\©4                                                                                              PAGE 26

0664 C22F           1352 +1         clr     LEDU            
0666 C22E           1353 +1         clr     LEDD 
0668 C224           1354 +1         clr     FLED1             
066A C225           1355 +1         clr     FLED2                
066C C226           1356 +1         clr     FLED3           
066E C227           1357 +1         clr     FLED4           
0670 D227           1358 +1         setb    FLED4
0672 1208E9         1359 +1         lcall   WRITEPORTS
0675 12084A         1361            lcall   WAITFORTIMER    ; simulacia TIMERu
0678 12088E         1362    F4S:    lcall   READPORTS     ;-; nacitanie dat
067B C21C           1363            clr     PKO4          ;-; vynulovanie volby poschodia na ktorom stojim
067D C22D           1364            clr     PO4            ;
067F 1208E9         1365            lcall   WRITEPORTS      ;
0682 200FF3         1366            jb      DPK, F4S        ; Mam pretazenu kabinu? (Ak ano, tak sa nepohnem)
0685 E528           1367            mov     A, INPORTA      ; zistenie, ci bolo stlacene nieco menej ako poschodie na kt
                                                                               orom stojim (Kabina)
0687 540E           1368            anl     A, #00001110b ;-;
0689 7008           1369            jnz     F4OK          ;-; ak ano, ideme na to
068B E522           1370            mov     A, INPORTC      ; zistenie, ci bolo stlacene nieco menej ako poschodie na kt
                                                                               orom stojim (Sachta)
068D 541F           1371            anl     A, #00011111b ;-;
068F 7002           1372            jnz     F4OK          ;-; ak ano, ideme na to
0691 80E5           1373            jmp     F4S             ; Nemam sa kde hnut, opakujem
0693 D221           1374    F4OK:   setb    DOWN            ; rychly pohyb dole
0695 D222           1375            setb    FAST            ;
0697 C223           1376            clr     SLOW            ; 
0699 1208E9         1377            lcall   WRITEPORTS      ; 
069C 02069F         1378            jmp     DOWN4         ;-; prejdi do stavu DOWN4 
069F                1379    DOWN4:
                    1380 +1                 POLOHA_LED 4  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
069F C22F           1381 +1         clr     LEDU            
06A1 C22E           1382 +1         clr     LEDD 
06A3 C224           1383 +1         clr     FLED1             
06A5 C225           1384 +1         clr     FLED2                
06A7 C226           1385 +1         clr     FLED3           
06A9 C227           1386 +1         clr     FLED4           
06AB D227           1387 +1         setb    FLED4
06AD 1208E9         1388 +1         lcall   WRITEPORTS
                    1390 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
06B0 120815         1391 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
06B3 12088E         1392 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
06B6 3009FA         1393 +1         jnb     MB1, $-3  ; 
06B9 120815         1394 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
06BC 12088E         1396            lcall   READPORTS       ; nacitanie dat
                    1397 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
06BF 200C03         1398 +1         jb      SKRD, $+6
06C2 0207EB         1399 +1         ljmp    ERR_SKRD
06C5 00             1400 +1         nop
                    1402 +1         ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na z
                                                                               astavovaciu) <<<
06C6 200903         1403 +1         jb      MB1, $+6
06C9 0207CD         1404 +1         ljmp    ERR_2SPOM_C
06CC 00             1405 +1         nop
06CD 200ACF         1407            jb      MB2, DOWN4    ;-; mame uz 1. spomalovaciu clonku?
                    1408 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme      
06D0 120815         1409 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
VYTAH/ORI #DZ^©4                                                                                              PAGE 27

06D3 12088E         1410 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
06D6 300AFA         1411 +1         jnb     MB2, $-3  ; 
06D9 120815         1412 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
06DC D22F           1414            setb    LEDU            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
06DE 1208E9         1415            lcall   WRITEPORTS      ;
06E1 0206E4         1416            jmp     DOWN4_MB2     ;-; a prejdi do stavu DOWN4_MB2
06E4                1417    DOWN4_MB2:
06E4 12088E         1418            lcall   READPORTS       ; nacitanie dat
                    1419 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
06E7 200C03         1420 +1         jb      SKRD, $+6
06EA 0207EB         1421 +1         ljmp    ERR_SKRD
06ED 00             1422 +1         nop
                    1424 +1         ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na zas
                                                                               tavovaciu) <<<
06EE 200903         1425 +1         jb      MB1, $+6
06F1 0207BE         1426 +1         ljmp    ERR_1SPOM_C
06F4 00             1427 +1         nop
06F5 200AEC         1429            jb      MB2, DOWN4_MB2;-; mame uz aj druhu spomalovaciu clonku?          
06F8 D22E           1430            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame druhu MB2
06FA 1208E9         1431            lcall   WRITEPORTS      ;
                    1432 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
06FD 120815         1433 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (xe som na clonke)
0700 12088E         1434 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0703 300AFA         1435 +1         jnb     MB2, $-3  ; 
0706 120815         1436 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                    1438    ;        mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
                    1439    ;        anl     A, #00001000b ;-;
                    1440    ;        jz      DOWN4_MB1     ;-;       Ak nie, chod do stavu DOWN4_MB1
                    1441 +1         ZASTAV  3, D            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0) 
                    1442 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
0709 C3             1443 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
070A 7400           1444 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
070C 7213           1445 +1         orl     C, PI3D      ; | Mam v tomto smere stlacene tlacidlo v sachte?
070E B00E           1446 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
0710 7243           1447 +1         orl     C, PKI3          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
0712 720F           1448 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
0714 7238           1449 +1         orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
0716 3400           1450 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
0718 7033           1452            jnz     D4_MB2C       ;-; Ak ano, zastav
                    1453 +1         NAJNIZSIE               ; | ..a sme na najnizsom privolanom poschodi z kabiny? (poto
                                                                               m stojime urcite)
071A E522           1454 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
071C 33             1455 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
071D 547E           1456 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
071F 7805           1457 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
VYTAH/ORInD                                                                                                  PAGE 28

                    1458 +1  ; LL1: 
0721 6006           1459 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
0723 C3             1460 +1         clr     C               ; Inak shiftnem o 2
0724 33             1461 +1         rlc     A               ;
0725 C3             1462 +1         clr     C               ;
0726 33             1463 +1         rlc     A               ;
0727 D8F8           1464 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                    1465 +1 ; LL2:
0729 E8             1466 +1         mov     A, R0           ; vysledne (najnizsie zvolene) poschodie je index v R0
                    1468 +1         LCJNE   A, #3, DOWN4_MB1; |   ak nie, nezastavujeme  
072A B40303         1469 +1         cjne    A, #3, $+6
072D 020733         1470 +1         jmp     $+6
0730 020757         1471 +1         ljmp    DOWN4_MB1
0733 00             1472 +1         nop
                    1474 +1         NIZSIE_KABINA 3         ; | ..ok, sme na najnizsom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
0734 7405           1475 +1         mov     A, #5
0736 C3             1476 +1         clr     C
0737 9403           1477 +1         subb    A, #3
0739 F8             1478 +1         mov     R0, A
073A E528           1479 +1         mov     A, INPORTA
073C 541E           1480 +1         anl     A, #00011110b
073E C3             1481 +1         clr     C
073F 33             1482 +1         rlc     A
0740 C3             1483 +1         clr     C
0741 33             1484 +1         rlc     A
0742 C3             1485 +1         clr     C
0743 33             1486 +1         rlc     A
                    1487 +1 ;LL1   
0744 C3             1488 +1         clr     C
0745 33             1489 +1         rlc     A
0746 D8FC           1490 +1         djnz    R0, $-2;LL1
0748 6003           1492            jz      D4_MB2C         ; |   ak neni zastavujem          
074A 020757         1493            ljmp    DOWN4_MB1       ;-; |       
074D D223           1494    D4_MB2C:setb    SLOW            ;       Ak ano, spomalme
074F C222           1495            clr     FAST            ; 
0751 1208E9         1496            lcall   WRITEPORTS      ;
0754 020757         1497            jmp     DOWN4_MB1     ;-; a prejdi do stavu DOWN4_MB1
0757                1498    DOWN4_MB1:    
0757 12088E         1499            lcall   READPORTS       ; nacitanie dat
                    1500 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
075A 200C03         1501 +1         jb      SKRD, $+6
075D 0207EB         1502 +1         ljmp    ERR_SKRD
0760 00             1503 +1         nop
                    1505 +1         ljnb    MB2, ERR_ZAST_C; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na spom
                                                                               alovaciu) <<<
0761 200A03         1506 +1         jb      MB2, $+6
0764 0207DC         1507 +1         ljmp    ERR_ZAST_C
0767 00             1508 +1         nop
0768 2009EC         1510            jb      MB1, DOWN4_MB1 ;-; Sme na zastavovacej clonke?
                    1511 +1         ZASTAV  3, D            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0)
                    1512 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
076B C3             1513 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
076C 7400           1514 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
VYTAH/ORI=Dè)©4ì)©4                                                                                          PAGE 29

076E 7213           1515 +1         orl     C, PI3D      ; | Mam v tomto smere stlacene tlacidlo v sachte?
0770 B00E           1516 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
0772 7243           1517 +1         orl     C, PKI3          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
0774 720F           1518 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
0776 7238           1519 +1         orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
0778 3400           1520 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
077A C238           1522            clr     STOPPED         ; Priznak STOPPED vynulujem, uz som ho osetril 
077C 7033           1523            jnz     D4_MB1C       ;-; Ak ano, zastav
                    1524 +1         NAJNIZSIE               ; | ..a sme na najnizsom privolanom poschodi z kabiny? (poto
                                                                               m stojime urcite)
077E E522           1525 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
0780 33             1526 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
0781 547E           1527 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
0783 7805           1528 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                    1529 +1  ; LL1: 
0785 6006           1530 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
0787 C3             1531 +1         clr     C               ; Inak shiftnem o 2
0788 33             1532 +1         rlc     A               ;
0789 C3             1533 +1         clr     C               ;
078A 33             1534 +1         rlc     A               ;
078B D8F8           1535 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                    1536 +1 ; LL2:
078D E8             1537 +1         mov     A, R0           ; vysledne (najnizsie zvolene) poschodie je index v R0
                    1539 +1         LCJNE   A, #3, DOWN3    ; |   ak nie, nezastavujeme  
078E B40303         1540 +1         cjne    A, #3, $+6
0791 020797         1541 +1         jmp     $+6
0794 020545         1542 +1         ljmp    DOWN3
0797 00             1543 +1         nop
                    1545 +1         NIZSIE_KABINA 3         ; | ..ok, sme na najnizsom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
0798 7405           1546 +1         mov     A, #5
079A C3             1547 +1         clr     C
079B 9403           1548 +1         subb    A, #3
079D F8             1549 +1         mov     R0, A
079E E528           1550 +1         mov     A, INPORTA
07A0 541E           1551 +1         anl     A, #00011110b
07A2 C3             1552 +1         clr     C
07A3 33             1553 +1         rlc     A
07A4 C3             1554 +1         clr     C
07A5 33             1555 +1         rlc     A
07A6 C3             1556 +1         clr     C
07A7 33             1557 +1         rlc     A
                    1558 +1 ;LL1   
07A8 C3             1559 +1         clr     C
07A9 33             1560 +1         rlc     A
07AA D8FC           1561 +1         djnz    R0, $-2;LL1
07AC 6003           1563            jz      D4_MB1C         ; |   ak neni zastavujem          
VYTAH/ORI~Dr+©4                                                                                              PAGE 30

07AE 020545         1564            ljmp    DOWN3         ;-; |       
07B1 C221           1565    D4_MB1C:clr     DOWN            ; zastav motor
07B3 D23B           1566            setb    DOWNOld         ;       (a zalohuj)
07B5 C23A           1567            clr     UPOld           ;       (a zalohuj)
07B7 C222           1568            clr     FAST            ; 
07B9 1208E9         1569            lcall   WRITEPORTS      ; 
07BC 813A           1570            jmp     FLOOR3        ;-; a prejdi do stavu FLOOR3                 
                    1571                    
                    1572      
07BE                1573    ERR_1SPOM_C: 
07BE C220           1574            clr     UP              ; zastav motor
07C0 C221           1575            clr     DOWN            ; 
07C2 1208E9         1576            lcall   WRITEPORTS      ; 
                    1577 +1         _BP_
07C5 C2B3           1578 +1         clr     P3.3
07C7 D2AA           1579 +1         setb    EX1
07C9 00             1580 +1         nop
07CA 00             1581 +1         nop
07CB 00             1583            nop
07CC 00             1584            nop 
                    1585            
07CD                1586    ERR_2SPOM_C: 
07CD C220           1587            clr     UP              ; zastav motor
07CF C221           1588            clr     DOWN            ; 
07D1 1208E9         1589            lcall   WRITEPORTS      ; 
                    1590 +1         _BP_
07D4 C2B3           1591 +1         clr     P3.3
07D6 D2AA           1592 +1         setb    EX1
07D8 00             1593 +1         nop
07D9 00             1594 +1         nop
07DA 00             1596            nop
07DB 00             1597            nop 
                    1598            
07DC                1599    ERR_ZAST_C: 
07DC C220           1600            clr     UP              ; zastav motor
07DE C221           1601            clr     DOWN            ; 
07E0 1208E9         1602            lcall   WRITEPORTS      ; 
                    1603 +1         _BP_
07E3 C2B3           1604 +1         clr     P3.3
07E5 D2AA           1605 +1         setb    EX1
07E7 00             1606 +1         nop
07E8 00             1607 +1         nop
07E9 00             1609            nop
07EA 00             1610            nop 
                    1611            
07EB                1612    ERR_SKRD: 
07EB C220           1613            clr     UP              ; zastav motor
07ED C221           1614            clr     DOWN            ; 
07EF 1208E9         1615            lcall   WRITEPORTS      ; 
                    1616 +1         _BP_
07F2 C2B3           1617 +1         clr     P3.3
07F4 D2AA           1618 +1         setb    EX1
07F6 00             1619 +1         nop
07F7 00             1620 +1         nop
07F8 00             1622            nop
07F9 00             1623            nop    
                    1624            
07FA                1625    ERR_SKRH: 
VYTAH/ORI ID                                                                                                  PAGE 31

07FA C220           1626            clr     UP              ; zastav motor
07FC C221           1627            clr     DOWN            ; 
07FE 1208E9         1628            lcall   WRITEPORTS      ; 
                    1629 +1         _BP_
0801 C2B3           1630 +1         clr     P3.3
0803 D2AA           1631 +1         setb    EX1
0805 00             1632 +1         nop
0806 00             1633 +1         nop
0807 00             1635            nop
0808 00             1636            nop             
                    1637                    
                    1638                    
0809                1639    ENDPROG:
0809 D218           1640            setb    KS
080B 1208E9         1641            call    WRITEPORTS                ; zapis novu informaciu
                    1642 +1         _BP_
080E C2B3           1643 +1         clr     P3.3
0810 D2AA           1644 +1         setb    EX1
0812 00             1645 +1         nop
0813 00             1646 +1         nop
0814 22             1648            ret
                    1649            
                    1650    ; rutina time delay 1 ms pre oscilator s frekvenciou 11.0592 MHz
                    1651    ; 1 instrukcia 2 takty? => 11.0592/2 = pocet instrukcii potrebnych na 1 sekundu
                    1652    ; 11.0592MHz/2000 = zdrzanie 1 ms
0815                1653    TIME10MS:
0815 7963           1654            mov     R1,#063h        ; 2
                    1655                                    ; *** 100x
0817 7AFF           1656    TIME0:  mov     R2,#0FFh        ; 2 
0819 DAFE           1657    TIME1:  djnz    R2,TIME1        ; 256*2   
081B 7AFF           1658            mov     R2,#0FFh        ; 2       
081D DAFE           1659    TIME2:  djnz    R2,TIME2        ; 256*2 
081F 7A24           1660            mov     R2,#024h        ; 2       
0821 DAFE           1661    TIME3:  djnz    R2,TIME3        ; 36*2
0823 00             1662            nop                     ; 1
0824 D9F1           1663            djnz    R1,TIME0        ; 2
                    1664                                    ; ***
0826 792A           1665            mov     R1,#02Ah        ; 2 
0828 D9FE           1666    TIME4:  djnz    R1,TIME4        ; 43*2  
082A 22             1667            ret                     ; koniec
                    1668            
                    1669            
                    1670    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    1671    ; STOP
                    1672    ; osetri stlacenie tlacidla STOP
                    1673    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
082B                1674    STOP:
082B D238           1675            setb    STOPPED
082D C222           1676            clr     FAST
082F C223           1677            clr     SLOW
0831 74E1           1678            mov     A, #11100001b
0833 5223           1679            anl     OUTPORTA, A 
0835 1208E9         1680            lcall   WRITEPORTS
                    1681            
0838 12084A         1682            lcall   WAITFORTIMER
083B 120852         1683    STOPC:  lcall   READPORTS1
083E E528           1684            mov     A, INPORTA
0840 541E           1685            anl     A, #00011110b
VYTAH/ORID                                                                                                  PAGE 32

0842 60F7           1686            jz      STOPC     
                    1687            
0844 D223           1688            setb    SLOW
0846 1208E9         1689            lcall   WRITEPORTS
0849 22             1690            ret        
                    1691            
                    1692            
                    1693    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    1694    ; DELAY
                    1695    ; Pocka na stlacenie tlacidla na 1. poschodi  - signal PO1 (v buducnosti to 
                    1696    ; bude timer)
                    1697    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
084A                1698    WAITFORTIMER:
084A 7B10           1699            mov     R3, #10h
084C 120815         1700    DEL1:   lcall   TIME10MS
084F DBFB           1701            djnz    R3, DEL1
0851 22             1702            ret
                    1703            
                    1704    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    1705    ; READPORTS1
                    1706    ; precita nove hodnoty na portoch
                    1707    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0852                1708    READPORTS1:
0852 75A080         1709            mov     p2, #i8255INA       ; citaj data z portu A
0855 75803F         1710            mov     p0, #(bmSTOP or bmPKI1 or bmPKI2 or bmPKI3 or bmPKI4 or bmDOORCLSD)
0858 C2B7           1711            clr     RDNOT
085A 00             1712            nop
085B 00             1713            nop
085C 00             1714            nop
085D 00             1715            nop
085E 858028         1716            mov     INPORTA, p0         ; uloz informaciu z datovej zbernice 
0861 D2B7           1717            setb    RDNOT
                    1718            
0863 75A081         1719            mov     p2, #i8255INB       ; citaj data z portu B
0866 7580FE         1720            mov     p0, #(bmMB1I or bmMB2I or bmSKRHI or bmSKRHD or bmDPI or bmDPKI or bmDPZKI)
                                                                               
0869 C2B7           1721            clr     RDNOT
086B 00             1722            nop
086C 00             1723            nop
086D 00             1724            nop
086E 00             1725            nop
086F 858021         1726            mov     INPORTB, p0         ; uloz informaciu z datovej zbernice 
0872 D2B7           1727            setb    RDNOT
                    1728    
0874 75A082         1729            mov     p2, #i8255INC       ; citaj data z portu C
0877 75803F         1730            mov     p0, #(bmPI1 or bmPI2D or bmPI2U or bmPI3D or bmPI3U or bmPI4)
087A C2B7           1731            clr     RDNOT
087C 00             1732            nop
087D 00             1733            nop
087E 00             1734            nop
087F 00             1735            nop
0880 858022         1736            mov     INPORTC, p0         ; uloz informaciu z datovej zbernice 
0883 D2B7           1737            setb    RDNOT
0885 00             1738            nop
0886 00             1739            nop
0887 00             1740            nop
0888 00             1741            nop
0889 00             1742            nop
VYTAH/ORIXD                                                                                                  PAGE 33

088A 00             1743            nop
088B 00             1744            nop
088C 00             1745            nop
088D 22             1746            ret
                    1747    
                    1748    
                    1749    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    1750    ; READPORTS
                    1751    ; precita nove hodnoty na portoch
                    1752    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
088E                1753    READPORTS:
088E 75A080         1754            mov     p2, #i8255INA       ; citaj data z portu A
0891 75803F         1755            mov     p0, #(bmSTOP or bmPKI1 or bmPKI2 or bmPKI3 or bmPKI4 or bmDOORCLSD)
0894 C2B7           1756            clr     RDNOT
0896 00             1757            nop
0897 00             1758            nop
0898 00             1759            nop
0899 00             1760            nop
089A 858028         1761            mov     INPORTA, p0         ; uloz informaciu z datovej zbernice 
089D D2B7           1762            setb    RDNOT
                    1763            
089F 75A081         1764            mov     p2, #i8255INB       ; citaj data z portu B
08A2 7580FE         1765            mov     p0, #(bmMB1I or bmMB2I or bmSKRHI or bmSKRHD or bmDPI or bmDPKI or bmDPZKI)
                                                                               
08A5 C2B7           1766            clr     RDNOT
08A7 00             1767            nop
08A8 00             1768            nop
08A9 00             1769            nop
08AA 00             1770            nop
08AB 858021         1771            mov     INPORTB, p0         ; uloz informaciu z datovej zbernice 
08AE D2B7           1772            setb    RDNOT
                    1773    
08B0 75A082         1774            mov     p2, #i8255INC       ; citaj data z portu C
08B3 75803F         1775            mov     p0, #(bmPI1 or bmPI2D or bmPI2U or bmPI3D or bmPI3U or bmPI4)
08B6 C2B7           1776            clr     RDNOT
08B8 00             1777            nop
08B9 00             1778            nop
08BA 00             1779            nop
08BB 00             1780            nop
08BC 858022         1781            mov     INPORTC, p0         ; uloz informaciu z datovej zbernice 
08BF D2B7           1782            setb    RDNOT
08C1 00             1783            nop
08C2 00             1784            nop
08C3 00             1785            nop
08C4 00             1786            nop
08C5 00             1787            nop
08C6 00             1788            nop
08C7 00             1789            nop
08C8 00             1790            nop
                    1791            
08C9 300F04         1792            jnb     DPK, READPORTS_C1
08CC C222           1793            clr     FAST
08CE D223           1794            setb    SLOW
08D0                1795    READPORTS_C1:         
08D0 204003         1796            jb      STOPNOT, READPORTS_C
08D3 12082B         1797            lcall   STOP
08D6                1798    READPORTS_C:        
08D6 E528           1799            mov     A, INPORTA
VYTAH/ORI'D                                                                                                  PAGE 34

08D8 541E           1800            anl     A, #00011110b
08DA 4223           1801            orl     OUTPORTA, A
08DC 1208E9         1802            call    WRITEPORTS              ; aktualizuj signalizaciu na ovladacom paneli
08DF E522           1803            mov     A, INPORTC
08E1 543F           1804            anl     A, #00111111b
08E3 4225           1805            orl     OUTPORTC, A
08E5 1208E9         1806            call    WRITEPORTS              ; aktualizuj signalizaciu na ovladacom paneli
                    1807            
08E8 22             1808            ret
                    1809            
                    1810    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    1811    ; WRITEPORTS
                    1812    ; spravi zalohu vystupnych registrov a posle data von
                    1813    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
08E9                1814    WRITEPORTS:
08E9 852380         1815            mov     p0, OUTPORTA        ; teraz postupne posli data najprv na port A,
08EC 75A0C0         1816            mov     p2, #i8255OUTA
08EF C2B6           1817            clr     WRNOT
08F1 00             1818            nop
08F2 00             1819            nop
08F3 00             1820            nop
08F4 00             1821            nop
08F5 D2B6           1822            setb    WRNOT
                    1823            
08F7 852480         1824            mov     p0, OUTPORTB        ; potom port B
08FA 75A0C1         1825            mov     p2, #i8255OUTB
08FD C2B6           1826            clr     WRNOT
08FF 00             1827            nop
0900 00             1828            nop
0901 00             1829            nop
0902 00             1830            nop
0903 D2B6           1831            setb    WRNOT
                    1832    
0905 852580         1833            mov     p0, OUTPORTC        ; a nakoniec port C
0908 75A0C2         1834            mov     p2, #i8255OUTC
090B C2B6           1835            clr     WRNOT
090D 00             1836            nop
090E 00             1837            nop
090F 00             1838            nop
0910 00             1839            nop
0911 D2B6           1840            setb    WRNOT
0913 00             1841            nop
0914 00             1842            nop
0915 00             1843            nop
0916 00             1844            nop
0917 00             1845            nop
0918 00             1846            nop
0919 00             1847            nop
091A 00             1848            nop
091B 22             1849            ret
                    1850    
                    1851    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    1852    
091C 0D0A5269       1853    STR_INIT:   db  0dh, 0ah, 'Riadiaci system je inicializovany.', 0dh, 0ah, 00h
0920 61646961   
0924 63692073   
0928 79737465   
092C 6D206A65   
VYTAH/ORID                                                                                                  PAGE 35

0930 20696E69   
0934 6369616C   
0938 697A6F76   
093C 616E792E   
0940 0D0A00     
0943 52696164       1854    STR_STOP:   db  'Riadiaci system je reinicializovany po stlaceni tlacidla STOP.', 0dh, 0ah, 
                                                                               00h
0947 69616369   
094B 20737973   
094F 74656D20   
0953 6A652072   
0957 65696E69   
095B 6369616C   
095F 697A6F76   
0963 616E7920   
0967 706F2073   
096B 746C6163   
096F 656E6920   
0973 746C6163   
0977 69646C61   
097B 2053544F   
097F 502E0D0A   
0983 00         
0984 4B616C69       1855    STR_CALIB:  db  'Kalibracia vytahu je ukoncena.', 0dh, 0ah, 00h
0988 62726163   
098C 69612076   
0990 79746168   
0994 75206A65   
0998 20756B6F   
099C 6E63656E   
09A0 612E0D0A   
09A4 00         
                    1856    
----                1857            DSEG
0040                1858            org     40h
0040                1859    STACK:  DS      10h
                    1860    
                    1861    end

VERSION 1.2h ASSEMBLY COMPLETE, 0 ERRORS FOUND
VYTAH/ORI                                                                                                     PAGE 36

BMDOORCLSD . . . . . . . . . . .    NUMB  0020H  
BMDOWN . . . . . . . . . . . . .    NUMB  0002H  NOT USED  
BMDPI. . . . . . . . . . . . . .    NUMB  0020H  
BMDPKI . . . . . . . . . . . . .    NUMB  0080H  
BMDPZKI. . . . . . . . . . . . .    NUMB  0040H  
BMFAST . . . . . . . . . . . . .    NUMB  0004H  NOT USED  
BMFLED1. . . . . . . . . . . . .    NUMB  0010H  
BMFLED2. . . . . . . . . . . . .    NUMB  0020H  
BMFLED3. . . . . . . . . . . . .    NUMB  0040H  
BMFLED4. . . . . . . . . . . . .    NUMB  0080H  
BMKS . . . . . . . . . . . . . .    NUMB  0001H  NOT USED  
BMLEDD . . . . . . . . . . . . .    NUMB  0040H  
BMLEDU . . . . . . . . . . . . .    NUMB  0080H  
BMMB1I . . . . . . . . . . . . .    NUMB  0002H  
BMMB2I . . . . . . . . . . . . .    NUMB  0004H  
BMPI1. . . . . . . . . . . . . .    NUMB  0001H  
BMPI2D . . . . . . . . . . . . .    NUMB  0002H  
BMPI2U . . . . . . . . . . . . .    NUMB  0004H  
BMPI3D . . . . . . . . . . . . .    NUMB  0008H  
BMPI3U . . . . . . . . . . . . .    NUMB  0010H  
BMPI4. . . . . . . . . . . . . .    NUMB  0020H  
BMPKI1 . . . . . . . . . . . . .    NUMB  0002H  
BMPKI2 . . . . . . . . . . . . .    NUMB  0004H  
BMPKI3 . . . . . . . . . . . . .    NUMB  0008H  
BMPKI4 . . . . . . . . . . . . .    NUMB  0010H  
BMPKO1 . . . . . . . . . . . . .    NUMB  0002H  
BMPKO2 . . . . . . . . . . . . .    NUMB  0004H  
BMPKO3 . . . . . . . . . . . . .    NUMB  0008H  
BMPKO4 . . . . . . . . . . . . .    NUMB  0010H  
BMPO1. . . . . . . . . . . . . .    NUMB  0001H  
BMPO2D . . . . . . . . . . . . .    NUMB  0002H  
BMPO2U . . . . . . . . . . . . .    NUMB  0004H  
BMPO3D . . . . . . . . . . . . .    NUMB  0008H  
BMPO3U . . . . . . . . . . . . .    NUMB  0010H  
BMPO4. . . . . . . . . . . . . .    NUMB  0020H  
BMSKRHD. . . . . . . . . . . . .    NUMB  0010H  
BMSKRHI. . . . . . . . . . . . .    NUMB  0008H  
BMSLOW . . . . . . . . . . . . .    NUMB  0008H  NOT USED  
BMSMERPI1U . . . . . . . . . . .    NUMB  003EH  NOT USED  
BMSMERPI2D . . . . . . . . . . .    NUMB  0001H  NOT USED  
BMSMERPI2U . . . . . . . . . . .    NUMB  0038H  NOT USED  
BMSMERPI3D . . . . . . . . . . .    NUMB  0007H  NOT USED  
BMSMERPI3U . . . . . . . . . . .    NUMB  0020H  NOT USED  
BMSMERPI4D . . . . . . . . . . .    NUMB  001FH  NOT USED  
BMSMERPKI1U. . . . . . . . . . .    NUMB  001CH  NOT USED  
BMSMERPKI2D. . . . . . . . . . .    NUMB  0002H  NOT USED  
BMSMERPKI2U. . . . . . . . . . .    NUMB  0018H  NOT USED  
BMSMERPKI3D. . . . . . . . . . .    NUMB  0006H  NOT USED  
BMSMERPKI3U. . . . . . . . . . .    NUMB  0010H  NOT USED  
BMSMERPKI4D. . . . . . . . . . .    NUMB  000EH  NOT USED  
BMSTOP . . . . . . . . . . . . .    NUMB  0001H  
BMUP . . . . . . . . . . . . . .    NUMB  0001H  NOT USED  
CALIB. . . . . . . . . . . . . .  C ADDR  0098H  NOT USED  
CALIBEND . . . . . . . . . . . .  C ADDR  00AFH  
CALIBEND2. . . . . . . . . . . .  C ADDR  00BAH  
CALIBLOOP. . . . . . . . . . . .  C ADDR  00A7H  
CTRLREG. . . . . . . . . . . . .  D ADDR  0027H  
D2_MB1C. . . . . . . . . . . . .  C ADDR  042BH  
VYTAH/ORI                                                                                                     PAGE 37

D3_MB1C. . . . . . . . . . . . .  C ADDR  0657H  
D3_MB2C. . . . . . . . . . . . .  C ADDR  05F3H  
D4_MB1C. . . . . . . . . . . . .  C ADDR  07B1H  
D4_MB2C. . . . . . . . . . . . .  C ADDR  074DH  
DEL1 . . . . . . . . . . . . . .  C ADDR  084CH  
DOORCLSD . . . . . . . . . . . .  B ADDR  0045H  NOT USED  
DOORCLSDOLD. . . . . . . . . . .  B ADDR  0039H  NOT USED  
DOWN . . . . . . . . . . . . . .  B ADDR  0021H  
DOWN2. . . . . . . . . . . . . .  C ADDR  03ACH  
DOWN2_MB1. . . . . . . . . . . .  C ADDR  0420H  
DOWN2_MB2. . . . . . . . . . . .  C ADDR  03F1H  
DOWN3. . . . . . . . . . . . . .  C ADDR  0545H  
DOWN3_MB1. . . . . . . . . . . .  C ADDR  05FDH  
DOWN3_MB2. . . . . . . . . . . .  C ADDR  058AH  
DOWN4. . . . . . . . . . . . . .  C ADDR  069FH  
DOWN4_MB1. . . . . . . . . . . .  C ADDR  0757H  
DOWN4_MB2. . . . . . . . . . . .  C ADDR  06E4H  
DOWNOLD. . . . . . . . . . . . .  B ADDR  003BH  
DP . . . . . . . . . . . . . . .  B ADDR  000DH  NOT USED  
DPK. . . . . . . . . . . . . . .  B ADDR  000FH  
DPZK . . . . . . . . . . . . . .  B ADDR  000EH  
ENDPROG. . . . . . . . . . . . .  C ADDR  0809H  NOT USED  
ERR_1SPOM_C. . . . . . . . . . .  C ADDR  07BEH  
ERR_2SPOM_C. . . . . . . . . . .  C ADDR  07CDH  
ERR_SKRD . . . . . . . . . . . .  C ADDR  07EBH  
ERR_SKRH . . . . . . . . . . . .  C ADDR  07FAH  
ERR_ZAST_C . . . . . . . . . . .  C ADDR  07DCH  
EX1. . . . . . . . . . . . . . .  B ADDR  00AAH  PREDEFINED  
F1OK . . . . . . . . . . . . . .  C ADDR  00F8H  
F1S. . . . . . . . . . . . . . .  C ADDR  00DDH  
F2 . . . . . . . . . . . . . . .  C ADDR  0278H  
F2DOWN . . . . . . . . . . . . .  C ADDR  028AH  
F2OK . . . . . . . . . . . . . .  C ADDR  024AH  
F2S. . . . . . . . . . . . . . .  C ADDR  022EH  
F2SW . . . . . . . . . . . . . .  C ADDR  025EH  
F2UP . . . . . . . . . . . . . .  C ADDR  027EH  
F3 . . . . . . . . . . . . . . .  C ADDR  0498H  
F3DOWN . . . . . . . . . . . . .  C ADDR  04AAH  
F3OK . . . . . . . . . . . . . .  C ADDR  046AH  
F3S. . . . . . . . . . . . . . .  C ADDR  044EH  
F3SW . . . . . . . . . . . . . .  C ADDR  047EH  
F3UP . . . . . . . . . . . . . .  C ADDR  049EH  
F4OK . . . . . . . . . . . . . .  C ADDR  0693H  
F4S. . . . . . . . . . . . . . .  C ADDR  0678H  
FAST . . . . . . . . . . . . . .  B ADDR  0022H  
FASTOLD. . . . . . . . . . . . .  B ADDR  003CH  NOT USED  
FLED1. . . . . . . . . . . . . .  B ADDR  0024H  
FLED2. . . . . . . . . . . . . .  B ADDR  0025H  
FLED3. . . . . . . . . . . . . .  B ADDR  0026H  
FLED4. . . . . . . . . . . . . .  B ADDR  0027H  
FLOOR1 . . . . . . . . . . . . .  C ADDR  00C9H  
FLOOR2 . . . . . . . . . . . . .  C ADDR  021AH  
FLOOR3 . . . . . . . . . . . . .  C ADDR  043AH  
FLOOR4 . . . . . . . . . . . . .  C ADDR  0664H  
FLOORREQ . . . . . . . . . . . .  D ADDR  0036H  NOT USED  
HIGHEST. . . . . . . . . . . . .  D ADDR  0032H  NOT USED  
I8255INA . . . . . . . . . . . .    NUMB  0080H  
I8255INB . . . . . . . . . . . .    NUMB  0081H  
VYTAH/ORI                                                                                                     PAGE 38

I8255INC . . . . . . . . . . . .    NUMB  0082H  
I8255INCW. . . . . . . . . . . .    NUMB  0083H  
I8255OUTA. . . . . . . . . . . .    NUMB  00C0H  
I8255OUTB. . . . . . . . . . . .    NUMB  00C1H  
I8255OUTC. . . . . . . . . . . .    NUMB  00C2H  
I8255OUTCW . . . . . . . . . . .    NUMB  00C3H  
INPORTA. . . . . . . . . . . . .  D ADDR  0028H  
INPORTB. . . . . . . . . . . . .  D ADDR  0021H  
INPORTBOLD . . . . . . . . . . .  D ADDR  0026H  
INPORTC. . . . . . . . . . . . .  D ADDR  0022H  
KS . . . . . . . . . . . . . . .  B ADDR  0018H  
LEDD . . . . . . . . . . . . . .  B ADDR  002EH  
LEDU . . . . . . . . . . . . . .  B ADDR  002FH  
LOWEST . . . . . . . . . . . . .  D ADDR  0031H  NOT USED  
MAIN . . . . . . . . . . . . . .  C ADDR  00C9H  NOT USED  
MB1. . . . . . . . . . . . . . .  B ADDR  0009H  
MB1OLD . . . . . . . . . . . . .  B ADDR  0031H  NOT USED  
MB2. . . . . . . . . . . . . . .  B ADDR  000AH  
MB2OLD . . . . . . . . . . . . .  B ADDR  0032H  NOT USED  
OUTPORTA . . . . . . . . . . . .  D ADDR  0023H  
OUTPORTB . . . . . . . . . . . .  D ADDR  0024H  
OUTPORTBOLD. . . . . . . . . . .  D ADDR  0034H  NOT USED  
OUTPORTC . . . . . . . . . . . .  D ADDR  0025H  
P0 . . . . . . . . . . . . . . .  D ADDR  0080H  PREDEFINED  
P2 . . . . . . . . . . . . . . .  D ADDR  00A0H  PREDEFINED  
P3 . . . . . . . . . . . . . . .  D ADDR  00B0H  PREDEFINED  
PI1. . . . . . . . . . . . . . .  B ADDR  0010H  NOT USED  
PI2D . . . . . . . . . . . . . .  B ADDR  0011H  
PI2U . . . . . . . . . . . . . .  B ADDR  0012H  
PI3D . . . . . . . . . . . . . .  B ADDR  0013H  
PI3U . . . . . . . . . . . . . .  B ADDR  0014H  
PI4. . . . . . . . . . . . . . .  B ADDR  0015H  NOT USED  
PKI1 . . . . . . . . . . . . . .  B ADDR  0041H  NOT USED  
PKI2 . . . . . . . . . . . . . .  B ADDR  0042H  
PKI3 . . . . . . . . . . . . . .  B ADDR  0043H  
PKI4 . . . . . . . . . . . . . .  B ADDR  0044H  NOT USED  
PKO1 . . . . . . . . . . . . . .  B ADDR  0019H  
PKO2 . . . . . . . . . . . . . .  B ADDR  001AH  
PKO3 . . . . . . . . . . . . . .  B ADDR  001BH  
PKO4 . . . . . . . . . . . . . .  B ADDR  001CH  
PO1. . . . . . . . . . . . . . .  B ADDR  0028H  
PO2D . . . . . . . . . . . . . .  B ADDR  0029H  
PO2U . . . . . . . . . . . . . .  B ADDR  002AH  
PO3D . . . . . . . . . . . . . .  B ADDR  002BH  
PO3U . . . . . . . . . . . . . .  B ADDR  002CH  
PO4. . . . . . . . . . . . . . .  B ADDR  002DH  
POSITION . . . . . . . . . . . .  D ADDR  0030H  NOT USED  
RDNOT. . . . . . . . . . . . . .  B ADDR  00B7H  
READPORTS. . . . . . . . . . . .  C ADDR  088EH  
READPORTS1 . . . . . . . . . . .  C ADDR  0852H  
READPORTS_C. . . . . . . . . . .  C ADDR  08D6H  
READPORTS_C1 . . . . . . . . . .  C ADDR  08D0H  
RESET. . . . . . . . . . . . . .  C ADDR  0033H  NOT USED  
SKRD . . . . . . . . . . . . . .  B ADDR  000CH  
SKRDOLD. . . . . . . . . . . . .  B ADDR  0034H  NOT USED  
SKRH . . . . . . . . . . . . . .  B ADDR  000BH  
SKRHOLD. . . . . . . . . . . . .  B ADDR  0033H  NOT USED  
SLOW . . . . . . . . . . . . . .  B ADDR  0023H  
VYTAH/ORI                                                                                                     PAGE 39

SLOWOLD. . . . . . . . . . . . .  B ADDR  003DH  NOT USED  
SP . . . . . . . . . . . . . . .  D ADDR  0081H  PREDEFINED  
STACK. . . . . . . . . . . . . .  D ADDR  0040H  
START. . . . . . . . . . . . . .  C ADDR  0033H  
STOP . . . . . . . . . . . . . .  C ADDR  082BH  
STOPC. . . . . . . . . . . . . .  C ADDR  083BH  
STOPNOT. . . . . . . . . . . . .  B ADDR  0040H  
STOPPED. . . . . . . . . . . . .  B ADDR  0038H  
STOPTIMER. . . . . . . . . . . .  D ADDR  0033H  
STR_CALIB. . . . . . . . . . . .  C ADDR  0984H  NOT USED  
STR_INIT . . . . . . . . . . . .  C ADDR  091CH  NOT USED  
STR_STOP . . . . . . . . . . . .  C ADDR  0943H  NOT USED  
TIME0. . . . . . . . . . . . . .  C ADDR  0817H  
TIME1. . . . . . . . . . . . . .  C ADDR  0819H  
TIME10MS . . . . . . . . . . . .  C ADDR  0815H  
TIME2. . . . . . . . . . . . . .  C ADDR  081DH  
TIME3. . . . . . . . . . . . . .  C ADDR  0821H  
TIME4. . . . . . . . . . . . . .  C ADDR  0828H  
TIMERCONST . . . . . . . . . . .    NUMB  00FAH  NOT USED  
U1_MB1C. . . . . . . . . . . . .  C ADDR  020CH  
U1_MB2C. . . . . . . . . . . . .  C ADDR  01ADH  
U2_MB1C. . . . . . . . . . . . .  C ADDR  039EH  
U2_MB2C. . . . . . . . . . . . .  C ADDR  033FH  
U3_MB1C. . . . . . . . . . . . .  C ADDR  0535H  
UP . . . . . . . . . . . . . . .  B ADDR  0020H  
UP1. . . . . . . . . . . . . . .  C ADDR  0104H  
UP1A . . . . . . . . . . . . . .  C ADDR  0121H  
UP1_MB1. . . . . . . . . . . . .  C ADDR  01B7H  
UP1_MB2. . . . . . . . . . . . .  C ADDR  0149H  
UP2. . . . . . . . . . . . . . .  C ADDR  0296H  
UP2A . . . . . . . . . . . . . .  C ADDR  02B3H  
UP2_MB1. . . . . . . . . . . . .  C ADDR  0349H  
UP2_MB2. . . . . . . . . . . . .  C ADDR  02DBH  
UP3. . . . . . . . . . . . . . .  C ADDR  04B6H  
UP3A . . . . . . . . . . . . . .  C ADDR  04D3H  
UP3_MB1. . . . . . . . . . . . .  C ADDR  052AH  
UP3_MB2. . . . . . . . . . . . .  C ADDR  04FBH  
UPOLD. . . . . . . . . . . . . .  B ADDR  003AH  
WAITFORTIMER . . . . . . . . . .  C ADDR  084AH  
WRITEPORTS . . . . . . . . . . .  C ADDR  08E9H  
WRNOT. . . . . . . . . . . . . .  B ADDR  00B6H  
