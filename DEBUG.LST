DEBUG                                                                                                         PAGE 1

                       1    ; TODO: 
                       2    ; OK - Dorob nulovanie volieb v sachte 
                       3    ; Dorob 3UP a 2 DOWN (tam kde stojis vzdy)
                       4    ; Asi by bolo dobre premenovat PI1, PO1 a PI4 PO4 na alternativy s koncovkami U a D
                       5    ; Poriadne otestuj !!! 
                       6    ; Umozni stlacat tlacidla aj ked bezi delay
                       7    
                       8    ;Prerusenia pojdu, ale treba dat sakra pozor na zalohovanie veci!!!
                       9    
                      10    
                      11    $MOD51
                      12    $DEBUG
                      13    
                =1    14    $include (lift.inc)
                =1    15    
                =1    16    ;            |  7    |  6    |  5    |  4    |  3    |  2    |  1    |  0    |
                =1    17    ; ****************************************************************************
                =1    18    ; INPORTA >  |       |       |DOORCLS| PKI4  | PKI3  | PKI2  | PKI1  |STOPNOT|
                =1    19    ; ----------------------------------------------------------------------------
                =1    20    ; INPORTB >  | DPK   | DPZK  | DP    | SKRD  | SKRH  | MB2   | MB1   |       |
                =1    21    ; ----------------------------------------------------------------------------
                =1    22    ; INPORTC >  |       |       | PI4   | PI3D  | PI3U  | PI2D  | PI2U  | PI1   |
                =1    23    ; ****************************************************************************
                =1    24    ; OUTPORTA > |       |       |       | PKO4  | PKO3  | PKO2  | PKO1  | KS    |
                =1    25    ; ----------------------------------------------------------------------------
                =1    26    ; OUTPORTB > | FLED4 | FLED3 | FLED2 | FLED1 | SLOW  | FAST  | DOWN  | UP    |
                =1    27    ; ----------------------------------------------------------------------------
                =1    28    ; OUTPORTC > | LEDU  | LEDD  | PO4   | PO3D  | PO3U  | PO2D  | PO2U  | PO1   |
                =1    29    ; ****************************************************************************
                =1    30    ; ERRFLOOR > |       |       |       | ErrF4 | ErrF3 | ErrF2 | ErrF1 |       |
                =1    31    ; ****************************************************************************
                =1    32    
                =1    33    
                =1    34    ; adresy I/O portov, ktore pridu na port P2 89C52-ky
  0080          =1    35    i8255INA        equ     080h
  0081          =1    36    i8255INB        equ     081h
  0082          =1    37    i8255INC        equ     082h
  0083          =1    38    i8255INCW       equ     083h
  00C0          =1    39    i8255OUTA       equ     0c0h
  00C1          =1    40    i8255OUTB       equ     0c1h
  00C2          =1    41    i8255OUTC       equ     0c2h
  00C3          =1    42    i8255OUTCW      equ     0c3h
                =1    43    
  0028          =1    44    INPORTA         data    28h         ; nutne kvoli emulatoru!!!
  0021          =1    45    INPORTB         data    21h
  0022          =1    46    INPORTC         data    22h
  0023          =1    47    OUTPORTA        data    23h
  0024          =1    48    OUTPORTB        data    24h
  0025          =1    49    OUTPORTC        data    25h
  0026          =1    50    INPORTBold      data    26h
  0027          =1    51    CTRLREG         data    27h
                =1    52    
  002A          =1    53    ERRFLOOR_U      data    2Ah
  002B          =1    54    ERRFLOOR_D      data    2Bh
                =1    55    
  0051          =1    56    ERRF1_U         bit     ERRFLOOR_U.1
  0052          =1    57    ERRF2_U         bit     ERRFLOOR_U.2
  0053          =1    58    ERRF3_U         bit     ERRFLOOR_U.3
DEBUG                                                                                                         PAGE 2

  0054          =1    59    ERRF4_U         bit     ERRFLOOR_U.4  
                =1    60    
  0052          =1    61    ERRF12_U        bit     ERRFLOOR_U.2
  0053          =1    62    ERRF23_U        bit     ERRFLOOR_U.3
  0054          =1    63    ERRF34_U        bit     ERRFLOOR_U.4   
                =1    64    
  0059          =1    65    ERRF1_D         bit     ERRFLOOR_D.1
  005A          =1    66    ERRF2_D         bit     ERRFLOOR_D.2
  005B          =1    67    ERRF3_D         bit     ERRFLOOR_D.3
  005C          =1    68    ERRF4_D         bit     ERRFLOOR_D.4   
                =1    69    
  0059          =1    70    ERRF12_D        bit     ERRFLOOR_D.1
  005A          =1    71    ERRF23_D        bit     ERRFLOOR_D.2
  005B          =1    72    ERRF34_D        bit     ERRFLOOR_D.3 
                =1    73    
  0035          =1    74    ERRF1_C         data    35h
  0036          =1    75    ERRF2_C         data    36h
  0037          =1    76    ERRF3_C         data    37h
  0038          =1    77    ERRF4_C         data    38h
                =1    78    
  0039          =1    79    ERRF12_C        data    39h
  003A          =1    80    ERRF23_C        data    3Ah
  003B          =1    81    ERRF34_C        data    3Bh
                =1    82               
  0030          =1    83    POSITION        data    30h
  0031          =1    84    LOWEST          data    31h
  0032          =1    85    HIGHEST         data    32h
  0033          =1    86    STOPTIMER       data    33h
  0034          =1    87    OUTPORTBold     data    34h
                =1    88    
  0040          =1    89    STOPNOT         bit     INPORTA.0
  0041          =1    90    PKI1            bit     INPORTA.1
  0042          =1    91    PKI2            bit     INPORTA.2
  0043          =1    92    PKI3            bit     INPORTA.3
  0044          =1    93    PKI4            bit     INPORTA.4
  0045          =1    94    DOORCLSD        bit     INPORTA.5 
                =1    95    
  0009          =1    96    MB1             bit     INPORTB.1       ; clonky maju invertovanu logiku
  000A          =1    97    MB2             bit     INPORTB.2
  000B          =1    98    SKRH            bit     INPORTB.3
  000C          =1    99    SKRD            bit     INPORTB.4
  000D          =1   100    DP              bit     INPORTB.5
  000E          =1   101    DPZK            bit     INPORTB.6
  000F          =1   102    DPK             bit     INPORTB.7
                =1   103    
  0031          =1   104    MB1old          bit     INPORTBold.1
  0032          =1   105    MB2old          bit     INPORTBold.2
  0033          =1   106    SKRHold         bit     INPORTBold.3
  0034          =1   107    SKRDold         bit     INPORTBold.4
                =1   108    
  0010          =1   109    PI1             bit     INPORTC.0
  0011          =1   110    PI2D            bit     INPORTC.1
  0012          =1   111    PI2U            bit     INPORTC.2
  0013          =1   112    PI3D            bit     INPORTC.3
  0014          =1   113    PI3U            bit     INPORTC.4
  0015          =1   114    PI4             bit     INPORTC.5
                =1   115    
  0018          =1   116    KS              bit     OUTPORTA.0
DEBUG                                                                                                         PAGE 3

  0019          =1   117    PKO1            bit     OUTPORTA.1
  001A          =1   118    PKO2            bit     OUTPORTA.2
  001B          =1   119    PKO3            bit     OUTPORTA.3
  001C          =1   120    PKO4            bit     OUTPORTA.4
                =1   121    
  0020          =1   122    UP              bit     OUTPORTB.0
  0021          =1   123    DOWN            bit     OUTPORTB.1
  0022          =1   124    FAST            bit     OUTPORTB.2
  0023          =1   125    SLOW            bit     OUTPORTB.3
  0024          =1   126    FLED1           bit     OUTPORTB.4
  0025          =1   127    FLED2           bit     OUTPORTB.5
  0026          =1   128    FLED3           bit     OUTPORTB.6
  0027          =1   129    FLED4           bit     OUTPORTB.7
                =1   130    
  0028          =1   131    PO1U            bit     OUTPORTC.0
  0028          =1   132    PO1D            bit     OUTPORTC.0
  0028          =1   133    PO1             bit     OUTPORTC.0
  0029          =1   134    PO2D            bit     OUTPORTC.1
  002A          =1   135    PO2U            bit     OUTPORTC.2
  002B          =1   136    PO3D            bit     OUTPORTC.3
  002C          =1   137    PO3U            bit     OUTPORTC.4
  002D          =1   138    PO4             bit     OUTPORTC.5
  002D          =1   139    PO4U            bit     OUTPORTC.5
  002D          =1   140    PO4D            bit     OUTPORTC.5
  002E          =1   141    LEDD            bit     OUTPORTC.6
  002F          =1   142    LEDU            bit     OUTPORTC.7
                =1   143    
  0038          =1   144    STOPPED         bit     CTRLREG.0
  0039          =1   145    DOORCLSDold     bit     CTRLREG.1
  003A          =1   146    UPold           bit     CTRLREG.2
  003B          =1   147    DOWNold         bit     CTRLREG.3
  003C          =1   148    FASTold         bit     CTRLREG.4
  003D          =1   149    SLOWold         bit     CTRLREG.5
                =1   150    
  00B6          =1   151    WRNOT           bit     0b6h        ; p3.6
  00B7          =1   152    RDNOT           bit     0b7h        ; p3.7
                =1   153    
                =1   154    ; bitove masky
                =1   155    ; 8255OUT 
                =1   156    ; port A
  0001          =1   157    bmKS              equ    00000001b
  0002          =1   158    bmPKO1            equ    00000010b
  0004          =1   159    bmPKO2            equ    00000100b
  0008          =1   160    bmPKO3            equ    00001000b
  0010          =1   161    bmPKO4            equ    00010000b
                =1   162    
                =1   163    ; port B
  0001          =1   164    bmUP              equ    00000001b
  0002          =1   165    bmDOWN            equ    00000010b
  0004          =1   166    bmFAST            equ    00000100b
  0008          =1   167    bmSLOW            equ    00001000b
  0010          =1   168    bmFLED1           equ    00010000b
  0020          =1   169    bmFLED2           equ    00100000b
  0040          =1   170    bmFLED3           equ    01000000b
  0080          =1   171    bmFLED4           equ    10000000b
                =1   172    
                =1   173    ; port C
  0001          =1   174    bmPO1             equ    00000001b
DEBUG                                                                                                         PAGE 4

  0002          =1   175    bmPO2D            equ    00000010b
  0004          =1   176    bmPO2U            equ    00000100b
  0008          =1   177    bmPO3D            equ    00001000b
  0010          =1   178    bmPO3U            equ    00010000b
  0020          =1   179    bmPO4             equ    00100000b
  0040          =1   180    bmLEDD            equ    01000000b
  0080          =1   181    bmLEDU            equ    10000000b
                =1   182    
                =1   183    ; 8255IN
                =1   184    ; port A
  0001          =1   185    bmSTOP            equ    00000001b
  0002          =1   186    bmPKI1            equ    00000010b
  0004          =1   187    bmPKI2            equ    00000100b
  0008          =1   188    bmPKI3            equ    00001000b
  0010          =1   189    bmPKI4            equ    00010000b
  0020          =1   190    bmDOORCLSD        equ    00100000b
                =1   191    
                =1   192    ; port B
  0002          =1   193    bmMB1I            equ    00000010b
  0004          =1   194    bmMB2I            equ    00000100b
  0008          =1   195    bmSKRHI           equ    00001000b
  0010          =1   196    bmSKRHD           equ    00010000b
  0020          =1   197    bmDPI             equ    00100000b
  0040          =1   198    bmDPZKI           equ    01000000b
  0080          =1   199    bmDPKI            equ    10000000b
                =1   200    
                =1   201    ; port C
  0001          =1   202    bmPI1             equ    00000001b
  0002          =1   203    bmPI2D            equ    00000010b
  0004          =1   204    bmPI2U            equ    00000100b
  0008          =1   205    bmPI3D            equ    00001000b
  0010          =1   206    bmPI3U            equ    00010000b
  0020          =1   207    bmPI4             equ    00100000b
                     208    
                     209    _BP_    MACRO 
                     210            clr     P3.3
                     211            setb    EX1
                     212            nop
                     213            nop
                     214    ENDM
                     215                        
                     216    ANLBN   MACRO   BIT1, BIT2
                     217            mov   C, BIT1
                     218            anl   C, /BIT2
                     219            mov   BIT1, C
                     220    ENDM
                     221    
                     222    LJZ     MACRO   NAVESTIE
                     223            jnz     $+5
                     224            ljmp    NAVESTIE
                     225            nop
                     226    ENDM
                     227    
                     228    LJNZ    MACRO   NAVESTIE
                     229            jz      $+5
                     230            ljmp    NAVESTIE
                     231            nop
                     232    ENDM
DEBUG                                                                                                         PAGE 5

                     233    
                     234    LJB     MACRO   TESTBIT, NAVESTIE
                     235            jnb     TESTBIT, $+6
                     236            ljmp    NAVESTIE
                     237            nop
                     238    ENDM
                     239    
                     240    LJNB    MACRO   TESTBIT, NAVESTIE
                     241            jb      TESTBIT, $+6
                     242            ljmp    NAVESTIE
                     243            nop
                     244    ENDM
                     245    
                     246    CJE     MACRO   OP1, OP2, NAVESTIE
                     247            cjne    OP1, OP2, $+7
                     248            jmp    NAVESTIE
                     249            nop
                     250    ENDM
                     251    
                     252    LCJNE   MACRO   OP1, OP2, NAVESTIE
                     253            cjne    OP1, OP2, $+6
                     254            jmp     $+6
                     255            ljmp    NAVESTIE
                     256            nop
                     257    ENDM
                     258    
  0000               259    COUNT    SET    0
                     260    
                     261    
                     262    ;NEVYSKUSANE (ANI NESKOMPILOVANE) !
                     263    
                     264    SET_FLOOR_ERR   MACRO   TESTBIT, FLOORBIT, NAVESTIE, POSCH, LABEL    ;; nastavi dane poschod
                                                                               ie ako poruchove ak je TESTBIT rovny 0 
                     265                                                                                                
                                                                                                                        
                                                                                   ;;   FLOORBIT:   ERRF1, .. ERRF4, ERR
                                                                               F12, ERRF23, ERRF34
                     266                                                                                                
                                                                                                                        
                                                                                   ;;   TESTBIT:    MB1, MB2
                     267            ;INCREMENT SUFFIX  FOR  NEXT LABEL             
                     268            COUNT    SET    COUNT+1                   
                     269            
                     270            jb      TESTBIT, ENDD&LABEL
                     271            jnb     PKI&POSCH, $+7
                     272            setb    SLOW
                     273            setb    STOPPED         
                     274            setb    FLOORBIT&_U
                     275            setb    FLOORBIT&_D
                     276            inc     FLOORBIT&_C
                     277                    clr     PKO&POSCH                               ;; vynulovanie volby poschod
                                                                               ia na ktorom stojim
                     278            clr     PO&POSCH&U            
                     279            clr     PO&POSCH&D              
                     280                    lcall   WRITEPORTS
                     281            ljmp    NAVESTIE
                     282    ENDD&LABEL:
                     283            nop
DEBUG                                                                                                         PAGE 6

                     284    ENDM
                     285    
                     286    CLR_FLOOR_ERR   MACRO   FLOORBIT,   ;; nastavi dane poschodie ako bezporuchove           
                     287            clr    FLOORBIT&_U
                     288            clr    FLOORBIT&_D
                     289            nop
                     290    ENDM
                     291    
                     292    ZAKMITC MACRO   TYPCLONKY
                     293            lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
                     294            lcall   READPORTS       ; Uz sme z tej clonky prec?
                     295            jnb     TYPCLONKY, $-3  ; 
                     296            lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                     297    ENDM
                     298    
                     299    ZASTAV  MACRO  C_POSCH, SMER
                     300                                            ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
                     301            clr     C                       ; | Idem robit cachre-machre s Carry bitom
                     302            mov     A, #0h                  ; | Aj Acc potrebujem prazdny
                     303            orl     C, PI&C_POSCH&SMER      ; | Mam v tomto smere stlacene tlacidlo v sachte?
                     304            anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
                     305            orl     C, PKI&C_POSCH          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
                     306            anl     C, /ERRF&C_POSCH&_&SMER ; | a mam v tomto smere poruchu na tomto poschodi (A
                                                                               k ano, tak nema zmysel stat)
                     307            orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
                     308            orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
                     309            addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
                     310    ENDM
                     311    
                     312    NAJNIZSIE  MACRO
                     313            mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
                     314            rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
                     315            anl     A, #01111110b   ; Vynulujem nedefinovane bity
                     316    
                     317            ANLBN   ACC.1, ERRF1_D  ; maskujem chybne poschodia
                     318            ANLBN   ACC.2, ERRF2_D  ; |
                     319            ANLBN   ACC.3, ERRF2_D  ; |
                     320            ANLBN   ACC.4, ERRF3_D  ; |
                     321            ANLBN   ACC.5, ERRF3_D  ; |
                     322    
                     323            mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                     324     ; LL1: 
                     325            jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
                     326            clr     C               ; Inak shiftnem o 2
                     327            rlc     A               ;
                     328            clr     C               ;
DEBUG                                                                                                         PAGE 7

                     329            rlc     A               ;
                     330            djnz    R0, $-6         ; ...a pokracujem v zistovani
                     331    ; LL2:
                     332            mov     A, R0           ; vysledne (najnizsie zvolene) poschodie je index v R0
                     333    ENDM
                     334    
                     335    NAJVYSSIE  MACRO
                     336            mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
                     337            rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
                     338            anl     A, #01111110b   ; Vynulujem nedefinovane bity
                     339            
                     340            ANLBN   ACC.2, ERRF2_U  ; maskujem chybne poschodia
                     341            ANLBN   ACC.3, ERRF2_U  ; |
                     342            ANLBN   ACC.4, ERRF3_U  ; |
                     343            ANLBN   ACC.5, ERRF3_U  ; |
                     344            ANLBN   ACC.6, ERRF4_U  ; |
                     345            
                     346            mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                     347     ; LL1: 
                     348            jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
                     349            clr     C               ; Inak shiftnem o 2
                     350            rrc     A               ;
                     351            clr     C               ;
                     352            rrc     A               ;
                     353            djnz    R0, $-6         ; ...a pokracujem v zistovani
                     354    ; LL2:
                     355            mov     A, #5           ; vysledne (najnizsie zvolene) poschodie je index v R0
                     356            clr     C               ;
                     357            subb    A, R0           ;
                     358    ENDM
                     359    
                     360    VYSSIE_KABINA  MACRO  POSCH
                     361            mov     A, INPORTA
                     362            anl     A, #00011110b
                     363            mov     B, ERRFLOOR_U   ; maskujem chybne poschodia
                     364            xrl     B, #0FFH
                     365            anl     A, B
                     366            clr     C
                     367            rrc     A
                     368    ;LL1    
                     369            mov     R0, #&POSCH
                     370            clr     C
                     371            rrc     A
                     372            djnz    R0, $-2;LL1
                     373    ENDM
                     374    
                     375    NIZSIE_KABINA  MACRO  POSCH
                     376            mov     A, #5
                     377            clr     C
                     378            subb    A, #&POSCH
                     379            mov     R0, A
                     380            mov     A, INPORTA
                     381            anl     A, #00011110b
DEBUG                                                                                                         PAGE 8

                     382            mov     B, ERRFLOOR_D   ; maskujem chybne poschodia
                     383            xrl     B, #0FFH
                     384            anl     A, B
                     385            clr     C
                     386            rlc     A
                     387            clr     C
                     388            rlc     A
                     389            clr     C
                     390            rlc     A
                     391    ;LL1   
                     392            clr     C
                     393            rlc     A
                     394            djnz    R0, $-2;LL1
                     395    ENDM
                     396    
                     397    POLOHA_LED  MACRO  POLOHA
                     398            clr     LEDU            
                     399            clr     LEDD 
                     400            clr     FLED1             
                     401            clr     FLED2                
                     402            clr     FLED3           
                     403            clr     FLED4           
                     404            setb    FLED&POLOHA
                     405            lcall   WRITEPORTS
                     406    ENDM
                     407    
                     408    ; hodiny oscilatora v emulatore treba dat na ext a nastavit 11.0592MHz
  00FA               409    TIMERCONST      equ     250     ; udaj pre nastavenie casovaca pre potreby seriovej komunika
                                                                               cie
                     410                                    ; hodnota 250 znamena prenosovu rychlost 4800 baud pri oscil
                                                                               atore 11.0592MHz
                     411                                    ; nastavenie terminalu je 4800 8-N-1, no flow control
                     412    ;osetrenie vektorov preruseni
0000                 413            org     0000h           ; adresa odkial startuje program po resete
0000 020033          414            ljmp    START           ; skok na zaciatok kodu programu
                     415            
000B                 416            org     000Bh           ; v tejto casti pamati je vektor prerusenia
000B 020C26          417            ljmp    INT_TIMER0      ; pre citac T0
                     418                  
0033                 419            org     0033h           ; od tejto adresy sa zacina kod programu
                     420            
0033                 421    START:
0033                 422    RESET:  
                     423            ; riadiace signaly do pasivnej urovne 
0033 D2B6            424            setb    WRNOT
0035 D2B7            425            setb    RDNOT
0037 753300          426            mov     STOPTIMER, #0
003A 758140          427            mov     SP, #STACK
                     428    
                     429            ; pockame si na inicializaciu obvodov 8255  
003D 7900            430            mov     R1, #0 
003F 7AFF            431            mov     R2, #0ffh
0041 D9FE            432            djnz    R1, $
0043 DAFC            433            djnz    R2, $-2
                     434            
                     435            ; teraz ich mozeme nastavit
0045 75809B          436            mov     p0, #10011011b      ; nastavenie i8255IN - vsetky porty dnu
0048 75A083          437            mov     p2, #i8255INCW
DEBUG                                                                                                         PAGE 9

004B C2B6            438            clr     WRNOT
004D 00              439            nop
004E 00              440            nop
004F 00              441            nop
0050 00              442            nop
0051 D2B6            443            setb    WRNOT
0053 758080          444            mov     p0, #10000000b      ; nastavenie i8255OUT - vsetky porty von
0056 75A0C3          445            mov     p2, #i8255OUTCW
0059 C2B6            446            clr     WRNOT
005B 00              447            nop
005C 00              448            nop
005D 00              449            nop
005E 00              450            nop
005F D2B6            451            setb    WRNOT
                     452            
                     453            ;_BP_
                     454            
                     455            ;-----------------------
                     456            ; Prerusenia
                     457            ;----------------------- 
                     458            ;clr     TR1                 ; zastavi sa citac T1
                     459            ;clr     TR0                 ; a tiez citac T0
                     460            ;mov     SCON,#01010010b     ; nastavenie registra SCON
                     461            ;                            ; mod 1 (8b UART), SM2=0 (jednoprocesorovy system)
                     462            ;                            ; REN=1, 0, 0, TI=1 (vysielaci register je prazdny)
                     463            ;                            ; RI=0 (prijimaci register - nebol prijaty znak)
                     464            ;mov     TCON,#00000001b     ; INT0 je citlive na zostupnu hranu
                     465            ;mov     TMOD,#00100001b     ; nastavenie TMOD registra
                     466            ;                            ; T1: mod 2 - po preteceni sa TL nastavi na hodnotu TH
                                                                               
                     467            ;                            ; GATE=0 (programove riadenie casovaca)
                     468            ;                            ; C/T#=0 interne hodiny/12
                     469            ;                            ; T0: mod 1 - 16 bitove pocitadlo
                     470            ;                            ; GATE=0 (programove riadenie casovaca)
                     471            ;                            ; C/T#=0 interne hodiny/12
                     472            ;mov     PCON,#00000000b     ; najvyssi bit musi byt 0, aby sa nezdvojnasobila preno
                                                                               sova rychlost seriovej linky
                     473            ;mov     TL1,#TIMERCONST     ; inicializacia casovaca T1
                     474            ;mov     TH1,#TIMERCONST     ; 
                     475            ;mov     TL0, #0D2h           ; inicializacia casovaca T0 65409,92(- 57600 = 0e100h 
                                                                               - to bolo)
                     476            ;mov     TH0, #0FFh
                     477    
                     478            ;setb    TR1                 ; aktivacia T1 => spustenie seriovej linky
                     479            ;_BP_
                     480    
                     481    ;       ;setb    EX0                 ; prerusenie INT0  - ostava zakazane, signal STOP osetr
                                                                               ime priamo v hlavnej slucke
                     482    ;       ;setb    ES                  ; prerusenie seriovej linky teraz nevyuzivame
                     483            ;setb    ET0                 ; povolime prerusenia od casovaca T0
                     484            ;setb    TR0
                     485            ;setb    EA                  ; spust cely prerusovaci mechanizmus
                     486            
0061 C28E            487            clr     TR1                 ; zastavi sa citac T1
0063 759852          488            mov     SCON,#01010010b     ; nastavenie registra SCON
                     489                                        ; mod 1 (8b UART), SM2=0 (jednoprocesorovy system)
                     490                                        ; REN=1, 0, 0, TI=1 (vysielaci register je prazdny)
                     491                                        ; RI=0 (prijimaci register - nebol prijaty znak)
DEBUG                                                                                                         PAGE 10

0066 758801          492            mov     TCON,#00000001b     ; INT0 je citlive na zostupnu hranu
0069 758921          493            mov     TMOD,#00100001b     ; nastavenie TMOD registra
                     494                                        ; T1: mod 1 - 16 bitove pocitadlo
                     495                                        ; GATE=0 (programove riadenie casovaca)
                     496                                        ; C/T#=0 interne hodiny/12
                     497                                        ; T0: mod 1 - 16 bitove pocitadlo
                     498                                        ; GATE=0 (programove riadenie casovaca)
                     499                                        ; C/T#=0 interne hodiny/12
006C 758700          500            mov     PCON,#00000000b     ; najvyssi bit musi byt 0, aby sa nezdvojnasobila prenos
                                                                               ova rychlost seriovej linky
006F 758BFA          501            mov     TL1,#TIMERCONST     ; inicializacia casovaca T1
0072 758DFA          502            mov     TH1,#TIMERCONST     ; 
0075 758A00          503            mov     TL0, #000h           ; inicializacia casovaca T0 - 57600 = 0e100h
0078 758C4C          504            mov     TH0, #04Ch
                     505            
007B D28C            506            setb    TR0
007D D28E            507            setb    TR1                 ; aktivacia T1 => spustenie seriovej linky
                     508            
                     509            ;-----------------------
                     510            ; Prerusenia
                     511            ;-----------------------
                     512            
                     513    
                     514            ; pociatocna inicializacia - vynuluj vstupne registre a rozsviet vsetky diody 
007F 752800          515            mov     INPORTA, #0
0082 75211E          516            mov     INPORTB, #01eh      ; vsetky clonky pasivne
0085 752200          517            mov     INPORTC, #0
0088 75231E          518            mov     OUTPORTA, #(bmPKO1 or bmPKO2 or bmPKO3 or bmPKO4)
008B 7524F0          519            mov     OUTPORTB, #(bmFLED1 or bmFLED2 or bmFLED3 or bmFLED4)
008E 7525FF          520            mov     OUTPORTC, #(bmPO1 or bmPO2D or bmPO2U or bmPO3D or bmPO3U or bmPO4 or bmLEDD
                                                                                or bmLEDU)
0091 D218            521            setb    KS
0093 C238            522            clr     STOPPED
0095 120D3C          523            call    WRITEPORTS          ; zapis novu informaciu
                     524    ;;;;;;;;
                     525    
0098 752300          526            mov     OUTPORTA, #0
009B 752400          527            mov     OUTPORTB, #0
009E 752500          528            mov     OUTPORTC, #0
00A1 120D3C          529            call    WRITEPORTS          ; zapis novu informaciu
                     530    
00A4 752800          531            mov     INPORTA, #0
00A7 752100          532            mov     INPORTB, #0         
00AA 752200          533            mov     INPORTC, #0
00AD 120CDD          534            call    READPORTS           ; prvotne nacitanie udajov
                     535            
00B0 752A00          536            mov     ERRFLOOR_U, #0h     ; vynuluj chybovy register
00B3 752B00          537            mov     ERRFLOOR_D, #0h      
                     538    
                     539            
00B6 900D86          540            mov     DPTR, #STR_INIT         ; vypis info 
00B9 120D73          541            lcall   DISPSTR                 ; o inicializacii       
                     542    
00BC                 543    CALIB:
                     544            ;kalibracia vytahu podla dolnej porovnavacej clonky
                     545            ;setb    TR0
00BC 120CDD          546            lcall   READPORTS                   ; precitaj, co je na portoch
00BF 300C13          547            jnb     SKRD, CALIBEND              ; ak sme na dolnej porovnavacej clonke, tak koni
DEBUG                                                                                                         PAGE 11

                                                                               ec
00C2 D221            548            setb    DOWN                        ; inak pod dole
00C4 D222            549            setb    FAST                        ; a rychlo
00C6 C223            550            clr     SLOW                        ;
00C8 C220            551            clr     UP                
00CA 120D3C          552            lcall   WRITEPORTS                  ; zapis informaciu 
00CD                 553    CALIBLOOP:
00CD 120CDD          554            lcall   READPORTS                   ; 
00D0 300C02          555            jnb     SKRD, CALIBEND              ; ak sme dole, konci
00D3 80F8            556            jmp     CALIBLOOP
00D5                 557    CALIBEND:                              
00D5 C222            558            clr     FAST                        ; zastavime v tomto smere
00D7 C221            559            clr     DOWN                        ;
00D9 D223            560            setb    SLOW                        ; Este sa pohneme kusocek hore, aby sme si 
00DB D220            561            setb    UP                          ; boli isti, ze sme spravne synchronizovani na p
                                                                               oschodi
00DD 120D3C          562            lcall   WRITEPORTS 
00E0                 563    CALIBEND2:
00E0 120CDD          564            lcall   READPORTS                   ; 
00E3 2009FA          565            jb      MB1, CALIBEND2              ; 
00E6 C223            566            clr     SLOW                        ; A teraz sme uz naozaj spravne
00E8 C220            567            clr     UP                          ; 
00EA D224            568            setb    FLED1
00EC 120D3C          569            lcall   WRITEPORTS                  ; zapis informaciu
                     570            ;clr     TR0
                     571            ;_BP_
00EF 900D86          572            mov     DPTR, #STR_INIT             ; vypis info o kalibracii
00F2 120D73          573            lcall   DISPSTR                     ;
00F5                 574    MAIN:
                     575    
                     576    ;            |  7    |  6    |  5    |  4    |  3    |  2    |  1    |  0    |
                     577    ; ****************************************************************************
                     578    ; INPORTA >  |       |       |DOORCLS| PKI4  | PKI3  | PKI2  | PKI1  |STOPNOT|
                     579    ; ----------------------------------------------------------------------------
                     580    ; INPORTB >  | DPK   | DPZK  | DP    | SKRD  | SKRH  | MB2   | MB1   |       |
                     581    ; ----------------------------------------------------------------------------
                     582    ; INPORTC >  |       |       | PI4   | PI3D  | PI3U  | PI2D  | PI2U  | PI1   |
                     583    ; ****************************************************************************
                     584    ; OUTPORTA > |       |       |       | PKO4  | PKO3  | PKO2  | PKO1  | KS    |
                     585    ; ----------------------------------------------------------------------------
                     586    ; OUTPORTB > | FLED4 | FLED3 | FLED2 | FLED1 | SLOW  | FAST  | DOWN  | UP    |
                     587    ; ----------------------------------------------------------------------------
                     588    ; OUTPORTC > | LEDU  | LEDD  | PO4   | PO3D  | PO3U  | PO2D  | PO2U  | PO1   |
                     589    ; ****************************************************************************
                     590    ; POSITION
                     591    ; ****************************************************************************
                     592    
                     593    
                     594    
00F5 7D00            595            mov     R5, #0
00F7 7E14            596            mov     R6, #20
00F9 D2A9            597            setb    ET0;
                     598            
                     599    
                     600    
                     601    ;------------------------------------------------------------------------------- << 1. posch
                                                                               odie >>
                     602    
DEBUG                                                                                                         PAGE 12

00FB                 603    FLOOR1:
                     604 +1                 POLOHA_LED 1  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
00FB C22F            605 +1         clr     LEDU            
00FD C22E            606 +1         clr     LEDD 
00FF C224            607 +1         clr     FLED1             
0101 C225            608 +1         clr     FLED2                
0103 C226            609 +1         clr     FLED3           
0105 C227            610 +1         clr     FLED4           
0107 D224            611 +1         setb    FLED1
0109 120D3C          612 +1         lcall   WRITEPORTS
010C 120C95          614            lcall   WAITFORTIMER    ; simulacia TIMERu
010F 120CDD          615    F1S:    lcall   READPORTS     ;-; nacitanie dat
0112 C219            616            clr     PKO1          ;-; vynulovanie volby poschodia na ktorom stojim
0114 C228            617            clr     PO1             ;
0116 120D3C          618            lcall   WRITEPORTS      ;
0119 200FF3          619            jb      DPK, F1S        ; Mam pretazenu kabinu? (Ak ano, tak sa nepohnem)
011C E528            620            mov     A, INPORTA      ; zistenie, ci bolo stlacene nieco viac ako poschodie na kto
                                                                               rom stojim (Kabina)
011E 852AF0          621            mov     B, ERRFLOOR_U   ; | maskujem chybne poschodia
0121 63F0FF          622            xrl     B, #0FFH        ; | |
0124 55F0            623            anl     A, B            ; | |
0126 541C            624            anl     A, #00011100b ;-; |
0128 7026            625            jnz     F1OK          ;-; ak ano, podme na to
012A E522            626            mov     A, INPORTC      ; zistenie, ci bolo stlacene nieco viac ako poschodie na kto
                                                                               rom stojim (Sachta)
012C 543E            627            anl     A, #00111110b ;-;
                     628 +1         ANLBN   ACC.1, ERRF2_U  ; maskujem chybne poschodia (v smere hore)
012E A2E1            629 +1         mov   C, ACC.1
0130 B052            630 +1         anl   C, /ERRF2_U
0132 92E1            631 +1         mov   ACC.1, C
                     633 +1         ANLBN   ACC.2, ERRF2_U  ; |
0134 A2E2            634 +1         mov   C, ACC.2
0136 B052            635 +1         anl   C, /ERRF2_U
0138 92E2            636 +1         mov   ACC.2, C
                     638 +1         ANLBN   ACC.3, ERRF3_U  ; |
013A A2E3            639 +1         mov   C, ACC.3
013C B053            640 +1         anl   C, /ERRF3_U
013E 92E3            641 +1         mov   ACC.3, C
                     643 +1         ANLBN   ACC.4, ERRF3_U  ; |
0140 A2E4            644 +1         mov   C, ACC.4
0142 B053            645 +1         anl   C, /ERRF3_U
0144 92E4            646 +1         mov   ACC.4, C
                     648 +1         ANLBN   ACC.5, ERRF4_U  ; |
0146 A2E5            649 +1         mov   C, ACC.5
0148 B054            650 +1         anl   C, /ERRF4_U
014A 92E5            651 +1         mov   ACC.5, C
014C 7002            653            jnz     F1OK          ;-; ak ano, podme na to
014E 80BF            654            jmp     F1S             ; Nemam sa kde hnut, opakujem
0150 D220            655    F1OK:   setb    UP              ; rychly pohyb hore
0152 D222            656            setb    FAST            ; 
0154 C223            657            clr     SLOW            ;
0156 120D3C          658            lcall   WRITEPORTS      ; 
0159 02015C          659            jmp     UP1           ;-; prejdi do stavu UP1
015C                 660    UP1:
                     661 +1                 POLOHA_LED 1  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
015C C22F            662 +1         clr     LEDU            
DEBUG                                                                                                         PAGE 13

015E C22E            663 +1         clr     LEDD 
0160 C224            664 +1         clr     FLED1             
0162 C225            665 +1         clr     FLED2                
0164 C226            666 +1         clr     FLED3           
0166 C227            667 +1         clr     FLED4           
0168 D224            668 +1         setb    FLED1
016A 120D3C          669 +1         lcall   WRITEPORTS
                     671 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
016D 120C60          672 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0170 120CDD          673 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0173 3009FA          674 +1         jnb     MB1, $-3  ; 
0176 120C60          675 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0179 120CDD          677    UP1A:   lcall   READPORTS       ; nacitanie dat
                     678 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
017C 200B03          679 +1         jb      SKRH, $+6
017F 020BD8          680 +1         ljmp    ERR_SKRH
0182 00              681 +1         nop
                     683            ;ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na 
                                                                               zastavovaciu) <<<
                     684 +1         SET_FLOOR_ERR   MB1, ERRF12, UP2, 2, %COUNT
                     685 +1                                                                                             
                                                                                                                 
                     686 +1                                                                                             
                                                                                                                 
                     687 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0001               688 +1         COUNT    SET    COUNT+1                   
                     689 +1         
0183 200919          690 +1         jb      MB1, ENDD0
0186 304204          691 +1         jnb     PKI2, $+7
0189 D223            692 +1         setb    SLOW
018B D238            693 +1         setb    STOPPED         
018D D252            694 +1         setb    ERRF12_U
018F D259            695 +1         setb    ERRF12_D
0191 0539            696 +1         inc     ERRF12_C
0193 C21A            697 +1                 clr     PKO2                               
0195 C22A            698 +1         clr     PO2U            
0197 C229            699 +1         clr     PO2D              
0199 120D3C          700 +1                 lcall   WRITEPORTS
019C 0203D5          701 +1         ljmp    UP2
019F                 702 +1 ENDD0:
019F 00              703 +1         nop
01A0 200AD6          705            jb      MB2, UP1A     ;-; mame uz 1. spomalovaciu clonku?
                     706 +1         CLR_FLOOR_ERR   ERRF12
01A3 C252            707 +1         clr    ERRF12_U
01A5 C259            708 +1         clr    ERRF12_D
01A7 00              709 +1         nop
                     711 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme      
01A8 120C60          712 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
01AB 120CDD          713 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
01AE 300AFA          714 +1         jnb     MB2, $-3  ; 
01B1 120C60          715 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
01B4 D22E            717            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
01B6 120D3C          718            lcall   WRITEPORTS      ;
01B9 0201BC          719            jmp     UP1_MB2       ;-; a prejdi do stavu UP1_MB2
01BC                 720    UP1_MB2:
                     721 +1         ZAKMITC MB2             ; Pockame, kym odideme z poschodia (Clonky MB1)
DEBUG                                                                                                         PAGE 14

01BC 120C60          722 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
01BF 120CDD          723 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
01C2 300AFA          724 +1         jnb     MB2, $-3  ; 
01C5 120C60          725 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
01C8 120CDD          727    UP1_MB2A: lcall   READPORTS       ; nacitanie dat
                     728 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
01CB 200B03          729 +1         jb      SKRH, $+6
01CE 020BD8          730 +1         ljmp    ERR_SKRH
01D1 00              731 +1         nop
                     733            ;ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na za
                                                                               stavovaciu) <<<
                     734 +1         SET_FLOOR_ERR   MB1, ERRF12, UP2, 2, %COUNT
                     735 +1                                                                                             
                                                                                                                 
                     736 +1                                                                                             
                                                                                                                 
                     737 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0002               738 +1         COUNT    SET    COUNT+1                   
                     739 +1         
01D2 200919          740 +1         jb      MB1, ENDD1
01D5 304204          741 +1         jnb     PKI2, $+7
01D8 D223            742 +1         setb    SLOW
01DA D238            743 +1         setb    STOPPED         
01DC D252            744 +1         setb    ERRF12_U
01DE D259            745 +1         setb    ERRF12_D
01E0 0539            746 +1         inc     ERRF12_C
01E2 C21A            747 +1                 clr     PKO2                               
01E4 C22A            748 +1         clr     PO2U            
01E6 C229            749 +1         clr     PO2D              
01E8 120D3C          750 +1                 lcall   WRITEPORTS
01EB 0203D5          751 +1         ljmp    UP2
01EE                 752 +1 ENDD1:
01EE 00              753 +1         nop
01EF 200AD6          755            jb      MB2, UP1_MB2A  ;-; mame uz aj druhu spomalovaciu clonku?  
                     756 +1         CLR_FLOOR_ERR   ERRF12   
01F2 C252            757 +1         clr    ERRF12_U
01F4 C259            758 +1         clr    ERRF12_D
01F6 00              759 +1         nop
01F7 D22F            761            setb    LEDU            ; Rozsviet LEDku, ze mame druhu MB2
01F9 120D3C          762            lcall   WRITEPORTS      ;   
                     763 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
01FC 120C60          764 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
01FF 120CDD          765 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0202 300AFA          766 +1         jnb     MB2, $-3  ; 
0205 120C60          767 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                     769    ;        mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
                     770    ;        anl     A, #00000100b ;-;
                     771    ;        jz      UP1_MB1       ;-;       Ak nie, chod do stavu UP1_MB1        
                     772 +1         ZASTAV  2, U            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0) 
                     773 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
0208 C3              774 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
0209 7400            775 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
020B 7212            776 +1         orl     C, PI2U      ; | Mam v tomto smere stlacene tlacidlo v sachte?
020D B00E            777 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
DEBUG                                                                                                         PAGE 15

                                                                                za boha nestojim)
020F 7242            778 +1         orl     C, PKI2          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
0211 B052            779 +1         anl     C, /ERRF2_U ; | a mam v tomto smere poruchu na tomto poschodi (Ak ano, tak n
                                                                               ema zmysel stat)
0213 720F            780 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
0215 7238            781 +1         orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
0217 3400            782 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
0219 7054            784            jnz     U1_MB2C       ;-; Ak ano, zastav
                     785 +1         NAJVYSSIE               ; | ..a sme na najvyssom privolanom poschodi? (potom stojime
                                                                                urcite)
021B E522            786 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
021D 33              787 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
021E 547E            788 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
                     789 +1         
                     790 +2         ANLBN   ACC.2, ERRF2_U  ; maskujem chybne poschodia
0220 A2E2            791 +2         mov   C, ACC.2
0222 B052            792 +2         anl   C, /ERRF2_U
0224 92E2            793 +2         mov   ACC.2, C
                     794 +2         ANLBN   ACC.3, ERRF2_U  ; |
0226 A2E3            795 +2         mov   C, ACC.3
0228 B052            796 +2         anl   C, /ERRF2_U
022A 92E3            797 +2         mov   ACC.3, C
                     798 +2         ANLBN   ACC.4, ERRF3_U  ; |
022C A2E4            799 +2         mov   C, ACC.4
022E B053            800 +2         anl   C, /ERRF3_U
0230 92E4            801 +2         mov   ACC.4, C
                     802 +2         ANLBN   ACC.5, ERRF3_U  ; |
0232 A2E5            803 +2         mov   C, ACC.5
0234 B053            804 +2         anl   C, /ERRF3_U
0236 92E5            805 +2         mov   ACC.5, C
                     806 +2         ANLBN   ACC.6, ERRF4_U  ; |
0238 A2E6            807 +2         mov   C, ACC.6
023A B054            808 +2         anl   C, /ERRF4_U
023C 92E6            809 +2         mov   ACC.6, C
                     810 +1         
023E 7805            811 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                     812 +1  ; LL1: 
0240 6006            813 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
0242 C3              814 +1         clr     C               ; Inak shiftnem o 2
0243 13              815 +1         rrc     A               ;
0244 C3              816 +1         clr     C               ;
0245 13              817 +1         rrc     A               ;
0246 D8F8            818 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                     819 +1 ; LL2:
0248 7405            820 +1         mov     A, #5           ; vysledne (najnizsie zvolene) poschodie je index v R0
024A C3              821 +1         clr     C               ;
024B 98              822 +1         subb    A, R0           ;
                     824 +1         LCJNE   A, #2, UP1_MB1  ; |   ak nie, nezastavujeme 
024C B40203          825 +1         cjne    A, #2, $+6
DEBUG                                                                                                         PAGE 16

024F 020255          826 +1         jmp     $+6
0252 020279          827 +1         ljmp    UP1_MB1
0255 00              828 +1         nop
                     830 +1         VYSSIE_KABINA 2         ; | ..ok, sme na najvyssom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
0256 E528            831 +1         mov     A, INPORTA
0258 541E            832 +1         anl     A, #00011110b
025A 852AF0          833 +1         mov     B, ERRFLOOR_U   ; maskujem chybne poschodia
025D 63F0FF          834 +1         xrl     B, #0FFH
0260 55F0            835 +1         anl     A, B
0262 C3              836 +1         clr     C
0263 13              837 +1         rrc     A
                     838 +1 ;LL1    
0264 7802            839 +1         mov     R0, #2
0266 C3              840 +1         clr     C
0267 13              841 +1         rrc     A
0268 D8FC            842 +1         djnz    R0, $-2;LL1
026A 6003            844            jz      U1_MB2C         ; |   ak neni zastavujem         
026C 020279          845            jmp     UP1_MB1          ; |   inak nezastavim        
026F D223            846    U1_MB2C: setb    SLOW            ;       Ak ano, spomalme
0271 C222            847            clr     FAST            ; 
0273 120D3C          848            lcall   WRITEPORTS      ;         
0276 0202B2          849            jmp     UP1_STOP       ;-; a prejdi do stavu UP1_STOP 
0279                 850    UP1_MB1:
                     851 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
0279 120C60          852 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
027C 120CDD          853 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
027F 300AFA          854 +1         jnb     MB2, $-3  ; 
0282 120C60          855 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0285 120CDD          857            lcall   READPORTS       ; nacitanie dat
                     858 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
0288 200B03          859 +1         jb      SKRH, $+6
028B 020BD8          860 +1         ljmp    ERR_SKRH
028E 00              861 +1         nop
                     863            ;ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na sp
                                                                               omalovaciu) <<<
                     864 +1         SET_FLOOR_ERR   MB2, ERRF2, UP2_MB2, 2, %COUNT
                     865 +1                                                                                             
                                                                                                                 
                     866 +1                                                                                             
                                                                                                                 
                     867 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0003               868 +1         COUNT    SET    COUNT+1                   
                     869 +1         
028F 200A19          870 +1         jb      MB2, ENDD2
0292 304204          871 +1         jnb     PKI2, $+7
0295 D223            872 +1         setb    SLOW
0297 D238            873 +1         setb    STOPPED         
0299 D252            874 +1         setb    ERRF2_U
029B D25A            875 +1         setb    ERRF2_D
029D 0536            876 +1         inc     ERRF2_C
029F C21A            877 +1                 clr     PKO2                               
02A1 C22A            878 +1         clr     PO2U            
02A3 C229            879 +1         clr     PO2D              
02A5 120D3C          880 +1                 lcall   WRITEPORTS
02A8 020435          881 +1         ljmp    UP2_MB2
DEBUG                                                                                                         PAGE 17

02AB                 882 +1 ENDD2:
02AB 00              883 +1         nop
02AC 2009CA          885            jb      MB1, UP1_MB1  ;-; Sme na zastavovacej clonke?
                     886    ;        CLR_FLOOR_ERR   ERRF2
                     887            
                     888            ;Ak mame priznak STOPPED a hybeme sa pomaly, zastavme!
                     889    ;        jnb     SLOW, UP1_MB1C
                     890    ;        jnb     STOPPED, UP1_MB1C 
                     891    ;        clr     UP              ; zastav motor
                     892    ;        setb    UPOld           ;       (a zalohuj) 
                     893    ;        clr     DOWNOld         ;       (a zalohuj)
                     894    ;        clr     FAST            ; 
                     895    ;        lcall   WRITEPORTS      ; 
                     896    ;        jmp     FLOOR2        ;-; a prejdi do stavu FLOOR2
                     897             
02AF 0203D5          898    UP1_MB1C: ljmp    UP2             ; |   inak nezastavim        
                     899    
02B2                 900    UP1_STOP:
02B2 120CDD          901            lcall   READPORTS       ; nacitanie dat
                     902 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
02B5 200B03          903 +1         jb      SKRH, $+6
02B8 020BD8          904 +1         ljmp    ERR_SKRH
02BB 00              905 +1         nop
                     907            ;ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na sp
                                                                               omalovaciu) <<<
                     908 +1         SET_FLOOR_ERR   MB2, ERRF2, UP2_MB2, 2, %COUNT
                     909 +1                                                                                             
                                                                                                                 
                     910 +1                                                                                             
                                                                                                                 
                     911 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0004               912 +1         COUNT    SET    COUNT+1                   
                     913 +1         
02BC 200A19          914 +1         jb      MB2, ENDD3
02BF 304204          915 +1         jnb     PKI2, $+7
02C2 D223            916 +1         setb    SLOW
02C4 D238            917 +1         setb    STOPPED         
02C6 D252            918 +1         setb    ERRF2_U
02C8 D25A            919 +1         setb    ERRF2_D
02CA 0536            920 +1         inc     ERRF2_C
02CC C21A            921 +1                 clr     PKO2                               
02CE C22A            922 +1         clr     PO2U            
02D0 C229            923 +1         clr     PO2D              
02D2 120D3C          924 +1                 lcall   WRITEPORTS
02D5 020435          925 +1         ljmp    UP2_MB2
02D8                 926 +1 ENDD3:
02D8 00              927 +1         nop
02D9 2009D6          929            jb      MB1, UP1_STOP  ;-; Sme na zastavovacej clonke?      
                     930    ;        CLR_FLOOR_ERR   ERRF2
02DC C220            931            clr     UP              ; zastav motor
02DE D23A            932            setb    UPOld           ;       (a zalohuj) 
02E0 C23B            933            clr     DOWNOld         ;       (a zalohuj)
02E2 C222            934            clr     FAST            ; 
02E4 120D3C          935            lcall   WRITEPORTS      ; 
02E7 0202EA          936            jmp     FLOOR2        ;-; a prejdi do stavu FLOOR2   
                     937    
                     938    ;------------------------------------------------------------------------------- << 2. posch
                                                                               odie >>
DEBUG                                                                                                         PAGE 18

                     939    
02EA                 940    FLOOR2:
                     941 +1                 POLOHA_LED 2  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
02EA C22F            942 +1         clr     LEDU            
02EC C22E            943 +1         clr     LEDD 
02EE C224            944 +1         clr     FLED1             
02F0 C225            945 +1         clr     FLED2                
02F2 C226            946 +1         clr     FLED3           
02F4 C227            947 +1         clr     FLED4           
02F6 D225            948 +1         setb    FLED2
02F8 120D3C          949 +1         lcall   WRITEPORTS
02FB 120C95          951            lcall   WAITFORTIMER    ; simulacia TIMERu
02FE 120CDD          952    F2S:    lcall   READPORTS     ;-; nacitanie dat
0301 C21A            953            clr     PKO2          ;-; vynulovanie volby poschodia na ktorom stojim
0303 C22A            954            clr     PO2U            ;
0305 C229            955            clr     PO2D            ;
0307 120D3C          956            lcall   WRITEPORTS      ;
030A 200FF1          957            jb      DPK, F2S        ; Mam pretazenu kabinu? (Ak ano, tak sa nepohnem)
                     958            ;_BP_
030D 782A            959            mov     R0, #ERRFLOOR_U ;   Default predpokladam, ze mam namierene hore (pozeram por
                                                                               uchy poschodia smerom hore)
030F 79F8            960            mov     R1, #11111000b  ;-; Default predpokladam, ze mam namierene hore (na 3. a 4.)
                                                                                kabina
0311 7AF8            961            mov     R2, #11111000b  ;-; Default predpokladam, ze mam namierene hore (na 3. a 4.)
                                                                                sachta
0313 203A0A          962            jb      UPOld, F2OK     ;   Je to pravda? Naozaj som doteraz isiel hore?
0316 E9              963            mov     A, R1           ;       Ak nie, znegujeme masku kabiny
0317 F4              964            cpl     A               ;       |
0318 F9              965            mov     R1, A           ;       |
0319 EA              966            mov     A, R2           ;       A znegujeme aj masku sachty
031A F4              967            cpl     A               ;       |
031B FA              968            mov     R2, A           ;       |  
031C E8              969            mov     A, R0           ;       A budeme pozerat poruchy poschodi smerom DOLE (ERRFL
                                                                               OOR_U+1 = ERRFLOOR_D)
031D 6401            970            xrl     A, #01h         ;       | Znegujem posledny bit adresy registra s poruchovym
                                                                               i poschodiami (ERRFLOOR_U na ERRFLOOR_D a
                                                                                naopak)
031F F8              971            mov     R0, A           ;       |  
0320                 972    F2OK:   ; Pohyb v jednom smere (nevieme v ktorom)
0320 E528            973            mov     A, INPORTA      ; zistenie, ci bolo stlacene nieco viac (menej) ako poschodi
                                                                               e na ktorom stojim (Kabina)
0322 86F0            974            mov     B, @R0          ;  | Maskujem chybne poschodia
0324 63F0FF          975            xrl     B, #0FFH        ;  |
0327 55F0            976            anl     A, B            ;  |
0329 541A            977            anl     A, #00011010b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
032B 59              978            anl     A, R1           ;  | 
                     979 +1         ljnz     F2              ; nasli sme poschodie v tomto smere, mozme ist
032C 6003            980 +1         jz      $+5
032E 0203B7          981 +1         ljmp    F2
0331 00              982 +1         nop
                     984                                    ; zistenie, ci bolo stlacene nieco viac (menej) ako poschodi
                                                                               e na ktorom stojim (Sachta)
0332 E528            985            mov     A, INPORTA      ; Mam v kabine nieco stlacene?
0334 86F0            986            mov     B, @R0          ;  | Maskujem chybne poschodia
0336 63F0FF          987            xrl     B, #0FFH        ;  | |
0339 55F0            988            anl     A, B            ;  | |
033B 541A            989            anl     A, #00011010b   ;  | Beriem iba bity predstavujuce tlacidla poschodi (kabina
DEBUG                                                                                                         PAGE 19

                                                                               ) 
033D 702D            990            jnz     F2SW            ;  | Ak ano, idem rovno zistovat opacny smer.
033F E522            991            mov     A, INPORTC      ; Mam stlacene nieco v sachte (mojim smerom)?    
0341 5439            992            anl     A, #00111001b   ;  | Beriem iba bity predstavujuce tlacidla privolavacov
0343 5A              993            anl     A, R2           ;  |   
0344 86F0            994            mov     B, @R0          ;  | Maskujem chybne poschodia (v smere hore)      
                     995 +1         ANLBN   ACC.0, B.1      ;  | 
0346 A2E0            996 +1         mov   C, ACC.0
0348 B0F1            997 +1         anl   C, /B.1
034A 92E0            998 +1         mov   ACC.0, C
                    1000 +1         ANLBN   ACC.1, B.2      ;  | 
034C A2E1           1001 +1         mov   C, ACC.1
034E B0F2           1002 +1         anl   C, /B.2
0350 92E1           1003 +1         mov   ACC.1, C
                    1005 +1         ANLBN   ACC.2, B.2      ;  |
0352 A2E2           1006 +1         mov   C, ACC.2
0354 B0F2           1007 +1         anl   C, /B.2
0356 92E2           1008 +1         mov   ACC.2, C
                    1010 +1         ANLBN   ACC.3, B.3      ;  |
0358 A2E3           1011 +1         mov   C, ACC.3
035A B0F3           1012 +1         anl   C, /B.3
035C 92E3           1013 +1         mov   ACC.3, C
                    1015 +1         ANLBN   ACC.4, B.3      ;  |
035E A2E4           1016 +1         mov   C, ACC.4
0360 B0F3           1017 +1         anl   C, /B.3
0362 92E4           1018 +1         mov   ACC.4, C
                    1020 +1         ANLBN   ACC.5, B.4      ;  |
0364 A2E5           1021 +1         mov   C, ACC.5
0366 B0F4           1022 +1         anl   C, /B.4
0368 92E5           1023 +1         mov   ACC.5, C
036A 704B           1025            jnz     F2              ; nasli sme poschodie v tomto smere, mozme ist
                    1026            ; Pohyb v opacnom smere (nevieme v ktorom)
036C E8             1027    F2SW:   mov     A, R0           ;  Znegujem posledny bit adresy registra s poruchovymi posch
                                                                               odiami (ERRFLOOR_U na ERRFLOOR_D a naopak
                                                                               )
036D 6401           1028            xrl     A, #01h         ;  |
036F F8             1029            mov     R0, A           ;  |
0370 B23A           1030            cpl     UPOld           ;  Znegujem stary posun
0372 B23B           1031            cpl     DOWNOld         ;  |
0374 E9             1032            mov     A, R1           ;  Znegujeme masky
0375 F4             1033            cpl     A               ;  |
0376 F9             1034            mov     R1, A           ;  |
0377 EA             1035            mov     A, R2           ;  |
0378 F4             1036            cpl     A               ;  |
0379 FA             1037            mov     R2, A           ;  |               
037A E528           1038            mov     A, INPORTA      ; zistenie, cibolo stlacene nieco viac ako poschodie na ktor
                                                                               om stojim (Kabina)
037C 86F0           1039            mov     B, @R0          ;  | Maskujem chybne poschodia
037E 63F0FF         1040            xrl     B, #0FFH        ;  | |
0381 55F0           1041            anl     A, B            ;  | |
0383 541A           1042            anl     A, #00011010b   ;  | Beriem iba bity predstavujuce tlacidla poschodi   
0385 59             1043            anl     A, R1           ;  | 
0386 702F           1044            jnz     F2              ; nasli sme poschodie v tomto smere, mozme ist
0388 E522           1045            mov     A, INPORTC      ; zistenie, cibolo stlacene nieco viac ako poschodie na ktor
                                                                               om stojim (Sachta)
038A 5439           1046            anl     A, #00111001b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
038C 5A             1047            anl     A, R2           ;  | 
038D 86F0           1048            mov     B, @R0          ;  | Maskujem chybne poschodia (v smere hore)      
DEBUG                                                                                                         PAGE 20

                    1049 +1         ANLBN   ACC.0, B.1      ;  | 
038F A2E0           1050 +1         mov   C, ACC.0
0391 B0F1           1051 +1         anl   C, /B.1
0393 92E0           1052 +1         mov   ACC.0, C
                    1054 +1         ANLBN   ACC.1, B.2      ;  | 
0395 A2E1           1055 +1         mov   C, ACC.1
0397 B0F2           1056 +1         anl   C, /B.2
0399 92E1           1057 +1         mov   ACC.1, C
                    1059 +1         ANLBN   ACC.2, B.2      ;  |
039B A2E2           1060 +1         mov   C, ACC.2
039D B0F2           1061 +1         anl   C, /B.2
039F 92E2           1062 +1         mov   ACC.2, C
                    1064 +1         ANLBN   ACC.3, B.3      ;  |
03A1 A2E3           1065 +1         mov   C, ACC.3
03A3 B0F3           1066 +1         anl   C, /B.3
03A5 92E3           1067 +1         mov   ACC.3, C
                    1069 +1         ANLBN   ACC.4, B.3      ;  |
03A7 A2E4           1070 +1         mov   C, ACC.4
03A9 B0F3           1071 +1         anl   C, /B.3
03AB 92E4           1072 +1         mov   ACC.4, C
                    1074 +1         ANLBN   ACC.5, B.4      ;  |
03AD A2E5           1075 +1         mov   C, ACC.5
03AF B0F4           1076 +1         anl   C, /B.4
03B1 92E5           1077 +1         mov   ACC.5, C
03B3 7002           1079            jnz     F2              ; nasli sme poschodie v tomto smere, mozme ist
03B5 41FE           1080            jmp     F2S           ;-; nemame sa kde hybat, tak opakujeme zistovanie
03B7 203A03         1081    F2:     jb      UPOld, F2UP     ;   
03BA 0203C9         1082            jmp     F2DOWN          ;
03BD D220           1083    F2UP:   setb    UP              ; rychly pohyb hore
03BF D222           1084            setb    FAST            ; 
03C1 C223           1085            clr     SLOW            ;
03C3 120D3C         1086            lcall   WRITEPORTS      ; 
03C6 0203D5         1087            jmp     UP2           ;-; prejdi do stavu UP2    
03C9 D221           1088    F2DOWN: setb    DOWN            ; rychly pohyb hore
03CB D222           1089            setb    FAST            ; 
03CD C223           1090            clr     SLOW            ;
03CF 120D3C         1091            lcall   WRITEPORTS      ; 
03D2 020557         1092            jmp     DOWN2         ;-; prejdi do stavu DOWN2    
                    1093            
                    1094                
03D5                1095    UP2:
                    1096 +1                 POLOHA_LED 2  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
03D5 C22F           1097 +1         clr     LEDU            
03D7 C22E           1098 +1         clr     LEDD 
03D9 C224           1099 +1         clr     FLED1             
03DB C225           1100 +1         clr     FLED2                
03DD C226           1101 +1         clr     FLED3           
03DF C227           1102 +1         clr     FLED4           
03E1 D225           1103 +1         setb    FLED2
03E3 120D3C         1104 +1         lcall   WRITEPORTS
                    1106 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
03E6 120C60         1107 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
03E9 120CDD         1108 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
03EC 3009FA         1109 +1         jnb     MB1, $-3  ; 
03EF 120C60         1110 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
03F2 120CDD         1112    UP2A:   lcall   READPORTS       ; nacitanie dat
DEBUG                                                                                                         PAGE 21

                    1113 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
03F5 200B03         1114 +1         jb      SKRH, $+6
03F8 020BD8         1115 +1         ljmp    ERR_SKRH
03FB 00             1116 +1         nop
                    1118            ;ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na 
                                                                               zastavovaciu) <<<
                    1119 +1         SET_FLOOR_ERR   MB1, ERRF23, UP3, 3, %COUNT
                    1120 +1                                                                                             
                                                                                                                 
                    1121 +1                                                                                             
                                                                                                                 
                    1122 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0005              1123 +1         COUNT    SET    COUNT+1                   
                    1124 +1         
03FC 200919         1125 +1         jb      MB1, ENDD4
03FF 304304         1126 +1         jnb     PKI3, $+7
0402 D223           1127 +1         setb    SLOW
0404 D238           1128 +1         setb    STOPPED         
0406 D253           1129 +1         setb    ERRF23_U
0408 D25A           1130 +1         setb    ERRF23_D
040A 053A           1131 +1         inc     ERRF23_C
040C C21B           1132 +1                 clr     PKO3                               
040E C22C           1133 +1         clr     PO3U            
0410 C22B           1134 +1         clr     PO3D              
0412 120D3C         1135 +1                 lcall   WRITEPORTS
0415 020736         1136 +1         ljmp    UP3
0418                1137 +1 ENDD4:
0418 00             1138 +1         nop
0419 200AD6         1140            jb      MB2, UP2A     ;-; mame uz 1. spomalovaciu clonku?
                    1141 +1         CLR_FLOOR_ERR   ERRF23
041C C253           1142 +1         clr    ERRF23_U
041E C25A           1143 +1         clr    ERRF23_D
0420 00             1144 +1         nop
                    1146 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
0421 120C60         1147 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0424 120CDD         1148 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0427 300AFA         1149 +1         jnb     MB2, $-3  ; 
042A 120C60         1150 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
042D D22E           1152            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
042F 120D3C         1153            lcall   WRITEPORTS      ;
0432 020435         1154            jmp     UP2_MB2       ;-; a prejdi do stavu UP2_MB2
0435                1155    UP2_MB2:
                    1156 +1         ZAKMITC MB2             ; Pockame, kym odideme z predchadzajucej clonky       
0435 120C60         1157 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0438 120CDD         1158 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
043B 300AFA         1159 +1         jnb     MB2, $-3  ; 
043E 120C60         1160 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0441 120CDD         1162    UP2_MB2A: lcall   READPORTS       ; nacitanie dat
                    1163 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
0444 200B03         1164 +1         jb      SKRH, $+6
0447 020BD8         1165 +1         ljmp    ERR_SKRH
044A 00             1166 +1         nop
                    1168            ;ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na za
                                                                               stavovaciu) <<<
                    1169 +1         SET_FLOOR_ERR   MB1, ERRF23, UP3, 3, %COUNT
                    1170 +1                                                                                             
DEBUG                                                                                                         PAGE 22

                                                                                                                 
                    1171 +1                                                                                             
                                                                                                                 
                    1172 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0006              1173 +1         COUNT    SET    COUNT+1                   
                    1174 +1         
044B 200919         1175 +1         jb      MB1, ENDD5
044E 304304         1176 +1         jnb     PKI3, $+7
0451 D223           1177 +1         setb    SLOW
0453 D238           1178 +1         setb    STOPPED         
0455 D253           1179 +1         setb    ERRF23_U
0457 D25A           1180 +1         setb    ERRF23_D
0459 053A           1181 +1         inc     ERRF23_C
045B C21B           1182 +1                 clr     PKO3                               
045D C22C           1183 +1         clr     PO3U            
045F C22B           1184 +1         clr     PO3D              
0461 120D3C         1185 +1                 lcall   WRITEPORTS
0464 020736         1186 +1         ljmp    UP3
0467                1187 +1 ENDD5:
0467 00             1188 +1         nop
0468 200AD6         1190            jb      MB2, UP2_MB2A  ;-; mame uz aj druhu spomalovaciu clonku?   
                    1191 +1         CLR_FLOOR_ERR   ERRF23       
046B C253           1192 +1         clr    ERRF23_U
046D C25A           1193 +1         clr    ERRF23_D
046F 00             1194 +1         nop
0470 D22F           1196            setb    LEDU            ; Rozsviet LEDku, ze mame druhu MB2
0472 120D3C         1197            lcall   WRITEPORTS      ;
                    1198 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
0475 120C60         1199 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0478 120CDD         1200 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
047B 300AFA         1201 +1         jnb     MB2, $-3  ; 
047E 120C60         1202 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                    1204    ;        mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
                    1205    ;        anl     A, #00001000b ;-;
                    1206    ;        jz      UP2_MB1       ;-;       Ak nie, chod do stavu UP2_MB1
                    1207 +1         ZASTAV  3, U            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0)
                    1208 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
0481 C3             1209 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
0482 7400           1210 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
0484 7214           1211 +1         orl     C, PI3U      ; | Mam v tomto smere stlacene tlacidlo v sachte?
0486 B00E           1212 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
0488 7243           1213 +1         orl     C, PKI3          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
048A B053           1214 +1         anl     C, /ERRF3_U ; | a mam v tomto smere poruchu na tomto poschodi (Ak ano, tak n
                                                                               ema zmysel stat)
048C 720F           1215 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
048E 7238           1216 +1         orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
0490 3400           1217 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
0492 7054           1219            jnz     U2_MB2C       ;-; Ak ano, zastav
                    1220 +1         NAJVYSSIE               ; | ..a sme na najvyssom privolanom poschodi z kabiny? (poto
                                                                               m stojime urcite)
DEBUG                                                                                                         PAGE 23

0494 E522           1221 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
0496 33             1222 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
0497 547E           1223 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
                    1224 +1         
                    1225 +2         ANLBN   ACC.2, ERRF2_U  ; maskujem chybne poschodia
0499 A2E2           1226 +2         mov   C, ACC.2
049B B052           1227 +2         anl   C, /ERRF2_U
049D 92E2           1228 +2         mov   ACC.2, C
                    1229 +2         ANLBN   ACC.3, ERRF2_U  ; |
049F A2E3           1230 +2         mov   C, ACC.3
04A1 B052           1231 +2         anl   C, /ERRF2_U
04A3 92E3           1232 +2         mov   ACC.3, C
                    1233 +2         ANLBN   ACC.4, ERRF3_U  ; |
04A5 A2E4           1234 +2         mov   C, ACC.4
04A7 B053           1235 +2         anl   C, /ERRF3_U
04A9 92E4           1236 +2         mov   ACC.4, C
                    1237 +2         ANLBN   ACC.5, ERRF3_U  ; |
04AB A2E5           1238 +2         mov   C, ACC.5
04AD B053           1239 +2         anl   C, /ERRF3_U
04AF 92E5           1240 +2         mov   ACC.5, C
                    1241 +2         ANLBN   ACC.6, ERRF4_U  ; |
04B1 A2E6           1242 +2         mov   C, ACC.6
04B3 B054           1243 +2         anl   C, /ERRF4_U
04B5 92E6           1244 +2         mov   ACC.6, C
                    1245 +1         
04B7 7805           1246 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                    1247 +1  ; LL1: 
04B9 6006           1248 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
04BB C3             1249 +1         clr     C               ; Inak shiftnem o 2
04BC 13             1250 +1         rrc     A               ;
04BD C3             1251 +1         clr     C               ;
04BE 13             1252 +1         rrc     A               ;
04BF D8F8           1253 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                    1254 +1 ; LL2:
04C1 7405           1255 +1         mov     A, #5           ; vysledne (najnizsie zvolene) poschodie je index v R0
04C3 C3             1256 +1         clr     C               ;
04C4 98             1257 +1         subb    A, R0           ;
                    1259 +1         LCJNE   A, #3, UP2_MB1  ; |   ak nie, nezastavujeme  
04C5 B40303         1260 +1         cjne    A, #3, $+6
04C8 0204CE         1261 +1         jmp     $+6
04CB 0204F2         1262 +1         ljmp    UP2_MB1
04CE 00             1263 +1         nop
                    1265 +1         VYSSIE_KABINA 3         ; | ..ok, sme na najvyssom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
04CF E528           1266 +1         mov     A, INPORTA
04D1 541E           1267 +1         anl     A, #00011110b
04D3 852AF0         1268 +1         mov     B, ERRFLOOR_U   ; maskujem chybne poschodia
04D6 63F0FF         1269 +1         xrl     B, #0FFH
04D9 55F0           1270 +1         anl     A, B
04DB C3             1271 +1         clr     C
04DC 13             1272 +1         rrc     A
                    1273 +1 ;LL1    
DEBUG                                                                                                         PAGE 24

04DD 7803           1274 +1         mov     R0, #3
04DF C3             1275 +1         clr     C
04E0 13             1276 +1         rrc     A
04E1 D8FC           1277 +1         djnz    R0, $-2;LL1
04E3 6003           1279            jz      U2_MB2C         ; |   ak neni zastavujem  
04E5 0204F2         1280            ljmp    UP2_MB1         ; |   inak nezastavim
04E8 D223           1281    U2_MB2C: setb    SLOW            ;       Ak ano, spomalme
04EA C222           1282            clr     FAST            ; 
04EC 120D3C         1283            lcall   WRITEPORTS      ;
04EF 02051F         1284            jmp     UP2_STOP       ;-; a prejdi do stavu UP2_STOP 
04F2                1285    UP2_MB1:
04F2 120CDD         1286            lcall   READPORTS       ; nacitanie dat
                    1287 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
04F5 200B03         1288 +1         jb      SKRH, $+6
04F8 020BD8         1289 +1         ljmp    ERR_SKRH
04FB 00             1290 +1         nop
                    1292            ;ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na sp
                                                                               omalovaciu) <<<
                    1293 +1         SET_FLOOR_ERR   MB2, ERRF3, UP3_MB2, 3, %COUNT
                    1294 +1                                                                                             
                                                                                                                 
                    1295 +1                                                                                             
                                                                                                                 
                    1296 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0007              1297 +1         COUNT    SET    COUNT+1                   
                    1298 +1         
04FC 200A19         1299 +1         jb      MB2, ENDD6
04FF 304304         1300 +1         jnb     PKI3, $+7
0502 D223           1301 +1         setb    SLOW
0504 D238           1302 +1         setb    STOPPED         
0506 D253           1303 +1         setb    ERRF3_U
0508 D25B           1304 +1         setb    ERRF3_D
050A 0537           1305 +1         inc     ERRF3_C
050C C21B           1306 +1                 clr     PKO3                               
050E C22C           1307 +1         clr     PO3U            
0510 C22B           1308 +1         clr     PO3D              
0512 120D3C         1309 +1                 lcall   WRITEPORTS
0515 0207A9         1310 +1         ljmp    UP3_MB2
0518                1311 +1 ENDD6:
0518 00             1312 +1         nop
0519 2009D6         1314            jb      MB1, UP2_MB1  ;-; Sme na zastavovacej clonke?
                    1315    ;        CLR_FLOOR_ERR   ERRF3
                    1316            
                    1317    ;        ZASTAV  3, U            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               (Vrati do A 1 ak ano, inak 0)
                    1318    ;        clr     STOPPED         ; Priznak STOPPED vynulujem, uz som ho osetril
                    1319    ;        jnz     U2_MB1C       ;-; Ak ano, zastav
                    1320    ;        NAJVYSSIE               ; | ..a sme na najvyssom privolanom poschodi z kabiny? (pot
                                                                               om stojime urcite)
                    1321    ;        LCJNE   A, #3, UP3      ; |   ak nie, nezastavujeme  
                    1322    ;        VYSSIE_KABINA 3         ; | ..ok, sme na najvyssom privolanom poschodi z kabiny ale
                                                                                neni nad nami uz nic v kabine stlacene? 
                                                                               
                    1323    ;        jz      U2_MB1C         ; |   ak neni zastavujem  
051C 020736         1324            ljmp    UP3             ; |   inak nezastavim
                    1325    ;U2_MB1C: clr     UP              ; zastav motor
                    1326    ;        setb    UPOld           ;       (a zalohuj)
                    1327    ;        clr     DOWNOld         ;       (a zalohuj)
DEBUG                                                                                                         PAGE 25

                    1328    ;        clr     FAST            ; 
                    1329    ;        lcall   WRITEPORTS      ; 
                    1330    ;        jmp     FLOOR3        ;-; a prejdi do stavu FLOOR3
051F                1331    UP2_STOP:
051F 120CDD         1332            lcall   READPORTS       ; nacitanie dat
                    1333 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
0522 200B03         1334 +1         jb      SKRH, $+6
0525 020BD8         1335 +1         ljmp    ERR_SKRH
0528 00             1336 +1         nop
                    1338            ;ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na sp
                                                                               omalovaciu) <<<
                    1339 +1         SET_FLOOR_ERR   MB2, ERRF3, UP3_MB2, 3, %COUNT
                    1340 +1                                                                                             
                                                                                                                 
                    1341 +1                                                                                             
                                                                                                                 
                    1342 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0008              1343 +1         COUNT    SET    COUNT+1                   
                    1344 +1         
0529 200A19         1345 +1         jb      MB2, ENDD7
052C 304304         1346 +1         jnb     PKI3, $+7
052F D223           1347 +1         setb    SLOW
0531 D238           1348 +1         setb    STOPPED         
0533 D253           1349 +1         setb    ERRF3_U
0535 D25B           1350 +1         setb    ERRF3_D
0537 0537           1351 +1         inc     ERRF3_C
0539 C21B           1352 +1                 clr     PKO3                               
053B C22C           1353 +1         clr     PO3U            
053D C22B           1354 +1         clr     PO3D              
053F 120D3C         1355 +1                 lcall   WRITEPORTS
0542 0207A9         1356 +1         ljmp    UP3_MB2
0545                1357 +1 ENDD7:
0545 00             1358 +1         nop
0546 2009D6         1360            jb      MB1, UP2_STOP  ;-; Sme na zastavovacej clonke? 
                    1361    ;        CLR_FLOOR_ERR   ERRF3    
0549 C220           1362            clr     UP              ; zastav motor
054B D23A           1363            setb    UPOld           ;       (a zalohuj)
054D C23B           1364            clr     DOWNOld         ;       (a zalohuj)
054F C222           1365            clr     FAST            ; 
0551 120D3C         1366            lcall   WRITEPORTS      ; 
0554 02064B         1367            jmp     FLOOR3        ;-; a prejdi do stavu FLOO
                    1368            
0557                1369    DOWN2:
                    1370 +1                 POLOHA_LED 2  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
0557 C22F           1371 +1         clr     LEDU            
0559 C22E           1372 +1         clr     LEDD 
055B C224           1373 +1         clr     FLED1             
055D C225           1374 +1         clr     FLED2                
055F C226           1375 +1         clr     FLED3           
0561 C227           1376 +1         clr     FLED4           
0563 D225           1377 +1         setb    FLED2
0565 120D3C         1378 +1         lcall   WRITEPORTS
                    1380 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
0568 120C60         1381 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
056B 120CDD         1382 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
056E 3009FA         1383 +1         jnb     MB1, $-3  ; 
0571 120C60         1384 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
DEBUG                                                                                                         PAGE 26

                                                                               zliezli)
0574 120CDD         1386            lcall   READPORTS       ; nacitanie dat
                    1387 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
0577 200C03         1388 +1         jb      SKRD, $+6
057A 020BCF         1389 +1         ljmp    ERR_SKRD
057D 00             1390 +1         nop
                    1392            ;ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na 
                                                                               zastavovaciu) <<<
                    1393 +1         SET_FLOOR_ERR   MB1, ERRF12, DOWN2ERR, 1, %COUNT
                    1394 +1                                                                                             
                                                                                                                 
                    1395 +1                                                                                             
                                                                                                                 
                    1396 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0009              1397 +1         COUNT    SET    COUNT+1                   
                    1398 +1         
057E 200919         1399 +1         jb      MB1, ENDD8
0581 304104         1400 +1         jnb     PKI1, $+7
0584 D223           1401 +1         setb    SLOW
0586 D238           1402 +1         setb    STOPPED         
0588 D252           1403 +1         setb    ERRF12_U
058A D259           1404 +1         setb    ERRF12_D
058C 0539           1405 +1         inc     ERRF12_C
058E C219           1406 +1                 clr     PKO1                               
0590 C228           1407 +1         clr     PO1U            
0592 C228           1408 +1         clr     PO1D              
0594 120D3C         1409 +1                 lcall   WRITEPORTS
0597 02059E         1410 +1         ljmp    DOWN2ERR
059A                1411 +1 ENDD8:
059A 00             1412 +1         nop
059B 0205AD         1414            jmp     DOWN2ERR_CONTINUE
059E                1415    DOWN2ERR:
059E C221           1416            clr     DOWN            ; zastav motor
05A0 D23B           1417            setb    DOWNOld         ;       (a zalohuj)
05A2 C23A           1418            clr     UPOld           ;       (a zalohuj)
05A4 C222           1419            clr     FAST            ; 
05A6 C223           1420            clr     SLOW            ;
05A8 120D3C         1421            lcall   WRITEPORTS      ; 
05AB 01FB           1422            jmp     FLOOR1        ;-; a prejdi do stavu FLOOR1 
05AD                1423    DOWN2ERR_CONTINUE:
05AD 200AA7         1424            jb      MB2, DOWN2    ;-; mame uz 1. spomalovaciu clonku?
                    1425 +1         CLR_FLOOR_ERR   ERRF12
05B0 C252           1426 +1         clr    ERRF12_U
05B2 C259           1427 +1         clr    ERRF12_D
05B4 00             1428 +1         nop
                    1430 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme      
05B5 120C60         1431 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
05B8 120CDD         1432 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
05BB 300AFA         1433 +1         jnb     MB2, $-3  ; 
05BE 120C60         1434 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
05C1 D22F           1436            setb    LEDU            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
05C3 120D3C         1437            lcall   WRITEPORTS      ;
05C6 0205C9         1438            jmp     DOWN2_MB2     ;-; a prejdi do stavu DOWN2_MB2
05C9                1439    DOWN2_MB2:
                    1440 +1         ZAKMITC MB2             ; Pockame, kym odideme z predchadzajucej clonky       
05C9 120C60         1441 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
05CC 120CDD         1442 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
DEBUG                                                                                                         PAGE 27

05CF 300AFA         1443 +1         jnb     MB2, $-3  ; 
05D2 120C60         1444 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
05D5                1446    DOWN2_MB2A:
05D5 120CDD         1447            lcall   READPORTS       ; nacitanie dat
                    1448 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
05D8 200C03         1449 +1         jb      SKRD, $+6
05DB 020BCF         1450 +1         ljmp    ERR_SKRD
05DE 00             1451 +1         nop
                    1453            ;ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na za
                                                                               stavovaciu) <<<
                    1454 +1         SET_FLOOR_ERR   MB1, ERRF12, DOWN2_MB2ERR, 1, %COUNT
                    1455 +1                                                                                             
                                                                                                                 
                    1456 +1                                                                                             
                                                                                                                 
                    1457 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  000A              1458 +1         COUNT    SET    COUNT+1                   
                    1459 +1         
05DF 200919         1460 +1         jb      MB1, ENDD9
05E2 304104         1461 +1         jnb     PKI1, $+7
05E5 D223           1462 +1         setb    SLOW
05E7 D238           1463 +1         setb    STOPPED         
05E9 D252           1464 +1         setb    ERRF12_U
05EB D259           1465 +1         setb    ERRF12_D
05ED 0539           1466 +1         inc     ERRF12_C
05EF C219           1467 +1                 clr     PKO1                               
05F1 C228           1468 +1         clr     PO1U            
05F3 C228           1469 +1         clr     PO1D              
05F5 120D3C         1470 +1                 lcall   WRITEPORTS
05F8 0205FF         1471 +1         ljmp    DOWN2_MB2ERR
05FB                1472 +1 ENDD9:
05FB 00             1473 +1         nop
05FC 02060E         1475            jmp     DOWN2_MB2ERR_CONTINUE
05FF                1476    DOWN2_MB2ERR:
05FF C221           1477            clr     DOWN            ; zastav motor
0601 D23B           1478            setb    DOWNOld         ;       (a zalohuj)
0603 C23A           1479            clr     UPOld           ;       (a zalohuj)
0605 C222           1480            clr     FAST            ; 
0607 C223           1481            clr     SLOW            ;
0609 120D3C         1482            lcall   WRITEPORTS      ; 
060C 01FB           1483            jmp     FLOOR1        ;-; a prejdi do stavu FLOOR1 
060E                1484    DOWN2_MB2ERR_CONTINUE:
060E 200AC4         1485            jb      MB2, DOWN2_MB2A ;-; mame uz aj druhu spomalovaciu clonku?    
                    1486 +1         CLR_FLOOR_ERR   ERRF12      
0611 C252           1487 +1         clr    ERRF12_U
0613 C259           1488 +1         clr    ERRF12_D
0615 00             1489 +1         nop
0616 D22E           1491            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame druhu MB2
0618 120D3C         1492            lcall   WRITEPORTS      ;
                    1493 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
061B 120C60         1494 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
061E 120CDD         1495 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0621 300AFA         1496 +1         jnb     MB2, $-3  ; 
0624 120C60         1497 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                    1499    ;        mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
                    1500    ;        anl     A, #00000010b ;-;
DEBUG                                                                                                         PAGE 28

                    1501    ;        jz      DOWN2_MB1     ;-;       Ak nie, chod do stavu DOWN2_MB1
0627 D223           1502            setb    SLOW            ;       Ak ano, spomalme
0629 C222           1503            clr     FAST            ; 
062B 120D3C         1504            lcall   WRITEPORTS      ;
062E 020631         1505            jmp     DOWN2_MB1     ;-; a prejdi do stavu DOWN2_MB1
0631                1506    DOWN2_MB1:    
0631 120CDD         1507            lcall   READPORTS       ; nacitanie dat
0634 300C05         1508            jnb     SKRD, D2_MB1C   ; Sme na hornej porovnavacej clonke? (tu zastavujeme v kazdo
                                                                               m pripade)
0637 300902         1509            jnb     MB1, D2_MB1C  ;-; Sme na zastavovacej clonke? (tu zastavujeme v kazdom pripa
                                                                               de)
063A 80F5           1510            jmp     DOWN2_MB1       ; Ak sme nechytili ani jednu clonku, opakujeme
063C C238           1511    D2_MB1C: clr     STOPPED         ; Priznak STOPPED vynulujem, uz som ho osetril
063E C221           1512            clr     DOWN            ; zastav motor
0640 D23B           1513            setb    DOWNOld         ;       (a zalohuj)
0642 C23A           1514            clr     UPOld           ;       (a zalohuj)
0644 C222           1515            clr     FAST            ; 
0646 120D3C         1516            lcall   WRITEPORTS      ; 
0649 01FB           1517            jmp     FLOOR1        ;-; a prejdi do stavu FLOOR2      
                    1518    
                    1519    
                    1520    ;------------------------------------------------------------------------------- << 3. posch
                                                                               odie >>
                    1521    
064B                1522    FLOOR3:
                    1523 +1                 POLOHA_LED 3  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
064B C22F           1524 +1         clr     LEDU            
064D C22E           1525 +1         clr     LEDD 
064F C224           1526 +1         clr     FLED1             
0651 C225           1527 +1         clr     FLED2                
0653 C226           1528 +1         clr     FLED3           
0655 C227           1529 +1         clr     FLED4           
0657 D226           1530 +1         setb    FLED3
0659 120D3C         1531 +1         lcall   WRITEPORTS
065C 120C95         1533            lcall   WAITFORTIMER    ; simulacia TIMERu
065F 120CDD         1534    F3S:    lcall   READPORTS     ;-; nacitanie dat
0662 C21B           1535            clr     PKO3          ;-; vynulovanie volby poschodia na ktorom stojim
0664 C22C           1536            clr     PO3U            ;
0666 C22B           1537            clr     PO3D            ;
0668 120D3C         1538            lcall   WRITEPORTS      ;
066B 200FF1         1539            jb      DPK, F3S        ; Mam pretazenu kabinu? (Ak ano, tak sa nepohnem)
066E 782A           1540            mov     R0, #ERRFLOOR_U ; Default predpokladam, ze mam namierene hore (pozeram poruc
                                                                               hy poschodia smerom hore)
0670 79F0           1541            mov     R1, #11110000b;-; Default predpokladam, ze mam namierene hore (na 3. a 4.) k
                                                                               abina
0672 7AE0           1542            mov     R2, #11100000b;-; Default predpokladam, ze mam namierene hore (na 3. a 4.) s
                                                                               achta
0674 203A0A         1543            jb      UPOld, F3OK     ;   Je to pravda? Naozaj som doteraz isiel hore?
0677 E9             1544            mov     A, R1           ;       Ak nie, znegujeme masku kabiny
0678 F4             1545            cpl     A               ;       |
0679 F9             1546            mov     R1, A           ;       |
067A EA             1547            mov     A, R2           ;       A znegujeme aj masku sachty
067B F4             1548            cpl     A               ;       |
067C FA             1549            mov     R2, A           ;       |     
067D E8             1550            mov     A, R0           ;       A budeme pozerat poruchy poschodi smerom DOLE (ERRFL
                                                                               OOR_U+1 = ERRFLOOR_D)
067E 6401           1551            xrl     A, #01h         ;       | Znegujem posledny bit adresy registra s poruchovym
DEBUG                                                                                                         PAGE 29

                                                                               i poschodiami (ERRFLOOR_U na ERRFLOOR_D a
                                                                                naopak)
0680 F8             1552            mov     R0, A           ;       |    
0681                1553    F3OK:   ; Pohyb v jednom smere (nevieme v ktorom)
0681 E528           1554            mov     A, INPORTA      ; zistenie, ci bolo stlacene nieco viac (menej) ako poschodi
                                                                               e na ktorom stojim (Kabina)
0683 86F0           1555            mov     B, @R0          ;  | Maskujem chybne poschodia
0685 63F0FF         1556            xrl     B, #0FFH        ;  | |
0688 55F0           1557            anl     A, B            ;  | |
068A 5416           1558            anl     A, #00010110b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
068C 59             1559            anl     A, R1           ;  | 
                    1560 +1         ljnz     F3              ; nasli sme poschodie v tomto smere, mozme ist
068D 6003           1561 +1         jz      $+5
068F 020718         1562 +1         ljmp    F3
0692 00             1563 +1         nop
                    1565                                    ; zistenie, ci bolo stlacene nieco viac (menej) ako poschodi
                                                                               e na ktorom stojim (Sachta)
0693 E528           1566            mov     A, INPORTA      ; Mam v kabine nieco stlacene?
0695 86F0           1567            mov     B, @R0          ;  | Maskujem chybne poschodia
0697 63F0FF         1568            xrl     B, #0FFH        ;  | |
069A 55F0           1569            anl     A, B            ;  | |
069C 5416           1570            anl     A, #00010110b   ;  | Beriem iba bity predstavujuce tlacidla poschodi (kabina
                                                                               )
069E 702D           1571            jnz     F3SW            ;  | Ak ano, idem rovno zistovat opacny smer.
06A0 E522           1572            mov     A, INPORTC      ; Mam stlacene nieco v sachte (mojim smerom)?    
06A2 5427           1573            anl     A, #00100111b   ;  | Beriem iba bity predstavujuce tlacidla privolavacov
06A4 5A             1574            anl     A, R2           ;  |   
06A5 86F0           1575            mov     B, @R0          ;  | Maskujem chybne poschodia (v smere hore)      
                    1576 +1         ANLBN   ACC.0, B.1      ;  | 
06A7 A2E0           1577 +1         mov   C, ACC.0
06A9 B0F1           1578 +1         anl   C, /B.1
06AB 92E0           1579 +1         mov   ACC.0, C
                    1581 +1         ANLBN   ACC.1, B.2      ;  | 
06AD A2E1           1582 +1         mov   C, ACC.1
06AF B0F2           1583 +1         anl   C, /B.2
06B1 92E1           1584 +1         mov   ACC.1, C
                    1586 +1         ANLBN   ACC.2, B.2      ;  |
06B3 A2E2           1587 +1         mov   C, ACC.2
06B5 B0F2           1588 +1         anl   C, /B.2
06B7 92E2           1589 +1         mov   ACC.2, C
                    1591 +1         ANLBN   ACC.3, B.3      ;  |
06B9 A2E3           1592 +1         mov   C, ACC.3
06BB B0F3           1593 +1         anl   C, /B.3
06BD 92E3           1594 +1         mov   ACC.3, C
                    1596 +1         ANLBN   ACC.4, B.3      ;  |
06BF A2E4           1597 +1         mov   C, ACC.4
06C1 B0F3           1598 +1         anl   C, /B.3
06C3 92E4           1599 +1         mov   ACC.4, C
                    1601 +1         ANLBN   ACC.5, B.4      ;  |
06C5 A2E5           1602 +1         mov   C, ACC.5
06C7 B0F4           1603 +1         anl   C, /B.4
06C9 92E5           1604 +1         mov   ACC.5, C
06CB 704B           1606            jnz     F3              ; nasli sme poschodie v tomto smere, mozme ist
                    1607            ; Pohyb v opacnom smere (nevieme v ktorom)
06CD E8             1608    F3SW:   mov     A, R0           ;  Znegujem posledny bit adresy registra s poruchovymi posch
                                                                               odiami (ERRFLOOR_U na ERRFLOOR_D a naopak
                                                                               )
06CE 6401           1609            xrl     A, #01h         ;  |
DEBUG                                                                                                         PAGE 30

06D0 F8             1610            mov     R0, A           ;  |
06D1 B23A           1611            cpl     UPOld           ;  Znegujem stary posun
06D3 B23B           1612            cpl     DOWNOld         ;  |
06D5 E9             1613            mov     A, R1           ;  Znegujeme masky
06D6 F4             1614            cpl     A               ;  |
06D7 F9             1615            mov     R1, A           ;  |
06D8 EA             1616            mov     A, R2           ;  |
06D9 F4             1617            cpl     A               ;  |
06DA FA             1618            mov     R2, A           ;  |               
06DB E528           1619            mov     A, INPORTA      ; zistenie, cibolo stlacene nieco viac ako poschodie na ktor
                                                                               om stojim (Kabina)
06DD 86F0           1620            mov     B, @R0          ;  | Maskujem chybne poschodia
06DF 63F0FF         1621            xrl     B, #0FFH        ;  | |
06E2 55F0           1622            anl     A, B            ;  | |
06E4 5416           1623            anl     A, #00010110b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
06E6 59             1624            anl     A, R1           ;  | 
06E7 702F           1625            jnz     F3              ; nasli sme poschodie v tomto smere, mozme ist
06E9 E522           1626            mov     A, INPORTC      ; zistenie, cibolo stlacene nieco viac ako poschodie na ktor
                                                                               om stojim (Sachta)
06EB 5427           1627            anl     A, #00100111b   ;  | Beriem iba bity predstavujuce tlacidla poschodi
06ED 5A             1628            anl     A, R2           ;  | 
06EE 86F0           1629            mov     B, @R0          ;  | Maskujem chybne poschodia (v smere hore)      
                    1630 +1         ANLBN   ACC.0, B.1      ;  | 
06F0 A2E0           1631 +1         mov   C, ACC.0
06F2 B0F1           1632 +1         anl   C, /B.1
06F4 92E0           1633 +1         mov   ACC.0, C
                    1635 +1         ANLBN   ACC.1, B.2      ;  | 
06F6 A2E1           1636 +1         mov   C, ACC.1
06F8 B0F2           1637 +1         anl   C, /B.2
06FA 92E1           1638 +1         mov   ACC.1, C
                    1640 +1         ANLBN   ACC.2, B.2      ;  |
06FC A2E2           1641 +1         mov   C, ACC.2
06FE B0F2           1642 +1         anl   C, /B.2
0700 92E2           1643 +1         mov   ACC.2, C
                    1645 +1         ANLBN   ACC.3, B.3      ;  |
0702 A2E3           1646 +1         mov   C, ACC.3
0704 B0F3           1647 +1         anl   C, /B.3
0706 92E3           1648 +1         mov   ACC.3, C
                    1650 +1         ANLBN   ACC.4, B.3      ;  |
0708 A2E4           1651 +1         mov   C, ACC.4
070A B0F3           1652 +1         anl   C, /B.3
070C 92E4           1653 +1         mov   ACC.4, C
                    1655 +1         ANLBN   ACC.5, B.4      ;  |
070E A2E5           1656 +1         mov   C, ACC.5
0710 B0F4           1657 +1         anl   C, /B.4
0712 92E5           1658 +1         mov   ACC.5, C
0714 7002           1660            jnz     F3              ; nasli sme poschodie v tomto smere, mozme ist
0716 C15F           1661            jmp     F3S           ;-; nemame sa kde hybat, tak opakujeme zistovanie
0718 203A03         1662    F3:     jb      UPOld, F3UP     ;   
071B 02072A         1663            jmp     F3DOWN          ;
071E D220           1664    F3UP:   setb    UP              ; rychly pohyb hore
0720 D222           1665            setb    FAST            ; 
0722 C223           1666            clr     SLOW            ;
0724 120D3C         1667            lcall   WRITEPORTS      ; 
0727 020736         1668            jmp     UP3           ;-; prejdi do stavu UP2    
072A D221           1669    F3DOWN: setb    DOWN            ; rychly pohyb hore
072C D222           1670            setb    FAST            ; 
072E C223           1671            clr     SLOW            ;
DEBUG                                                                                                         PAGE 31

0730 120D3C         1672            lcall   WRITEPORTS      ; 
0733 02082D         1673            jmp     DOWN3         ;-; prejdi do stavu UP2    
                    1674         
                    1675         
0736                1676    UP3:
                    1677 +1                 POLOHA_LED 3  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
0736 C22F           1678 +1         clr     LEDU            
0738 C22E           1679 +1         clr     LEDD 
073A C224           1680 +1         clr     FLED1             
073C C225           1681 +1         clr     FLED2                
073E C226           1682 +1         clr     FLED3           
0740 C227           1683 +1         clr     FLED4           
0742 D226           1684 +1         setb    FLED3
0744 120D3C         1685 +1         lcall   WRITEPORTS
                    1687 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
0747 120C60         1688 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
074A 120CDD         1689 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
074D 3009FA         1690 +1         jnb     MB1, $-3  ; 
0750 120C60         1691 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0753 120CDD         1693    UP3A:   lcall   READPORTS       ; nacitanie dat
                    1694 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
0756 200B03         1695 +1         jb      SKRH, $+6
0759 020BD8         1696 +1         ljmp    ERR_SKRH
075C 00             1697 +1         nop
                    1699            ;ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na 
                                                                               zastavovaciu) <<<
                    1700 +1         SET_FLOOR_ERR   MB1, ERRF34, UP3ERR, 4, %COUNT
                    1701 +1                                                                                             
                                                                                                                 
                    1702 +1                                                                                             
                                                                                                                 
                    1703 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  000B              1704 +1         COUNT    SET    COUNT+1                   
                    1705 +1         
075D 200919         1706 +1         jb      MB1, ENDD10
0760 304404         1707 +1         jnb     PKI4, $+7
0763 D223           1708 +1         setb    SLOW
0765 D238           1709 +1         setb    STOPPED         
0767 D254           1710 +1         setb    ERRF34_U
0769 D25B           1711 +1         setb    ERRF34_D
076B 053B           1712 +1         inc     ERRF34_C
076D C21C           1713 +1                 clr     PKO4                               
076F C22D           1714 +1         clr     PO4U            
0771 C22D           1715 +1         clr     PO4D              
0773 120D3C         1716 +1                 lcall   WRITEPORTS
0776 02077D         1717 +1         ljmp    UP3ERR
0779                1718 +1 ENDD10:
0779 00             1719 +1         nop
077A 02078D         1721            jmp     UP3ERR_CONTINUE
077D                1722    UP3ERR:
077D C220           1723            clr     UP              ; zastav motor
077F D23A           1724            setb    UPOld           ;       (a zalohuj)
0781 C23B           1725            clr     DOWNOld         ;       (a zalohuj)
0783 C222           1726            clr     FAST            ;
0785 C223           1727            clr     SLOW            ;
0787 120D3C         1728            lcall   WRITEPORTS      ; 
DEBUG                                                                                                         PAGE 32

078A 0209B4         1729            jmp     FLOOR4        ;-; a prejdi do stavu FLOOR4 
078D                1730    UP3ERR_CONTINUE:
078D 200AC3         1731            jb      MB2, UP3A     ;-; mame uz 1. spomalovaciu clonku?
                    1732 +1         CLR_FLOOR_ERR   ERRF34
0790 C254           1733 +1         clr    ERRF34_U
0792 C25B           1734 +1         clr    ERRF34_D
0794 00             1735 +1         nop
                    1737 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
0795 120C60         1738 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0798 120CDD         1739 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
079B 300AFA         1740 +1         jnb     MB2, $-3  ; 
079E 120C60         1741 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
07A1 D22E           1743            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
07A3 120D3C         1744            lcall   WRITEPORTS      ;
07A6 0207A9         1745            jmp     UP3_MB2       ;-; a prejdi do stavu UP3_MB2
07A9                1746    UP3_MB2:
                    1747 +1         ZAKMITC MB2             ; Pockame, kym odideme z predchadzajucej clonky       
07A9 120C60         1748 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
07AC 120CDD         1749 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
07AF 300AFA         1750 +1         jnb     MB2, $-3  ; 
07B2 120C60         1751 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
07B5                1753    UP3_MB2A:
07B5 120CDD         1754            lcall   READPORTS       ; nacitanie dat
                    1755 +1         ljnb    SKRH, ERR_SKRH  ; >>> CHYBA, Horna porovnavacia clonka <<<
07B8 200B03         1756 +1         jb      SKRH, $+6
07BB 020BD8         1757 +1         ljmp    ERR_SKRH
07BE 00             1758 +1         nop
                    1760            ;ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na za
                                                                               stavovaciu) <<<
                    1761 +1         SET_FLOOR_ERR   MB1, ERRF34, UP3_MB2ERR, 4, %COUNT
                    1762 +1                                                                                             
                                                                                                                 
                    1763 +1                                                                                             
                                                                                                                 
                    1764 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  000C              1765 +1         COUNT    SET    COUNT+1                   
                    1766 +1         
07BF 200919         1767 +1         jb      MB1, ENDD11
07C2 304404         1768 +1         jnb     PKI4, $+7
07C5 D223           1769 +1         setb    SLOW
07C7 D238           1770 +1         setb    STOPPED         
07C9 D254           1771 +1         setb    ERRF34_U
07CB D25B           1772 +1         setb    ERRF34_D
07CD 053B           1773 +1         inc     ERRF34_C
07CF C21C           1774 +1                 clr     PKO4                               
07D1 C22D           1775 +1         clr     PO4U            
07D3 C22D           1776 +1         clr     PO4D              
07D5 120D3C         1777 +1                 lcall   WRITEPORTS
07D8 0207DF         1778 +1         ljmp    UP3_MB2ERR
07DB                1779 +1 ENDD11:
07DB 00             1780 +1         nop
07DC 0207EF         1782            jmp     UP3_MB2ERR_CONTINUE
07DF                1783    UP3_MB2ERR:
07DF C220           1784            clr     UP              ; zastav motor
07E1 D23A           1785            setb    UPOld           ;       (a zalohuj)
07E3 C23B           1786            clr     DOWNOld         ;       (a zalohuj)
DEBUG                                                                                                         PAGE 33

07E5 C222           1787            clr     FAST            ;
07E7 C223           1788            clr     SLOW            ;
07E9 120D3C         1789            lcall   WRITEPORTS      ; 
07EC 0209B4         1790            jmp     FLOOR4        ;-; a prejdi do stavu FLOOR4
07EF                1791    UP3_MB2ERR_CONTINUE:
07EF 200AC3         1792            jb      MB2, UP3_MB2A  ;-; mame uz aj druhu spomalovaciu clonku?    
                    1793 +1         CLR_FLOOR_ERR   ERRF34      
07F2 C254           1794 +1         clr    ERRF34_U
07F4 C25B           1795 +1         clr    ERRF34_D
07F6 00             1796 +1         nop
07F7 D22F           1798            setb    LEDU            ; Rozsviet LEDku, ze mame druhu MB2
07F9 120D3C         1799            lcall   WRITEPORTS      ;
                    1800 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme 
07FC 120C60         1801 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
07FF 120CDD         1802 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0802 300AFA         1803 +1         jnb     MB2, $-3  ; 
0805 120C60         1804 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                    1806    ;        mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
                    1807    ;        anl     A, #00010000b ;-;
                    1808    ;        jz      UP3_MB1       ;-;       Ak nie, chod do stavu UP3_MB1
0808 D223           1809            setb    SLOW            ;       Ak ano, spomalme
080A C222           1810            clr     FAST            ; 
080C 120D3C         1811            lcall   WRITEPORTS      ;
080F 020812         1812            jmp     UP3_MB1       ;-; a prejdi do stavu UP3_MB1 
0812                1813    UP3_MB1:
0812 120CDD         1814            lcall   READPORTS       ; nacitanie dat
0815 300B05         1815            jnb     SKRH, U3_MB1C  ;  Sme na hornej porovnavacej clonke? (tu zastavujeme v kazdo
                                                                               m pripade)
0818 300902         1816            jnb     MB1, U3_MB1C  ;-; Sme na zastavovacej clonke? (tu zastavujeme v kazdom pripa
                                                                               de)
081B 80F5           1817            jmp     UP3_MB1         ; Ak sme nechytili ani jednu clonku, opakujeme. 
081D C238           1818    U3_MB1C: clr     STOPPED         ; Priznak STOPPED vynulujem, uz som ho osetril
081F C220           1819            clr     UP              ; zastav motor
0821 D23A           1820            setb    UPOld           ;       (a zalohuj)
0823 C23B           1821            clr     DOWNOld         ;       (a zalohuj)
0825 C222           1822            clr     FAST            ; 
0827 120D3C         1823            lcall   WRITEPORTS      ; 
082A 0209B4         1824            jmp     FLOOR4        ;-; a prejdi do stavu FLOOR4   
082D                1825    DOWN3:
                    1826 +1                 POLOHA_LED 3  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
082D C22F           1827 +1         clr     LEDU            
082F C22E           1828 +1         clr     LEDD 
0831 C224           1829 +1         clr     FLED1             
0833 C225           1830 +1         clr     FLED2                
0835 C226           1831 +1         clr     FLED3           
0837 C227           1832 +1         clr     FLED4           
0839 D226           1833 +1         setb    FLED3
083B 120D3C         1834 +1         lcall   WRITEPORTS
                    1836 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
083E 120C60         1837 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0841 120CDD         1838 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0844 3009FA         1839 +1         jnb     MB1, $-3  ; 
0847 120C60         1840 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
084A 120CDD         1842    DOWN3A: lcall   READPORTS       ; nacitanie dat
                    1843 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
DEBUG                                                                                                         PAGE 34

084D 200C03         1844 +1         jb      SKRD, $+6
0850 020BCF         1845 +1         ljmp    ERR_SKRD
0853 00             1846 +1         nop
                    1848            ;ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na 
                                                                               zastavovaciu) <<<
                    1849 +1         SET_FLOOR_ERR   MB1, ERRF23, DOWN2, 2, %COUNT
                    1850 +1                                                                                             
                                                                                                                 
                    1851 +1                                                                                             
                                                                                                                 
                    1852 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  000D              1853 +1         COUNT    SET    COUNT+1                   
                    1854 +1         
0854 200919         1855 +1         jb      MB1, ENDD12
0857 304204         1856 +1         jnb     PKI2, $+7
085A D223           1857 +1         setb    SLOW
085C D238           1858 +1         setb    STOPPED         
085E D253           1859 +1         setb    ERRF23_U
0860 D25A           1860 +1         setb    ERRF23_D
0862 053A           1861 +1         inc     ERRF23_C
0864 C21A           1862 +1                 clr     PKO2                               
0866 C22A           1863 +1         clr     PO2U            
0868 C229           1864 +1         clr     PO2D              
086A 120D3C         1865 +1                 lcall   WRITEPORTS
086D 020557         1866 +1         ljmp    DOWN2
0870                1867 +1 ENDD12:
0870 00             1868 +1         nop
0871 200AD6         1870            jb      MB2, DOWN3A   ;-; mame uz 1. spomalovaciu clonku?
                    1871 +1         CLR_FLOOR_ERR   ERRF23
0874 C253           1872 +1         clr    ERRF23_U
0876 C25A           1873 +1         clr    ERRF23_D
0878 00             1874 +1         nop
                    1876 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme   
0879 120C60         1877 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
087C 120CDD         1878 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
087F 300AFA         1879 +1         jnb     MB2, $-3  ; 
0882 120C60         1880 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0885 D22F           1882            setb    LEDU            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
0887 120D3C         1883            lcall   WRITEPORTS      ;
088A 02088D         1884            jmp     DOWN3_MB2     ;-; a prejdi do stavu DOWN3_MB2
088D                1885    DOWN3_MB2:
                    1886 +1         ZAKMITC MB2             ; Pockame, kym odideme z predchadzajucej clonky       
088D 120C60         1887 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0890 120CDD         1888 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0893 300AFA         1889 +1         jnb     MB2, $-3  ; 
0896 120C60         1890 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0899                1892    DOWN3_MB2A:
0899 120CDD         1893            lcall   READPORTS       ; nacitanie dat
                    1894 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
089C 200C03         1895 +1         jb      SKRD, $+6
089F 020BCF         1896 +1         ljmp    ERR_SKRD
08A2 00             1897 +1         nop
                    1899            ;ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na za
                                                                               stavovaciu) <<<
                    1900 +1         SET_FLOOR_ERR   MB1, ERRF23, DOWN2, 2, %COUNT
                    1901 +1                                                                                             
DEBUG                                                                                                         PAGE 35

                                                                                                                 
                    1902 +1                                                                                             
                                                                                                                 
                    1903 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  000E              1904 +1         COUNT    SET    COUNT+1                   
                    1905 +1         
08A3 200919         1906 +1         jb      MB1, ENDD13
08A6 304204         1907 +1         jnb     PKI2, $+7
08A9 D223           1908 +1         setb    SLOW
08AB D238           1909 +1         setb    STOPPED         
08AD D253           1910 +1         setb    ERRF23_U
08AF D25A           1911 +1         setb    ERRF23_D
08B1 053A           1912 +1         inc     ERRF23_C
08B3 C21A           1913 +1                 clr     PKO2                               
08B5 C22A           1914 +1         clr     PO2U            
08B7 C229           1915 +1         clr     PO2D              
08B9 120D3C         1916 +1                 lcall   WRITEPORTS
08BC 020557         1917 +1         ljmp    DOWN2
08BF                1918 +1 ENDD13:
08BF 00             1919 +1         nop
08C0 200AD6         1921            jb      MB2, DOWN3_MB2A ;-; mame uz aj druhu spomalovaciu clonku?    
                    1922 +1         CLR_FLOOR_ERR   ERRF23      
08C3 C253           1923 +1         clr    ERRF23_U
08C5 C25A           1924 +1         clr    ERRF23_D
08C7 00             1925 +1         nop
08C8 D22E           1927            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame druhu MB2
08CA 120D3C         1928            lcall   WRITEPORTS      ;
                    1929 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
08CD 120C60         1930 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
08D0 120CDD         1931 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
08D3 300AFA         1932 +1         jnb     MB2, $-3  ; 
08D6 120C60         1933 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                    1935    ;        mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
                    1936    ;        anl     A, #00000100b ;-;
                    1937    ;        jz      DOWN3_MB1     ;-;       Ak nie, chod do stavu DOWN3_MB1
                    1938 +1         ZASTAV  2, D            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0)
                    1939 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
08D9 C3             1940 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
08DA 7400           1941 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
08DC 7211           1942 +1         orl     C, PI2D      ; | Mam v tomto smere stlacene tlacidlo v sachte?
08DE B00E           1943 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
08E0 7242           1944 +1         orl     C, PKI2          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
08E2 B05A           1945 +1         anl     C, /ERRF2_D ; | a mam v tomto smere poruchu na tomto poschodi (Ak ano, tak n
                                                                               ema zmysel stat)
08E4 720F           1946 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
08E6 7238           1947 +1         orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
                                                                               m urcite)
08E8 3400           1948 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
08EA 7059           1950            jnz     D3_MB2C         ; Ak ano, zastav
                    1951 +1         NAJNIZSIE               ; | ..a sme na najnizsom privolanom poschodi z kabiny? (poto
                                                                               m stojime urcite)
DEBUG                                                                                                         PAGE 36

08EC E522           1952 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
08EE 33             1953 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
08EF 547E           1954 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
                    1955 +1 
                    1956 +2         ANLBN   ACC.1, ERRF1_D  ; maskujem chybne poschodia
08F1 A2E1           1957 +2         mov   C, ACC.1
08F3 B059           1958 +2         anl   C, /ERRF1_D
08F5 92E1           1959 +2         mov   ACC.1, C
                    1960 +2         ANLBN   ACC.2, ERRF2_D  ; |
08F7 A2E2           1961 +2         mov   C, ACC.2
08F9 B05A           1962 +2         anl   C, /ERRF2_D
08FB 92E2           1963 +2         mov   ACC.2, C
                    1964 +2         ANLBN   ACC.3, ERRF2_D  ; |
08FD A2E3           1965 +2         mov   C, ACC.3
08FF B05A           1966 +2         anl   C, /ERRF2_D
0901 92E3           1967 +2         mov   ACC.3, C
                    1968 +2         ANLBN   ACC.4, ERRF3_D  ; |
0903 A2E4           1969 +2         mov   C, ACC.4
0905 B05B           1970 +2         anl   C, /ERRF3_D
0907 92E4           1971 +2         mov   ACC.4, C
                    1972 +2         ANLBN   ACC.5, ERRF3_D  ; |
0909 A2E5           1973 +2         mov   C, ACC.5
090B B05B           1974 +2         anl   C, /ERRF3_D
090D 92E5           1975 +2         mov   ACC.5, C
                    1976 +1 
090F 7805           1977 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                    1978 +1  ; LL1: 
0911 6006           1979 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
0913 C3             1980 +1         clr     C               ; Inak shiftnem o 2
0914 33             1981 +1         rlc     A               ;
0915 C3             1982 +1         clr     C               ;
0916 33             1983 +1         rlc     A               ;
0917 D8F8           1984 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                    1985 +1 ; LL2:
0919 E8             1986 +1         mov     A, R0           ; vysledne (najnizsie zvolene) poschodie je index v R0
                    1988 +1         LCJNE   A, #2, DOWN3_MB1; |   ak nie, nezastavujeme  
091A B40203         1989 +1         cjne    A, #2, $+6
091D 020923         1990 +1         jmp     $+6
0920 02094F         1991 +1         ljmp    DOWN3_MB1
0923 00             1992 +1         nop
                    1994 +1         NIZSIE_KABINA 2         ; | ..ok, sme na najnizsom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
0924 7405           1995 +1         mov     A, #5
0926 C3             1996 +1         clr     C
0927 9402           1997 +1         subb    A, #2
0929 F8             1998 +1         mov     R0, A
092A E528           1999 +1         mov     A, INPORTA
092C 541E           2000 +1         anl     A, #00011110b
092E 852BF0         2001 +1         mov     B, ERRFLOOR_D   ; maskujem chybne poschodia
0931 63F0FF         2002 +1         xrl     B, #0FFH
0934 55F0           2003 +1         anl     A, B
0936 C3             2004 +1         clr     C
DEBUG                                                                                                         PAGE 37

0937 33             2005 +1         rlc     A
0938 C3             2006 +1         clr     C
0939 33             2007 +1         rlc     A
093A C3             2008 +1         clr     C
093B 33             2009 +1         rlc     A
                    2010 +1 ;LL1   
093C C3             2011 +1         clr     C
093D 33             2012 +1         rlc     A
093E D8FC           2013 +1         djnz    R0, $-2;LL1
0940 6003           2015            jz      D3_MB2C         ; |   ak neni zastavujem                  
0942 02094F         2016            ljmp    DOWN3_MB1       ;-; |        
0945 D223           2017    D3_MB2C: setb    SLOW            ;       Ak ano, spomalme
0947 C222           2018            clr     FAST            ; 
0949 120D3C         2019            lcall   WRITEPORTS      ;
094C 02097C         2020            jmp     DOWN3_STOP     ;-; a prejdi do stavu DOWN3_STOP
094F                2021    DOWN3_MB1:    
094F 120CDD         2022            lcall   READPORTS       ; nacitanie dat
                    2023 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
0952 200C03         2024 +1         jb      SKRD, $+6
0955 020BCF         2025 +1         ljmp    ERR_SKRD
0958 00             2026 +1         nop
                    2028            ;ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na sp
                                                                               omalovaciu) <<<
                    2029 +1         SET_FLOOR_ERR   MB2, ERRF2, DOWN2_MB2, 2, %COUNT
                    2030 +1                                                                                             
                                                                                                                 
                    2031 +1                                                                                             
                                                                                                                 
                    2032 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  000F              2033 +1         COUNT    SET    COUNT+1                   
                    2034 +1         
0959 200A19         2035 +1         jb      MB2, ENDD14
095C 304204         2036 +1         jnb     PKI2, $+7
095F D223           2037 +1         setb    SLOW
0961 D238           2038 +1         setb    STOPPED         
0963 D252           2039 +1         setb    ERRF2_U
0965 D25A           2040 +1         setb    ERRF2_D
0967 0536           2041 +1         inc     ERRF2_C
0969 C21A           2042 +1                 clr     PKO2                               
096B C22A           2043 +1         clr     PO2U            
096D C229           2044 +1         clr     PO2D              
096F 120D3C         2045 +1                 lcall   WRITEPORTS
0972 0205C9         2046 +1         ljmp    DOWN2_MB2
0975                2047 +1 ENDD14:
0975 00             2048 +1         nop
0976 2009D6         2050            jb      MB1, DOWN3_MB1;-; Sme na zastavovacej clonke?
                    2051    ;        CLR_FLOOR_ERR   ERRF2
                    2052    ;        ZASTAV  2, D            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               (Vrati do A 1 ak ano, inak 0)
                    2053    ;        clr     STOPPED         ; Priznak STOPPED vynulujem, uz som ho osetril
                    2054    ;        jnz     D3_MB1C         ; Ak ano, zastav
                    2055    ;        NAJNIZSIE               ; | ..a sme na najnizsom privolanom poschodi z kabiny? (pot
                                                                               om stojime urcite)
                    2056    ;        LCJNE   A, #2, DOWN2    ; |   ak nie, nezastavujeme  
                    2057    ;        NIZSIE_KABINA 2         ; | ..ok, sme na najnizsom privolanom poschodi z kabiny ale
                                                                                neni nad nami uz nic v kabine stlacene? 
                                                                               
                    2058    ;        jz      D3_MB1C         ; |   ak neni zastavujem                  
DEBUG                                                                                                         PAGE 38

0979 020557         2059            ljmp    DOWN2         ;-; |        
                    2060    ;D3_MB1C: clr     DOWN            ; zastav motor
                    2061    ;        setb    DOWNOld         ;       (a zalohuj)
                    2062    ;        clr     UPOld           ;       (a zalohuj)
                    2063    ;        clr     FAST            ; 
                    2064    ;        lcall   WRITEPORTS      ; 
                    2065    ;        jmp     FLOOR2        ;-; a prejdi do stavu FLOOR2 
097C                2066    DOWN3_STOP:    
097C 120CDD         2067            lcall   READPORTS       ; nacitanie dat
                    2068 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
097F 200C03         2069 +1         jb      SKRD, $+6
0982 020BCF         2070 +1         ljmp    ERR_SKRD
0985 00             2071 +1         nop
                    2073            ;ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na sp
                                                                               omalovaciu) <<<
                    2074 +1         SET_FLOOR_ERR   MB2, ERRF2, DOWN2_MB2, 2, %COUNT
                    2075 +1                                                                                             
                                                                                                                 
                    2076 +1                                                                                             
                                                                                                                 
                    2077 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0010              2078 +1         COUNT    SET    COUNT+1                   
                    2079 +1         
0986 200A19         2080 +1         jb      MB2, ENDD15
0989 304204         2081 +1         jnb     PKI2, $+7
098C D223           2082 +1         setb    SLOW
098E D238           2083 +1         setb    STOPPED         
0990 D252           2084 +1         setb    ERRF2_U
0992 D25A           2085 +1         setb    ERRF2_D
0994 0536           2086 +1         inc     ERRF2_C
0996 C21A           2087 +1                 clr     PKO2                               
0998 C22A           2088 +1         clr     PO2U            
099A C229           2089 +1         clr     PO2D              
099C 120D3C         2090 +1                 lcall   WRITEPORTS
099F 0205C9         2091 +1         ljmp    DOWN2_MB2
09A2                2092 +1 ENDD15:
09A2 00             2093 +1         nop
09A3 2009D6         2095            jb      MB1, DOWN3_STOP;-; Sme na zastavovacej clonke?  
                    2096    ;        CLR_FLOOR_ERR   ERRF2     
09A6 C221           2097            clr     DOWN            ; zastav motor
09A8 D23B           2098            setb    DOWNOld         ;       (a zalohuj)
09AA C23A           2099            clr     UPOld           ;       (a zalohuj)
09AC C222           2100            clr     FAST            ; 
09AE 120D3C         2101            lcall   WRITEPORTS      ; 
09B1 0202EA         2102            jmp     FLOOR2        ;-; a prejdi do stavu FLOOR2         
                    2103    
                    2104            
                    2105    ;------------------------------------------------------------------------------- << 4. posch
                                                                               odie >>
                    2106    
09B4                2107    FLOOR4:
                    2108 +1                 POLOHA_LED 4  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
09B4 C22F           2109 +1         clr     LEDU            
09B6 C22E           2110 +1         clr     LEDD 
09B8 C224           2111 +1         clr     FLED1             
09BA C225           2112 +1         clr     FLED2                
09BC C226           2113 +1         clr     FLED3           
DEBUG                                                                                                         PAGE 39

09BE C227           2114 +1         clr     FLED4           
09C0 D227           2115 +1         setb    FLED4
09C2 120D3C         2116 +1         lcall   WRITEPORTS
09C5 120C95         2118            lcall   WAITFORTIMER    ; simulacia TIMERu
09C8 120CDD         2119    F4S:    lcall   READPORTS     ;-; nacitanie dat
09CB C21C           2120            clr     PKO4          ;-; vynulovanie volby poschodia na ktorom stojim
09CD C22D           2121            clr     PO4            ;
09CF 120D3C         2122            lcall   WRITEPORTS      ;
09D2 200FF3         2123            jb      DPK, F4S        ; Mam pretazenu kabinu? (Ak ano, tak sa nepohnem)
09D5 E528           2124            mov     A, INPORTA      ; zistenie, ci bolo stlacene nieco menej ako poschodie na kt
                                                                               orom stojim (Kabina)
09D7 852BF0         2125            mov     B, ERRFLOOR_D   ; | maskujem chybne poschodia
09DA 63F0FF         2126            xrl     B, #0FFH        ; | |
09DD 55F0           2127            anl     A, B            ; | |
09DF 540E           2128            anl     A, #00001110b ;-;
09E1 7026           2129            jnz     F4OK          ;-; ak ano, ideme na to
09E3 E522           2130            mov     A, INPORTC      ; zistenie, ci bolo stlacene nieco menej ako poschodie na kt
                                                                               orom stojim (Sachta)
09E5 541F           2131            anl     A, #00011111b ;-;
                    2132 +1         ANLBN   ACC.0, ERRF1_D  ; maskujem chybne poschodia (v smere hore)
09E7 A2E0           2133 +1         mov   C, ACC.0
09E9 B059           2134 +1         anl   C, /ERRF1_D
09EB 92E0           2135 +1         mov   ACC.0, C
                    2137 +1         ANLBN   ACC.1, ERRF2_D  ; |
09ED A2E1           2138 +1         mov   C, ACC.1
09EF B05A           2139 +1         anl   C, /ERRF2_D
09F1 92E1           2140 +1         mov   ACC.1, C
                    2142 +1         ANLBN   ACC.2, ERRF2_D  ; |
09F3 A2E2           2143 +1         mov   C, ACC.2
09F5 B05A           2144 +1         anl   C, /ERRF2_D
09F7 92E2           2145 +1         mov   ACC.2, C
                    2147 +1         ANLBN   ACC.3, ERRF3_D  ; |
09F9 A2E3           2148 +1         mov   C, ACC.3
09FB B05B           2149 +1         anl   C, /ERRF3_D
09FD 92E3           2150 +1         mov   ACC.3, C
                    2152 +1         ANLBN   ACC.4, ERRF3_D  ; |
09FF A2E4           2153 +1         mov   C, ACC.4
0A01 B05B           2154 +1         anl   C, /ERRF3_D
0A03 92E4           2155 +1         mov   ACC.4, C
0A05 7002           2157            jnz     F4OK          ;-; ak ano, ideme na to
0A07 80BF           2158            jmp     F4S             ; Nemam sa kde hnut, opakujem
0A09 D221           2159    F4OK:   setb    DOWN            ; rychly pohyb dole
0A0B D222           2160            setb    FAST            ;
0A0D C223           2161            clr     SLOW            ; 
0A0F 120D3C         2162            lcall   WRITEPORTS      ; 
0A12 020A15         2163            jmp     DOWN4         ;-; prejdi do stavu DOWN4 
0A15                2164    DOWN4:
                    2165 +1                 POLOHA_LED 4  ;-; Zhasni LEDKY,uz sme na poschodi (aj na paneli "Poloha kabi
                                                                               ny", nechaj len aktualne poschodie)
0A15 C22F           2166 +1         clr     LEDU            
0A17 C22E           2167 +1         clr     LEDD 
0A19 C224           2168 +1         clr     FLED1             
0A1B C225           2169 +1         clr     FLED2                
0A1D C226           2170 +1         clr     FLED3           
0A1F C227           2171 +1         clr     FLED4           
0A21 D227           2172 +1         setb    FLED4
0A23 120D3C         2173 +1         lcall   WRITEPORTS
                    2175 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
DEBUG                                                                                                         PAGE 40

0A26 120C60         2176 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0A29 120CDD         2177 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0A2C 3009FA         2178 +1         jnb     MB1, $-3  ; 
0A2F 120C60         2179 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0A32 120CDD         2181            lcall   READPORTS       ; nacitanie dat
                    2182 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
0A35 200C03         2183 +1         jb      SKRD, $+6
0A38 020BCF         2184 +1         ljmp    ERR_SKRD
0A3B 00             2185 +1         nop
                    2187            ;ljnb    MB1, ERR_2SPOM_C; >>> CHYBA, Vypadli 2 spomalovacie clonky (narazil som na 
                                                                               zastavovaciu) <<<
                    2188 +1         SET_FLOOR_ERR   MB1, ERRF34, DOWN3, 3, %COUNT
                    2189 +1                                                                                             
                                                                                                                 
                    2190 +1                                                                                             
                                                                                                                 
                    2191 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0011              2192 +1         COUNT    SET    COUNT+1                   
                    2193 +1         
0A3C 200919         2194 +1         jb      MB1, ENDD16
0A3F 304304         2195 +1         jnb     PKI3, $+7
0A42 D223           2196 +1         setb    SLOW
0A44 D238           2197 +1         setb    STOPPED         
0A46 D254           2198 +1         setb    ERRF34_U
0A48 D25B           2199 +1         setb    ERRF34_D
0A4A 053B           2200 +1         inc     ERRF34_C
0A4C C21B           2201 +1                 clr     PKO3                               
0A4E C22C           2202 +1         clr     PO3U            
0A50 C22B           2203 +1         clr     PO3D              
0A52 120D3C         2204 +1                 lcall   WRITEPORTS
0A55 02082D         2205 +1         ljmp    DOWN3
0A58                2206 +1 ENDD16:
0A58 00             2207 +1         nop
0A59 200AB9         2209            jb      MB2, DOWN4    ;-; mame uz 1. spomalovaciu clonku?
                    2210 +1         CLR_FLOOR_ERR   ERRF34
0A5C C254           2211 +1         clr    ERRF34_U
0A5E C25B           2212 +1         clr    ERRF34_D
0A60 00             2213 +1         nop
                    2215 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme      
0A61 120C60         2216 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0A64 120CDD         2217 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0A67 300AFA         2218 +1         jnb     MB2, $-3  ; 
0A6A 120C60         2219 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0A6D D22F           2221            setb    LEDU            ; Ak ano, rozsviet LEDku, ze mame prvu MB2 mame za sebou
0A6F 120D3C         2222            lcall   WRITEPORTS      ;
0A72 020A75         2223            jmp     DOWN4_MB2     ;-; a prejdi do stavu DOWN4_MB2
0A75                2224    DOWN4_MB2:
                    2225 +1         ZAKMITC MB2             ; Pockame, kym odideme z predchadzajucej clonky       
0A75 120C60         2226 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0A78 120CDD         2227 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0A7B 300AFA         2228 +1         jnb     MB2, $-3  ; 
0A7E 120C60         2229 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0A81                2231    DOWN4_MB2A:
0A81 120CDD         2232            lcall   READPORTS       ; nacitanie dat
                    2233 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
DEBUG                                                                                                         PAGE 41

0A84 200C03         2234 +1         jb      SKRD, $+6
0A87 020BCF         2235 +1         ljmp    ERR_SKRD
0A8A 00             2236 +1         nop
                    2238            ;ljnb    MB1, ERR_1SPOM_C; >>> CHYBA, Vypadla spomalovacia clonka (narazil som na za
                                                                               stavovaciu) <<<
                    2239 +1         SET_FLOOR_ERR   MB1, ERRF34, DOWN3, 3, %COUNT
                    2240 +1                                                                                             
                                                                                                                 
                    2241 +1                                                                                             
                                                                                                                 
                    2242 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0012              2243 +1         COUNT    SET    COUNT+1                   
                    2244 +1         
0A8B 200919         2245 +1         jb      MB1, ENDD17
0A8E 304304         2246 +1         jnb     PKI3, $+7
0A91 D223           2247 +1         setb    SLOW
0A93 D238           2248 +1         setb    STOPPED         
0A95 D254           2249 +1         setb    ERRF34_U
0A97 D25B           2250 +1         setb    ERRF34_D
0A99 053B           2251 +1         inc     ERRF34_C
0A9B C21B           2252 +1                 clr     PKO3                               
0A9D C22C           2253 +1         clr     PO3U            
0A9F C22B           2254 +1         clr     PO3D              
0AA1 120D3C         2255 +1                 lcall   WRITEPORTS
0AA4 02082D         2256 +1         ljmp    DOWN3
0AA7                2257 +1 ENDD17:
0AA7 00             2258 +1         nop
0AA8 200AD6         2260            jb      MB2, DOWN4_MB2A ;-; mame uz aj druhu spomalovaciu clonku?   
                    2261 +1         CLR_FLOOR_ERR   ERRF34       
0AAB C254           2262 +1         clr    ERRF34_U
0AAD C25B           2263 +1         clr    ERRF34_D
0AAF 00             2264 +1         nop
0AB0 D22E           2266            setb    LEDD            ; Ak ano, rozsviet LEDku, ze mame druhu MB2
0AB2 120D3C         2267            lcall   WRITEPORTS      ;
                    2268 +1         ZAKMITC MB2             ; Pockame, kym z nej odideme
0AB5 120C60         2269 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0AB8 120CDD         2270 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0ABB 300AFA         2271 +1         jnb     MB2, $-3  ; 
0ABE 120C60         2272 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
                    2274    ;        mov     A, INPORTA      ; Chceme tu spomalit? - je najblizsie poschodie zvolene?
                    2275    ;        anl     A, #00001000b ;-;
                    2276    ;        jz      DOWN4_MB1     ;-;       Ak nie, chod do stavu DOWN4_MB1
                    2277 +1         ZASTAV  3, D            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? (
                                                                               Vrati do A 1 ak ano, inak 0) 
                    2278 +1                                         ; Chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               
0AC1 C3             2279 +1         clr     C                       ; | Idem robit cachre-machre s Carry bitom
0AC2 7400           2280 +1         mov     A, #0h                  ; | Aj Acc potrebujem prazdny
0AC4 7213           2281 +1         orl     C, PI3D      ; | Mam v tomto smere stlacene tlacidlo v sachte?
0AC6 B00E           2282 +1         anl     C, /DPZK                ; | a mam plne zatazenu kabinu? (lebo ak ano tak ani
                                                                                za boha nestojim)
0AC8 7243           2283 +1         orl     C, PKI3          ; | Mam v tomto smere stlacene tlacidlo v kabine? 
0ACA B05B           2284 +1         anl     C, /ERRF3_D ; | a mam v tomto smere poruchu na tomto poschodi (Ak ano, tak n
                                                                               ema zmysel stat)
0ACC 720F           2285 +1         orl     C, DPK                  ; | a mam pretazenu kabinu? (Ak ano tak stojim urcit
                                                                               e)
0ACE 7238           2286 +1         orl     C, STOPPED              ; | a bolo stlacene tlacidlo STOP? (Ak ano tak stoji
DEBUG                                                                                                         PAGE 42

                                                                               m urcite)
0AD0 3400           2287 +1         addc    A, #0h                  ; Ak mi v predchadzajucich krokoch vyslo, ze mam sta
                                                                               t, tak stojim nezavisle na tlacidlach kab
                                                                               iny
0AD2 7059           2289            jnz     D4_MB2C       ;-; Ak ano, zastav
                    2290 +1         NAJNIZSIE               ; | ..a sme na najnizsom privolanom poschodi z kabiny? (poto
                                                                               m stojime urcite)
0AD4 E522           2291 +1         mov     A, INPORTC      ; INPORTC - vektor "privolavace zo sachty"               
0AD6 33             2292 +1         rlc     A               ; SHIFT LEFT - shiftnem si tak, aby som mal kazde poschodie 
                                                                               dvojicu bitov | X  4 | 3U 3D | 2U 2D | 1 
                                                                                X | 
0AD7 547E           2293 +1         anl     A, #01111110b   ; Vynulujem nedefinovane bity
                    2294 +1 
                    2295 +2         ANLBN   ACC.1, ERRF1_D  ; maskujem chybne poschodia
0AD9 A2E1           2296 +2         mov   C, ACC.1
0ADB B059           2297 +2         anl   C, /ERRF1_D
0ADD 92E1           2298 +2         mov   ACC.1, C
                    2299 +2         ANLBN   ACC.2, ERRF2_D  ; |
0ADF A2E2           2300 +2         mov   C, ACC.2
0AE1 B05A           2301 +2         anl   C, /ERRF2_D
0AE3 92E2           2302 +2         mov   ACC.2, C
                    2303 +2         ANLBN   ACC.3, ERRF2_D  ; |
0AE5 A2E3           2304 +2         mov   C, ACC.3
0AE7 B05A           2305 +2         anl   C, /ERRF2_D
0AE9 92E3           2306 +2         mov   ACC.3, C
                    2307 +2         ANLBN   ACC.4, ERRF3_D  ; |
0AEB A2E4           2308 +2         mov   C, ACC.4
0AED B05B           2309 +2         anl   C, /ERRF3_D
0AEF 92E4           2310 +2         mov   ACC.4, C
                    2311 +2         ANLBN   ACC.5, ERRF3_D  ; |
0AF1 A2E5           2312 +2         mov   C, ACC.5
0AF3 B05B           2313 +2         anl   C, /ERRF3_D
0AF5 92E5           2314 +2         mov   ACC.5, C
                    2315 +1 
0AF7 7805           2316 +1         mov     R0, #05         ; Budem opakovat max. 4x (ale chcem mat index o jeden viac, 
                                                                               aby som mal na konci rovno cislo poschodi
                                                                               a)
                    2317 +1  ; LL1: 
0AF9 6006           2318 +1         jz      $+8;LL2         ; Ak mam 0 - ziadne dalsie poschodia ne su pritomne, skocim 
                                                                               na LL2
0AFB C3             2319 +1         clr     C               ; Inak shiftnem o 2
0AFC 33             2320 +1         rlc     A               ;
0AFD C3             2321 +1         clr     C               ;
0AFE 33             2322 +1         rlc     A               ;
0AFF D8F8           2323 +1         djnz    R0, $-6         ; ...a pokracujem v zistovani
                    2324 +1 ; LL2:
0B01 E8             2325 +1         mov     A, R0           ; vysledne (najnizsie zvolene) poschodie je index v R0
                    2327 +1         LCJNE   A, #3, DOWN4_MB1; |   ak nie, nezastavujeme  
0B02 B40303         2328 +1         cjne    A, #3, $+6
0B05 020B0B         2329 +1         jmp     $+6
0B08 020B37         2330 +1         ljmp    DOWN4_MB1
0B0B 00             2331 +1         nop
                    2333 +1         NIZSIE_KABINA 3         ; | ..ok, sme na najnizsom privolanom poschodi z kabiny ale 
                                                                               neni nad nami uz nic v kabine stlacene? 
                                                                               
0B0C 7405           2334 +1         mov     A, #5
0B0E C3             2335 +1         clr     C
0B0F 9403           2336 +1         subb    A, #3
DEBUG                                                                                                         PAGE 43

0B11 F8             2337 +1         mov     R0, A
0B12 E528           2338 +1         mov     A, INPORTA
0B14 541E           2339 +1         anl     A, #00011110b
0B16 852BF0         2340 +1         mov     B, ERRFLOOR_D   ; maskujem chybne poschodia
0B19 63F0FF         2341 +1         xrl     B, #0FFH
0B1C 55F0           2342 +1         anl     A, B
0B1E C3             2343 +1         clr     C
0B1F 33             2344 +1         rlc     A
0B20 C3             2345 +1         clr     C
0B21 33             2346 +1         rlc     A
0B22 C3             2347 +1         clr     C
0B23 33             2348 +1         rlc     A
                    2349 +1 ;LL1   
0B24 C3             2350 +1         clr     C
0B25 33             2351 +1         rlc     A
0B26 D8FC           2352 +1         djnz    R0, $-2;LL1
0B28 6003           2354            jz      D4_MB2C         ; |   ak neni zastavujem          
0B2A 020B37         2355            ljmp    DOWN4_MB1       ;-; |       
0B2D D223           2356    D4_MB2C: setb    SLOW            ;       Ak ano, spomalme
0B2F C222           2357            clr     FAST            ; 
0B31 120D3C         2358            lcall   WRITEPORTS      ;
0B34 020B64         2359            jmp     DOWN4_STOP     ;-; a prejdi do stavu DOWN4_STOP
0B37                2360    DOWN4_MB1:    
0B37 120CDD         2361            lcall   READPORTS       ; nacitanie dat
                    2362 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
0B3A 200C03         2363 +1         jb      SKRD, $+6
0B3D 020BCF         2364 +1         ljmp    ERR_SKRD
0B40 00             2365 +1         nop
                    2367            ;ljnb    MB2, ERR_ZAST_C ; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na sp
                                                                               omalovaciu) <<<
                    2368 +1         SET_FLOOR_ERR   MB2, ERRF3, DOWN3_MB2, 3, %COUNT
                    2369 +1                                                                                             
                                                                                                                 
                    2370 +1                                                                                             
                                                                                                                 
                    2371 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0013              2372 +1         COUNT    SET    COUNT+1                   
                    2373 +1         
0B41 200A19         2374 +1         jb      MB2, ENDD18
0B44 304304         2375 +1         jnb     PKI3, $+7
0B47 D223           2376 +1         setb    SLOW
0B49 D238           2377 +1         setb    STOPPED         
0B4B D253           2378 +1         setb    ERRF3_U
0B4D D25B           2379 +1         setb    ERRF3_D
0B4F 0537           2380 +1         inc     ERRF3_C
0B51 C21B           2381 +1                 clr     PKO3                               
0B53 C22C           2382 +1         clr     PO3U            
0B55 C22B           2383 +1         clr     PO3D              
0B57 120D3C         2384 +1                 lcall   WRITEPORTS
0B5A 02088D         2385 +1         ljmp    DOWN3_MB2
0B5D                2386 +1 ENDD18:
0B5D 00             2387 +1         nop
0B5E 2009D6         2389            jb      MB1, DOWN4_MB1 ;-; Sme na zastavovacej clonke?
                    2390    ;        CLR_FLOOR_ERR   ERRF3
                    2391    ;        ZASTAV  3, D            ; Ak ano, chceme tu zastavit? - je toto poschodie zvolene? 
                                                                               (Vrati do A 1 ak ano, inak 0)
                    2392    ;        clr     STOPPED         ; Priznak STOPPED vynulujem, uz som ho osetril 
                    2393    ;        jnz     D4_MB1C       ;-; Ak ano, zastav
DEBUG                                                                                                         PAGE 44

                    2394    ;        NAJNIZSIE               ; | ..a sme na najnizsom privolanom poschodi z kabiny? (pot
                                                                               om stojime urcite)
                    2395    ;        LCJNE   A, #3, DOWN3    ; |   ak nie, nezastavujeme  
                    2396    ;        NIZSIE_KABINA 3         ; | ..ok, sme na najnizsom privolanom poschodi z kabiny ale
                                                                                neni nad nami uz nic v kabine stlacene? 
                                                                               
                    2397    ;        jz      D4_MB1C         ; |   ak neni zastavujem          
0B61 02082D         2398            ljmp    DOWN3         ;-; |       
                    2399    ;D4_MB1C: clr     DOWN            ; zastav motor
                    2400    ;        setb    DOWNOld         ;       (a zalohuj)
                    2401    ;        clr     UPOld           ;       (a zalohuj)
                    2402    ;        clr     FAST            ; 
                    2403    ;        lcall   WRITEPORTS      ; 
                    2404    ;        jmp     FLOOR3        ;-; a prejdi do stavu FLOOR3                 
0B64                2405    DOWN4_STOP:    
0B64 120CDD         2406            lcall   READPORTS       ; nacitanie dat
                    2407 +1         ljnb    SKRD, ERR_SKRD  ; >>> CHYBA, Dolna porovnavacia clonka <<<
0B67 200C03         2408 +1         jb      SKRD, $+6
0B6A 020BCF         2409 +1         ljmp    ERR_SKRD
0B6D 00             2410 +1         nop
                    2412            ;ljnb    MB2, ERR_ZAST_C; >>> CHYBA, Vypadla zastavovacia clonka (narazil som na spo
                                                                               malovaciu) <<<
                    2413 +1         SET_FLOOR_ERR   MB2, ERRF3, DOWN3_MB2, 3, %COUNT
                    2414 +1                                                                                             
                                                                                                                 
                    2415 +1                                                                                             
                                                                                                                 
                    2416 +1         ;INCREMENT SUFFIX  FOR  NEXT LABEL             
  0014              2417 +1         COUNT    SET    COUNT+1                   
                    2418 +1         
0B6E 200A19         2419 +1         jb      MB2, ENDD19
0B71 304304         2420 +1         jnb     PKI3, $+7
0B74 D223           2421 +1         setb    SLOW
0B76 D238           2422 +1         setb    STOPPED         
0B78 D253           2423 +1         setb    ERRF3_U
0B7A D25B           2424 +1         setb    ERRF3_D
0B7C 0537           2425 +1         inc     ERRF3_C
0B7E C21B           2426 +1                 clr     PKO3                               
0B80 C22C           2427 +1         clr     PO3U            
0B82 C22B           2428 +1         clr     PO3D              
0B84 120D3C         2429 +1                 lcall   WRITEPORTS
0B87 02088D         2430 +1         ljmp    DOWN3_MB2
0B8A                2431 +1 ENDD19:
0B8A 00             2432 +1         nop
0B8B 2009D6         2434            jb      MB1, DOWN4_STOP ;-; Sme na zastavovacej clonke?
                    2435    ;        CLR_FLOOR_ERR   ERRF3
0B8E C221           2436            clr     DOWN            ; zastav motor
0B90 D23B           2437            setb    DOWNOld         ;       (a zalohuj)
0B92 C23A           2438            clr     UPOld           ;       (a zalohuj)
0B94 C222           2439            clr     FAST            ; 
0B96 120D3C         2440            lcall   WRITEPORTS      ; 
0B99 02064B         2441            jmp     FLOOR3        ;-; a prejdi do stavu FLOOR3                   
                    2442      
0B9C                2443    ERR_1SPOM_C: 
                    2444            ;clr     UP              ; zastav motor
                    2445            ;clr     DOWN            ; 
                    2446            ;lcall   WRITEPORTS      ; 
                    2447            ;_BP_
DEBUG                                                                                                         PAGE 45

                    2448            ;nop
                    2449            ;nop 
                    2450 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
0B9C 120C60         2451 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0B9F 120CDD         2452 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0BA2 3009FA         2453 +1         jnb     MB1, $-3  ; 
0BA5 120C60         2454 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0BA8 900E0F         2456            mov     DPTR, #STR_ERR_1SPOM_C         ; vypis info 
0BAB 120D73         2457            lcall   DISPSTR         ;          
0BAE 020BE1         2458            ljmp    ERROR1         
                    2459            
0BB1                2460    ERR_2SPOM_C: 
                    2461            ;clr     UP              ; zastav motor
                    2462            ;clr     DOWN            ; 
                    2463            ;lcall   WRITEPORTS      ; 
                    2464            ;_BP_
                    2465            ;nop
                    2466            ;nop
                    2467 +1         ZAKMITC MB1             ; Pockame, kym odideme z poschodia (Clonky MB1)
0BB1 120C60         2468 +1         lcall   TIME10MS        ; pockame 10 ms kym sa hodnota ustali (ze som na clonke)
0BB4 120CDD         2469 +1         lcall   READPORTS       ; Uz sme z tej clonky prec?
0BB7 3009FA         2470 +1         jnb     MB1, $-3  ; 
0BBA 120C60         2471 +1         lcall   TIME10MS        ; pockame 10 ms  kym sa hodnota ustali (ze sme z nej naozaj 
                                                                               zliezli)
0BBD 900E35         2473            mov     DPTR, #STR_ERR_2SPOM_C         ; vypis info 
0BC0 120D73         2474            lcall   DISPSTR         ;
0BC3 020BE1         2475            ljmp    ERROR1 
                    2476            
0BC6                2477    ERR_ZAST_C: 
                    2478            ;clr     UP              ; zastav motor
                    2479            ;clr     DOWN            ; 
                    2480            ;lcall   WRITEPORTS      ; 
                    2481            ;_BP_
                    2482            ;nop
                    2483            ;nop
                    2484            ;lcall   READPORTS
                    2485            ;clr     FAST
                    2486            ;clr     SLOW
0BC6 900E5F         2487            mov     DPTR, #STR_ERR_ZAST_C         ; vypis info 
0BC9 120D73         2488            lcall   DISPSTR         ;
0BCC 020BE1         2489            ljmp    ERROR1  
                    2490            
0BCF                2491    ERR_SKRD: 
                    2492            ;clr     UP              ; zastav motor
                    2493            ;clr     DOWN            ; 
                    2494            ;lcall   WRITEPORTS      ; 
                    2495            ;_BP_
                    2496            ;nop
                    2497            ;nop        
0BCF 900EC0         2498            mov     DPTR, #STR_ERR_SKRD         ; vypis info 
0BD2 120D73         2499            lcall   DISPSTR         ;
0BD5 020BE1         2500            ljmp    ERROR1    
                    2501            
0BD8                2502    ERR_SKRH: 
                    2503            ;clr     UP              ; zastav motor
                    2504            ;clr     DOWN            ; 
                    2505            ;lcall   WRITEPORTS      ; 
DEBUG                                                                                                         PAGE 46

                    2506            ;_BP_
                    2507            ;nop
                    2508            ;nop
0BD8 900E85         2509            mov     DPTR, #STR_ERR_SKRH         ; vypis info 
0BDB 120D73         2510            lcall   DISPSTR         ;        
0BDE 020BE1         2511            ljmp    ERROR1 
                    2512            
0BE1                2513    ERROR1:         
0BE1 D22F           2514            setb    LEDU
0BE3 D22E           2515            setb    LEDD
0BE5 C222           2516            clr     FAST
0BE7 D223           2517            setb    SLOW
0BE9 120D3C         2518            lcall   WRITEPORTS          
0BEC 120CDD         2519    ERROR1S:lcall   READPORTS       ; nacitanie dat
0BEF 300B08         2520            jnb     SKRH, ERROR1C   ; Sme na hornej porovnavacej clonke? (tu zastavujeme v kazdo
                                                                               m pripade)
0BF2 300C05         2521            jnb     SKRD, ERROR1C   ; Sme na dolnej porovnavacej clonke? (tu zastavujeme v kazdo
                                                                               m pripade)
0BF5 300902         2522            jnb     MB1, ERROR1C  ;-; Sme na zastavovacej clonke? (tu zastavujeme v kazdom pripa
                                                                               de)
0BF8 80F2           2523            jmp     ERROR1S         ; Ak sme nechytili ani jednu clonku, opakujeme
0BFA C220           2524    ERROR1C:clr     UP              ; zastav motor
0BFC C221           2525            clr     DOWN            ; 
0BFE C222           2526            clr     FAST            ; 
0C00 C223           2527            clr     SLOW            ; 
0C02 120D3C         2528            lcall   WRITEPORTS      ; 
0C05 120C95         2529            lcall   WAITFORTIMER    ; simulacia TIMERu
0C08 020C0B         2530            jmp     ERROR2        ;-; a prejdi do stavu ERROR2 
                    2531            
0C0B 120CDD         2532    ERROR2: lcall   READPORTS       ; nacitanie dat
0C0E 200DFA         2533            jb      DP, ERROR2      ; uz vystupili vsetci ludia z kabiny?
0C11 200FF7         2534            jb      DPK, ERROR2     ; uz vystupili vsetci ludia z kabiny?
0C14 200EF4         2535            jb      DPZK, ERROR2    ; uz vystupili vsetci ludia z kabiny?
0C17 020033         2536            ljmp    START
                    2537                           
                    2538                    
0C1A                2539    ENDPROG:
0C1A D218           2540            setb    KS
0C1C 120D3C         2541            call    WRITEPORTS                ; zapis novu informaciu
                    2542 +1         _BP_
0C1F C2B3           2543 +1         clr     P3.3
0C21 D2AA           2544 +1         setb    EX1
0C23 00             2545 +1         nop
0C24 00             2546 +1         nop
0C25 22             2548            ret
                    2549            
                    2550            
                    2551            
                    2552    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    2553    ; INT_TIMER0
                    2554    ; Obsluha prerusenia timera 0
                    2555    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;        
0C26                2556    INT_TIMER0:
0C26 C0E0           2557            push    ACC
0C28 C0F0           2558            push    B
0C2A C080           2559            push    P0
0C2C C090           2560            push    P1
0C2E C0A0           2561            push    P2
DEBUG                                                                                                         PAGE 47

0C30 C0B0           2562            push    P3
                    2563            ;push    OUTPORTC
                    2564            
0C32 ED             2565            mov     A, R5
0C33 1D             2566            dec     R5
0C34 6002           2567            jz      INT_TIMER0_MAIN    
0C36 801B           2568            sjmp    INT_TIMER0_END
0C38                2569    INT_TIMER0_MAIN:
0C38 EE             2570            mov     A, R6
0C39 FD             2571            mov     R5, A
0C3A E52A           2572            mov     A, ERRFLOOR_U
0C3C 452B           2573            orl     A, ERRFLOOR_D
0C3E 541E           2574            anl     A, #00011110b
0C40 23             2575            rl      A
0C41 23             2576            rl      A
0C42 23             2577            rl      A    
0C43 6224           2578            xrl     OUTPORTB, A     
                    2579                          
0C45 852480         2580            mov     p0, OUTPORTB 
0C48 75A0C1         2581            mov     p2, #i8255OUTB
0C4B C2B6           2582            clr     WRNOT
0C4D 00             2583            nop
0C4E 00             2584            nop
0C4F 00             2585            nop
0C50 00             2586            nop
0C51 D2B6           2587            setb    WRNOT
                    2588            
                    2589            
0C53                2590    INT_TIMER0_END:
                    2591            
                    2592    
                    2593            ;pop     OUTPORTC
0C53 D0B0           2594            pop     P3
0C55 D0A0           2595            pop     P2
0C57 D090           2596            pop     P1
0C59 D080           2597            pop     P0 
0C5B D0F0           2598            pop     B       
0C5D D0E0           2599            pop     ACC
0C5F 32             2600            reti 
                    2601            
                    2602    ;INT_TIMER0:
                    2603    ;        push    ACC
                    2604    ;        mov     A, R7  
                    2605    ;        dec     R7               
                    2606    ;        jnz     INT_TIMER0_END     
                    2607    ;        mov     R7, #20h
                    2608    ;        jb      LEDU, INT_TIMER0_CLEAR       
                    2609    ;        setb    LEDU
                    2610    ;        setb    LEDD
                    2611    ;        jmp     INT_TIMER0_WRITE
                    2612    ;INT_TIMER0_CLEAR:        
                    2613    ;        ;clr     LEDU
                    2614    ;        ;clr     LEDD
                    2615    ;INT_TIMER0_WRITE: 
                    2616    ;        lcall   WRITEPORTS
                    2617    ;INT_TIMER0_END: 
                    2618    ;        setb    LEDU
                    2619    ;        lcall   WRITEPORTS       
DEBUG                                                                                                         PAGE 48

                    2620    ;        pop     ACC
                    2621    ;        reti
                    2622            
                    2623            
                    2624    ; rutina time delay 1 ms pre oscilator s frekvenciou 11.0592 MHz
                    2625    ; 1 instrukcia 2 takty? => 11.0592/2 = pocet instrukcii potrebnych na 1 sekundu
                    2626    ; 11.0592MHz/2000 = zdrzanie 1 ms
0C60                2627    TIME10MS:
0C60 7963           2628            mov     R1,#063h        ; 2
                    2629                                    ; *** 100x
0C62 7AFF           2630    TIME0:  mov     R2,#0FFh        ; 2 
0C64 DAFE           2631    TIME1:  djnz    R2,TIME1        ; 256*2   
0C66 7AFF           2632            mov     R2,#0FFh        ; 2       
0C68 DAFE           2633    TIME2:  djnz    R2,TIME2        ; 256*2 
0C6A 7A24           2634            mov     R2,#024h        ; 2       
0C6C DAFE           2635    TIME3:  djnz    R2,TIME3        ; 36*2
0C6E 00             2636            nop                     ; 1
0C6F D9F1           2637            djnz    R1,TIME0        ; 2
                    2638                                    ; ***
0C71 792A           2639            mov     R1,#02Ah        ; 2 
0C73 D9FE           2640    TIME4:  djnz    R1,TIME4        ; 43*2  
0C75 22             2641            ret                     ; koniec
                    2642            
                    2643            
                    2644    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    2645    ; STOP
                    2646    ; osetri stlacenie tlacidla STOP
                    2647    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0C76                2648    STOP:
0C76 D238           2649            setb    STOPPED
0C78 C222           2650            clr     FAST
0C7A C223           2651            clr     SLOW
0C7C 74E1           2652            mov     A, #11100001b
0C7E 5223           2653            anl     OUTPORTA, A 
0C80 120D3C         2654            lcall   WRITEPORTS
                    2655            
0C83 120C95         2656            lcall   WAITFORTIMER
0C86 120C9D         2657    STOPC:  lcall   READPORTS1
0C89 E528           2658            mov     A, INPORTA
0C8B 541E           2659            anl     A, #00011110b
0C8D 60F7           2660            jz      STOPC     
                    2661            
0C8F D223           2662            setb    SLOW
0C91 120D3C         2663            lcall   WRITEPORTS
0C94 22             2664            ret        
                    2665            
                    2666            
                    2667    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    2668    ; DELAY
                    2669    ; Pocka na stlacenie tlacidla na 1. poschodi  - signal PO1 (v buducnosti to 
                    2670    ; bude timer)
                    2671    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0C95                2672    WAITFORTIMER:
0C95 7B10           2673            mov     R3, #10h
0C97 120C60         2674    DEL1:   lcall   TIME10MS
0C9A DBFB           2675            djnz    R3, DEL1
0C9C 22             2676            ret
                    2677            
DEBUG                                                                                                         PAGE 49

                    2678    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    2679    ; READPORTS1
                    2680    ; precita nove hodnoty na portoch
                    2681    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0C9D                2682    READPORTS1:
0C9D C2AF           2683            clr     EA                  ;Treba zakazat prerusenia
                    2684            
0C9F 75A080         2685            mov     p2, #i8255INA       ; citaj data z portu A
0CA2 75803F         2686            mov     p0, #(bmSTOP or bmPKI1 or bmPKI2 or bmPKI3 or bmPKI4 or bmDOORCLSD)
0CA5 C2B7           2687            clr     RDNOT
0CA7 00             2688            nop
0CA8 00             2689            nop
0CA9 00             2690            nop
0CAA 00             2691            nop
0CAB 858028         2692            mov     INPORTA, p0         ; uloz informaciu z datovej zbernice 
0CAE D2B7           2693            setb    RDNOT
                    2694            
0CB0 75A081         2695            mov     p2, #i8255INB       ; citaj data z portu B
0CB3 7580FE         2696            mov     p0, #(bmMB1I or bmMB2I or bmSKRHI or bmSKRHD or bmDPI or bmDPKI or bmDPZKI)
                                                                               
0CB6 C2B7           2697            clr     RDNOT
0CB8 00             2698            nop
0CB9 00             2699            nop
0CBA 00             2700            nop
0CBB 00             2701            nop
0CBC 858021         2702            mov     INPORTB, p0         ; uloz informaciu z datovej zbernice 
0CBF D2B7           2703            setb    RDNOT
                    2704    
0CC1 75A082         2705            mov     p2, #i8255INC       ; citaj data z portu C
0CC4 75803F         2706            mov     p0, #(bmPI1 or bmPI2D or bmPI2U or bmPI3D or bmPI3U or bmPI4)
0CC7 C2B7           2707            clr     RDNOT
0CC9 00             2708            nop
0CCA 00             2709            nop
0CCB 00             2710            nop
0CCC 00             2711            nop
0CCD 858022         2712            mov     INPORTC, p0         ; uloz informaciu z datovej zbernice 
0CD0 D2B7           2713            setb    RDNOT
0CD2 00             2714            nop
0CD3 00             2715            nop
0CD4 00             2716            nop
0CD5 00             2717            nop
0CD6 00             2718            nop
0CD7 00             2719            nop
0CD8 00             2720            nop
0CD9 00             2721            nop
0CDA D2AF           2722            setb    EA                 ;znovu spustime prerusenia
0CDC 22             2723            ret
                    2724    
                    2725    
                    2726    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    2727    ; READPORTS
                    2728    ; precita nove hodnoty na portoch
                    2729    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0CDD                2730    READPORTS:
0CDD C2AF           2731            clr     EA                  ;Treba zakazat prerusenia
                    2732            
0CDF 75A080         2733            mov     p2, #i8255INA       ; citaj data z portu A
0CE2 75803F         2734            mov     p0, #(bmSTOP or bmPKI1 or bmPKI2 or bmPKI3 or bmPKI4 or bmDOORCLSD)
DEBUG                                                                                                         PAGE 50

0CE5 C2B7           2735            clr     RDNOT
0CE7 00             2736            nop
0CE8 00             2737            nop
0CE9 00             2738            nop
0CEA 00             2739            nop
0CEB 858028         2740            mov     INPORTA, p0         ; uloz informaciu z datovej zbernice 
0CEE D2B7           2741            setb    RDNOT
                    2742            
0CF0 75A081         2743            mov     p2, #i8255INB       ; citaj data z portu B
0CF3 7580FE         2744            mov     p0, #(bmMB1I or bmMB2I or bmSKRHI or bmSKRHD or bmDPI or bmDPKI or bmDPZKI)
                                                                               
0CF6 C2B7           2745            clr     RDNOT
0CF8 00             2746            nop
0CF9 00             2747            nop
0CFA 00             2748            nop
0CFB 00             2749            nop
0CFC 858021         2750            mov     INPORTB, p0         ; uloz informaciu z datovej zbernice 
0CFF D2B7           2751            setb    RDNOT
                    2752    
0D01 75A082         2753            mov     p2, #i8255INC       ; citaj data z portu C
0D04 75803F         2754            mov     p0, #(bmPI1 or bmPI2D or bmPI2U or bmPI3D or bmPI3U or bmPI4)
0D07 C2B7           2755            clr     RDNOT
0D09 00             2756            nop
0D0A 00             2757            nop
0D0B 00             2758            nop
0D0C 00             2759            nop
0D0D 858022         2760            mov     INPORTC, p0         ; uloz informaciu z datovej zbernice 
0D10 D2B7           2761            setb    RDNOT
0D12 00             2762            nop
0D13 00             2763            nop
0D14 00             2764            nop
0D15 00             2765            nop
0D16 00             2766            nop
0D17 00             2767            nop
0D18 00             2768            nop
0D19 00             2769            nop
0D1A D2AF           2770            setb    EA                 ;znovu spustime prerusenia
                    2771            
                    2772            
0D1C 300F04         2773            jnb     DPK, READPORTS_C1
0D1F C222           2774            clr     FAST
0D21 D223           2775            setb    SLOW
0D23                2776    READPORTS_C1:         
0D23 204003         2777            jb      STOPNOT, READPORTS_C
0D26 120C76         2778            lcall   STOP
0D29                2779    READPORTS_C:        
0D29 E528           2780            mov     A, INPORTA
0D2B 541E           2781            anl     A, #00011110b
0D2D 4223           2782            orl     OUTPORTA, A
0D2F 120D3C         2783            call    WRITEPORTS              ; aktualizuj signalizaciu na ovladacom paneli
0D32 E522           2784            mov     A, INPORTC
0D34 543F           2785            anl     A, #00111111b
0D36 4225           2786            orl     OUTPORTC, A
0D38 120D3C         2787            call    WRITEPORTS              ; aktualizuj signalizaciu na ovladacom paneli
                    2788            
                    2789            
0D3B 22             2790            ret
                    2791            
DEBUG                                                                                                         PAGE 51

                    2792    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    2793    ; WRITEPORTS
                    2794    ; spravi zalohu vystupnych registrov a posle data von
                    2795    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0D3C                2796    WRITEPORTS:
0D3C C2AF           2797            clr     EA                  ;Treba zakazat prerusenia
                    2798            
0D3E 852380         2799            mov     p0, OUTPORTA        ; teraz postupne posli data najprv na port A,
0D41 75A0C0         2800            mov     p2, #i8255OUTA
0D44 C2B6           2801            clr     WRNOT
0D46 00             2802            nop
0D47 00             2803            nop
0D48 00             2804            nop
0D49 00             2805            nop
0D4A D2B6           2806            setb    WRNOT
                    2807            
0D4C 852480         2808            mov     p0, OUTPORTB        ; potom port B
0D4F 75A0C1         2809            mov     p2, #i8255OUTB
0D52 C2B6           2810            clr     WRNOT
0D54 00             2811            nop
0D55 00             2812            nop
0D56 00             2813            nop
0D57 00             2814            nop
0D58 D2B6           2815            setb    WRNOT
                    2816    
0D5A 852580         2817            mov     p0, OUTPORTC        ; a nakoniec port C
0D5D 75A0C2         2818            mov     p2, #i8255OUTC
0D60 C2B6           2819            clr     WRNOT
0D62 00             2820            nop
0D63 00             2821            nop
0D64 00             2822            nop
0D65 00             2823            nop
0D66 D2B6           2824            setb    WRNOT
0D68 00             2825            nop
0D69 00             2826            nop
0D6A 00             2827            nop
0D6B 00             2828            nop
0D6C 00             2829            nop
0D6D 00             2830            nop
0D6E 00             2831            nop
0D6F 00             2832            nop
0D70 D2AF           2833            setb     EA                  ;Treba zakazat prerusenia
0D72 22             2834            ret
                    2835    
                    2836    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    2837    
                    2838    
                    2839    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    2840    ; DISPSTR
                    2841    ; posle na seriovu linku retazec na adrese DPTR
                    2842    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0D73                2843    DISPSTR:
0D73 C0E0           2844            push    ACC
0D75                2845    DSPS_LOOP:           
0D75 E4             2846            clr     A
0D76 93             2847            movc    A, @A+DPTR
0D77 600A           2848            jz      DSPS_END
0D79 F599           2849            mov     SBUF, A
DEBUG                                                                                                         PAGE 52

0D7B 3099FD         2850            jnb     TI, $
0D7E C299           2851            clr     TI
0D80 A3             2852            inc     DPTR
0D81 80F2           2853            sjmp    DSPS_LOOP
0D83                2854    DSPS_END:
0D83 D0E0           2855            pop     ACC
0D85 22             2856            ret
                    2857            
                    2858    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                    2859    
0D86 0D0A5269       2860    STR_INIT:         db  0dh, 0ah, 'Riadiaci system je inicializovany.', 0dh, 0ah, 00h
0D8A 61646961   
0D8E 63692073   
0D92 79737465   
0D96 6D206A65   
0D9A 20696E69   
0D9E 6369616C   
0DA2 697A6F76   
0DA6 616E792E   
0DAA 0D0A00     
0DAD 52696164       2861    STR_STOP:         db  'Riadiaci system je reinicializovany po stlaceni tlacidla STOP.', 0dh,
                                                                                0ah, 00h
0DB1 69616369   
0DB5 20737973   
0DB9 74656D20   
0DBD 6A652072   
0DC1 65696E69   
0DC5 6369616C   
0DC9 697A6F76   
0DCD 616E7920   
0DD1 706F2073   
0DD5 746C6163   
0DD9 656E6920   
0DDD 746C6163   
0DE1 69646C61   
0DE5 2053544F   
0DE9 502E0D0A   
0DED 00         
0DEE 4B616C69       2862    STR_CALIB:        db  'Kalibracia vytahu je ukoncena.', 0dh, 0ah, 00h
0DF2 62726163   
0DF6 69612076   
0DFA 79746168   
0DFE 75206A65   
0E02 20756B6F   
0E06 6E63656E   
0E0A 612E0D0A   
0E0E 00         
0E0F 43687962       2863    STR_ERR_1SPOM_C:  db  'Chyba! Vypadla spomalovacia clonka!', 0dh, 0ah, 00h
0E13 61212056   
0E17 79706164   
0E1B 6C612073   
0E1F 706F6D61   
0E23 6C6F7661   
0E27 63696120   
0E2B 636C6F6E   
0E2F 6B61210D   
0E33 0A00       
0E35 43687962       2864    STR_ERR_2SPOM_C:  db  'Chyba! Vypadli dve spomalovacie clonky!', 0dh, 0ah, 00h
DEBUG                                                                                                         PAGE 53

0E39 61212056   
0E3D 79706164   
0E41 6C692064   
0E45 76652073   
0E49 706F6D61   
0E4D 6C6F7661   
0E51 63696520   
0E55 636C6F6E   
0E59 6B79210D   
0E5D 0A00       
0E5F 43687962       2865    STR_ERR_ZAST_C:   db  'Chyba! Vypadla zastavovacia clonka!', 0dh, 0ah, 00h
0E63 61212056   
0E67 79706164   
0E6B 6C61207A   
0E6F 61737461   
0E73 766F7661   
0E77 63696120   
0E7B 636C6F6E   
0E7F 6B61210D   
0E83 0A00       
0E85 43687962       2866    STR_ERR_SKRH:     db  'Chyba! Neocakavane nacitanie hornej spomalovacej clonky!', 0dh, 0ah, 
                                                                               00h
0E89 6121204E   
0E8D 656F6361   
0E91 6B617661   
0E95 6E65206E   
0E99 61636974   
0E9D 616E6965   
0EA1 20686F72   
0EA5 6E656A20   
0EA9 73706F6D   
0EAD 616C6F76   
0EB1 6163656A   
0EB5 20636C6F   
0EB9 6E6B7921   
0EBD 0D0A00     
0EC0 43687962       2867    STR_ERR_SKRD:     db  'Chyba! Neocakavane nacitanie dolnej spomalovacej clonky!', 0dh, 0ah, 
                                                                               00h
0EC4 6121204E   
0EC8 656F6361   
0ECC 6B617661   
0ED0 6E65206E   
0ED4 61636974   
0ED8 616E6965   
0EDC 20646F6C   
0EE0 6E656A20   
0EE4 73706F6D   
0EE8 616C6F76   
0EEC 6163656A   
0EF0 20636C6F   
0EF4 6E6B7921   
0EF8 0D0A00     
                    2868    
----                2869            DSEG
0040                2870            org     40h
0040                2871    STACK:  DS      10h
                    2872    
                    2873    end

VERSION 1.2h ASSEMBLY COMPLETE, 0 ERRORS FOUND
DEBUG                                                                                                         PAGE 54

ACC. . . . . . . . . . . . . . .  D ADDR  00E0H  PREDEFINED  
B. . . . . . . . . . . . . . . .  D ADDR  00F0H  PREDEFINED  
BMDOORCLSD . . . . . . . . . . .    NUMB  0020H  
BMDOWN . . . . . . . . . . . . .    NUMB  0002H  NOT USED  
BMDPI. . . . . . . . . . . . . .    NUMB  0020H  
BMDPKI . . . . . . . . . . . . .    NUMB  0080H  
BMDPZKI. . . . . . . . . . . . .    NUMB  0040H  
BMFAST . . . . . . . . . . . . .    NUMB  0004H  NOT USED  
BMFLED1. . . . . . . . . . . . .    NUMB  0010H  
BMFLED2. . . . . . . . . . . . .    NUMB  0020H  
BMFLED3. . . . . . . . . . . . .    NUMB  0040H  
BMFLED4. . . . . . . . . . . . .    NUMB  0080H  
BMKS . . . . . . . . . . . . . .    NUMB  0001H  NOT USED  
BMLEDD . . . . . . . . . . . . .    NUMB  0040H  
BMLEDU . . . . . . . . . . . . .    NUMB  0080H  
BMMB1I . . . . . . . . . . . . .    NUMB  0002H  
BMMB2I . . . . . . . . . . . . .    NUMB  0004H  
BMPI1. . . . . . . . . . . . . .    NUMB  0001H  
BMPI2D . . . . . . . . . . . . .    NUMB  0002H  
BMPI2U . . . . . . . . . . . . .    NUMB  0004H  
BMPI3D . . . . . . . . . . . . .    NUMB  0008H  
BMPI3U . . . . . . . . . . . . .    NUMB  0010H  
BMPI4. . . . . . . . . . . . . .    NUMB  0020H  
BMPKI1 . . . . . . . . . . . . .    NUMB  0002H  
BMPKI2 . . . . . . . . . . . . .    NUMB  0004H  
BMPKI3 . . . . . . . . . . . . .    NUMB  0008H  
BMPKI4 . . . . . . . . . . . . .    NUMB  0010H  
BMPKO1 . . . . . . . . . . . . .    NUMB  0002H  
BMPKO2 . . . . . . . . . . . . .    NUMB  0004H  
BMPKO3 . . . . . . . . . . . . .    NUMB  0008H  
BMPKO4 . . . . . . . . . . . . .    NUMB  0010H  
BMPO1. . . . . . . . . . . . . .    NUMB  0001H  
BMPO2D . . . . . . . . . . . . .    NUMB  0002H  
BMPO2U . . . . . . . . . . . . .    NUMB  0004H  
BMPO3D . . . . . . . . . . . . .    NUMB  0008H  
BMPO3U . . . . . . . . . . . . .    NUMB  0010H  
BMPO4. . . . . . . . . . . . . .    NUMB  0020H  
BMSKRHD. . . . . . . . . . . . .    NUMB  0010H  
BMSKRHI. . . . . . . . . . . . .    NUMB  0008H  
BMSLOW . . . . . . . . . . . . .    NUMB  0008H  NOT USED  
BMSTOP . . . . . . . . . . . . .    NUMB  0001H  
BMUP . . . . . . . . . . . . . .    NUMB  0001H  NOT USED  
CALIB. . . . . . . . . . . . . .  C ADDR  00BCH  NOT USED  
CALIBEND . . . . . . . . . . . .  C ADDR  00D5H  
CALIBEND2. . . . . . . . . . . .  C ADDR  00E0H  
CALIBLOOP. . . . . . . . . . . .  C ADDR  00CDH  
COUNT. . . . . . . . . . . . . .    NUMB  0014H  REDEFINABLE  
CTRLREG. . . . . . . . . . . . .  D ADDR  0027H  
D2_MB1C. . . . . . . . . . . . .  C ADDR  063CH  
D3_MB2C. . . . . . . . . . . . .  C ADDR  0945H  
D4_MB2C. . . . . . . . . . . . .  C ADDR  0B2DH  
DEL1 . . . . . . . . . . . . . .  C ADDR  0C97H  
DISPSTR. . . . . . . . . . . . .  C ADDR  0D73H  
DOORCLSD . . . . . . . . . . . .  B ADDR  0045H  NOT USED  
DOORCLSDOLD. . . . . . . . . . .  B ADDR  0039H  NOT USED  
DOWN . . . . . . . . . . . . . .  B ADDR  0021H  
DOWN2. . . . . . . . . . . . . .  C ADDR  0557H  
DOWN2ERR . . . . . . . . . . . .  C ADDR  059EH  
DEBUG                                                                                                         PAGE 55

DOWN2ERR_CONTINUE. . . . . . . .  C ADDR  05ADH  
DOWN2_MB1. . . . . . . . . . . .  C ADDR  0631H  
DOWN2_MB2. . . . . . . . . . . .  C ADDR  05C9H  
DOWN2_MB2A . . . . . . . . . . .  C ADDR  05D5H  
DOWN2_MB2ERR . . . . . . . . . .  C ADDR  05FFH  
DOWN2_MB2ERR_CONTINUE. . . . . .  C ADDR  060EH  
DOWN3. . . . . . . . . . . . . .  C ADDR  082DH  
DOWN3A . . . . . . . . . . . . .  C ADDR  084AH  
DOWN3_MB1. . . . . . . . . . . .  C ADDR  094FH  
DOWN3_MB2. . . . . . . . . . . .  C ADDR  088DH  
DOWN3_MB2A . . . . . . . . . . .  C ADDR  0899H  
DOWN3_STOP . . . . . . . . . . .  C ADDR  097CH  
DOWN4. . . . . . . . . . . . . .  C ADDR  0A15H  
DOWN4_MB1. . . . . . . . . . . .  C ADDR  0B37H  
DOWN4_MB2. . . . . . . . . . . .  C ADDR  0A75H  
DOWN4_MB2A . . . . . . . . . . .  C ADDR  0A81H  
DOWN4_STOP . . . . . . . . . . .  C ADDR  0B64H  
DOWNOLD. . . . . . . . . . . . .  B ADDR  003BH  
DP . . . . . . . . . . . . . . .  B ADDR  000DH  
DPK. . . . . . . . . . . . . . .  B ADDR  000FH  
DPZK . . . . . . . . . . . . . .  B ADDR  000EH  
DSPS_END . . . . . . . . . . . .  C ADDR  0D83H  
DSPS_LOOP. . . . . . . . . . . .  C ADDR  0D75H  
EA . . . . . . . . . . . . . . .  B ADDR  00AFH  PREDEFINED  
ENDD0. . . . . . . . . . . . . .  C ADDR  019FH  
ENDD1. . . . . . . . . . . . . .  C ADDR  01EEH  
ENDD10 . . . . . . . . . . . . .  C ADDR  0779H  
ENDD11 . . . . . . . . . . . . .  C ADDR  07DBH  
ENDD12 . . . . . . . . . . . . .  C ADDR  0870H  
ENDD13 . . . . . . . . . . . . .  C ADDR  08BFH  
ENDD14 . . . . . . . . . . . . .  C ADDR  0975H  
ENDD15 . . . . . . . . . . . . .  C ADDR  09A2H  
ENDD16 . . . . . . . . . . . . .  C ADDR  0A58H  
ENDD17 . . . . . . . . . . . . .  C ADDR  0AA7H  
ENDD18 . . . . . . . . . . . . .  C ADDR  0B5DH  
ENDD19 . . . . . . . . . . . . .  C ADDR  0B8AH  
ENDD2. . . . . . . . . . . . . .  C ADDR  02ABH  
ENDD3. . . . . . . . . . . . . .  C ADDR  02D8H  
ENDD4. . . . . . . . . . . . . .  C ADDR  0418H  
ENDD5. . . . . . . . . . . . . .  C ADDR  0467H  
ENDD6. . . . . . . . . . . . . .  C ADDR  0518H  
ENDD7. . . . . . . . . . . . . .  C ADDR  0545H  
ENDD8. . . . . . . . . . . . . .  C ADDR  059AH  
ENDD9. . . . . . . . . . . . . .  C ADDR  05FBH  
ENDPROG. . . . . . . . . . . . .  C ADDR  0C1AH  NOT USED  
ERRF12_C . . . . . . . . . . . .  D ADDR  0039H  
ERRF12_D . . . . . . . . . . . .  B ADDR  0059H  
ERRF12_U . . . . . . . . . . . .  B ADDR  0052H  
ERRF1_C. . . . . . . . . . . . .  D ADDR  0035H  NOT USED  
ERRF1_D. . . . . . . . . . . . .  B ADDR  0059H  
ERRF1_U. . . . . . . . . . . . .  B ADDR  0051H  NOT USED  
ERRF23_C . . . . . . . . . . . .  D ADDR  003AH  
ERRF23_D . . . . . . . . . . . .  B ADDR  005AH  
ERRF23_U . . . . . . . . . . . .  B ADDR  0053H  
ERRF2_C. . . . . . . . . . . . .  D ADDR  0036H  
ERRF2_D. . . . . . . . . . . . .  B ADDR  005AH  
ERRF2_U. . . . . . . . . . . . .  B ADDR  0052H  
ERRF34_C . . . . . . . . . . . .  D ADDR  003BH  
DEBUG                                                                                                         PAGE 56

ERRF34_D . . . . . . . . . . . .  B ADDR  005BH  
ERRF34_U . . . . . . . . . . . .  B ADDR  0054H  
ERRF3_C. . . . . . . . . . . . .  D ADDR  0037H  
ERRF3_D. . . . . . . . . . . . .  B ADDR  005BH  
ERRF3_U. . . . . . . . . . . . .  B ADDR  0053H  
ERRF4_C. . . . . . . . . . . . .  D ADDR  0038H  NOT USED  
ERRF4_D. . . . . . . . . . . . .  B ADDR  005CH  NOT USED  
ERRF4_U. . . . . . . . . . . . .  B ADDR  0054H  
ERRFLOOR_D . . . . . . . . . . .  D ADDR  002BH  
ERRFLOOR_U . . . . . . . . . . .  D ADDR  002AH  
ERROR1 . . . . . . . . . . . . .  C ADDR  0BE1H  
ERROR1C. . . . . . . . . . . . .  C ADDR  0BFAH  
ERROR1S. . . . . . . . . . . . .  C ADDR  0BECH  
ERROR2 . . . . . . . . . . . . .  C ADDR  0C0BH  
ERR_1SPOM_C. . . . . . . . . . .  C ADDR  0B9CH  NOT USED  
ERR_2SPOM_C. . . . . . . . . . .  C ADDR  0BB1H  NOT USED  
ERR_SKRD . . . . . . . . . . . .  C ADDR  0BCFH  
ERR_SKRH . . . . . . . . . . . .  C ADDR  0BD8H  
ERR_ZAST_C . . . . . . . . . . .  C ADDR  0BC6H  NOT USED  
ET0. . . . . . . . . . . . . . .  B ADDR  00A9H  PREDEFINED  
EX1. . . . . . . . . . . . . . .  B ADDR  00AAH  PREDEFINED  
F1OK . . . . . . . . . . . . . .  C ADDR  0150H  
F1S. . . . . . . . . . . . . . .  C ADDR  010FH  
F2 . . . . . . . . . . . . . . .  C ADDR  03B7H  
F2DOWN . . . . . . . . . . . . .  C ADDR  03C9H  
F2OK . . . . . . . . . . . . . .  C ADDR  0320H  
F2S. . . . . . . . . . . . . . .  C ADDR  02FEH  
F2SW . . . . . . . . . . . . . .  C ADDR  036CH  
F2UP . . . . . . . . . . . . . .  C ADDR  03BDH  
F3 . . . . . . . . . . . . . . .  C ADDR  0718H  
F3DOWN . . . . . . . . . . . . .  C ADDR  072AH  
F3OK . . . . . . . . . . . . . .  C ADDR  0681H  
F3S. . . . . . . . . . . . . . .  C ADDR  065FH  
F3SW . . . . . . . . . . . . . .  C ADDR  06CDH  
F3UP . . . . . . . . . . . . . .  C ADDR  071EH  
F4OK . . . . . . . . . . . . . .  C ADDR  0A09H  
F4S. . . . . . . . . . . . . . .  C ADDR  09C8H  
FAST . . . . . . . . . . . . . .  B ADDR  0022H  
FASTOLD. . . . . . . . . . . . .  B ADDR  003CH  NOT USED  
FLED1. . . . . . . . . . . . . .  B ADDR  0024H  
FLED2. . . . . . . . . . . . . .  B ADDR  0025H  
FLED3. . . . . . . . . . . . . .  B ADDR  0026H  
FLED4. . . . . . . . . . . . . .  B ADDR  0027H  
FLOOR1 . . . . . . . . . . . . .  C ADDR  00FBH  
FLOOR2 . . . . . . . . . . . . .  C ADDR  02EAH  
FLOOR3 . . . . . . . . . . . . .  C ADDR  064BH  
FLOOR4 . . . . . . . . . . . . .  C ADDR  09B4H  
HIGHEST. . . . . . . . . . . . .  D ADDR  0032H  NOT USED  
I8255INA . . . . . . . . . . . .    NUMB  0080H  
I8255INB . . . . . . . . . . . .    NUMB  0081H  
I8255INC . . . . . . . . . . . .    NUMB  0082H  
I8255INCW. . . . . . . . . . . .    NUMB  0083H  
I8255OUTA. . . . . . . . . . . .    NUMB  00C0H  
I8255OUTB. . . . . . . . . . . .    NUMB  00C1H  
I8255OUTC. . . . . . . . . . . .    NUMB  00C2H  
I8255OUTCW . . . . . . . . . . .    NUMB  00C3H  
INPORTA. . . . . . . . . . . . .  D ADDR  0028H  
INPORTB. . . . . . . . . . . . .  D ADDR  0021H  
DEBUG                                                                                                         PAGE 57

INPORTBOLD . . . . . . . . . . .  D ADDR  0026H  
INPORTC. . . . . . . . . . . . .  D ADDR  0022H  
INT_TIMER0 . . . . . . . . . . .  C ADDR  0C26H  
INT_TIMER0_END . . . . . . . . .  C ADDR  0C53H  
INT_TIMER0_MAIN. . . . . . . . .  C ADDR  0C38H  
KS . . . . . . . . . . . . . . .  B ADDR  0018H  
LEDD . . . . . . . . . . . . . .  B ADDR  002EH  
LEDU . . . . . . . . . . . . . .  B ADDR  002FH  
LOWEST . . . . . . . . . . . . .  D ADDR  0031H  NOT USED  
MAIN . . . . . . . . . . . . . .  C ADDR  00F5H  NOT USED  
MB1. . . . . . . . . . . . . . .  B ADDR  0009H  
MB1OLD . . . . . . . . . . . . .  B ADDR  0031H  NOT USED  
MB2. . . . . . . . . . . . . . .  B ADDR  000AH  
MB2OLD . . . . . . . . . . . . .  B ADDR  0032H  NOT USED  
OUTPORTA . . . . . . . . . . . .  D ADDR  0023H  
OUTPORTB . . . . . . . . . . . .  D ADDR  0024H  
OUTPORTBOLD. . . . . . . . . . .  D ADDR  0034H  NOT USED  
OUTPORTC . . . . . . . . . . . .  D ADDR  0025H  
P0 . . . . . . . . . . . . . . .  D ADDR  0080H  PREDEFINED  
P1 . . . . . . . . . . . . . . .  D ADDR  0090H  PREDEFINED  
P2 . . . . . . . . . . . . . . .  D ADDR  00A0H  PREDEFINED  
P3 . . . . . . . . . . . . . . .  D ADDR  00B0H  PREDEFINED  
PCON . . . . . . . . . . . . . .  D ADDR  0087H  PREDEFINED  
PI1. . . . . . . . . . . . . . .  B ADDR  0010H  NOT USED  
PI2D . . . . . . . . . . . . . .  B ADDR  0011H  
PI2U . . . . . . . . . . . . . .  B ADDR  0012H  
PI3D . . . . . . . . . . . . . .  B ADDR  0013H  
PI3U . . . . . . . . . . . . . .  B ADDR  0014H  
PI4. . . . . . . . . . . . . . .  B ADDR  0015H  NOT USED  
PKI1 . . . . . . . . . . . . . .  B ADDR  0041H  
PKI2 . . . . . . . . . . . . . .  B ADDR  0042H  
PKI3 . . . . . . . . . . . . . .  B ADDR  0043H  
PKI4 . . . . . . . . . . . . . .  B ADDR  0044H  
PKO1 . . . . . . . . . . . . . .  B ADDR  0019H  
PKO2 . . . . . . . . . . . . . .  B ADDR  001AH  
PKO3 . . . . . . . . . . . . . .  B ADDR  001BH  
PKO4 . . . . . . . . . . . . . .  B ADDR  001CH  
PO1. . . . . . . . . . . . . . .  B ADDR  0028H  
PO1D . . . . . . . . . . . . . .  B ADDR  0028H  
PO1U . . . . . . . . . . . . . .  B ADDR  0028H  
PO2D . . . . . . . . . . . . . .  B ADDR  0029H  
PO2U . . . . . . . . . . . . . .  B ADDR  002AH  
PO3D . . . . . . . . . . . . . .  B ADDR  002BH  
PO3U . . . . . . . . . . . . . .  B ADDR  002CH  
PO4. . . . . . . . . . . . . . .  B ADDR  002DH  
PO4D . . . . . . . . . . . . . .  B ADDR  002DH  
PO4U . . . . . . . . . . . . . .  B ADDR  002DH  
POSITION . . . . . . . . . . . .  D ADDR  0030H  NOT USED  
RDNOT. . . . . . . . . . . . . .  B ADDR  00B7H  
READPORTS. . . . . . . . . . . .  C ADDR  0CDDH  
READPORTS1 . . . . . . . . . . .  C ADDR  0C9DH  
READPORTS_C. . . . . . . . . . .  C ADDR  0D29H  
READPORTS_C1 . . . . . . . . . .  C ADDR  0D23H  
RESET. . . . . . . . . . . . . .  C ADDR  0033H  NOT USED  
SBUF . . . . . . . . . . . . . .  D ADDR  0099H  PREDEFINED  
SCON . . . . . . . . . . . . . .  D ADDR  0098H  PREDEFINED  
SKRD . . . . . . . . . . . . . .  B ADDR  000CH  
SKRDOLD. . . . . . . . . . . . .  B ADDR  0034H  NOT USED  
DEBUG                                                                                                         PAGE 58

SKRH . . . . . . . . . . . . . .  B ADDR  000BH  
SKRHOLD. . . . . . . . . . . . .  B ADDR  0033H  NOT USED  
SLOW . . . . . . . . . . . . . .  B ADDR  0023H  
SLOWOLD. . . . . . . . . . . . .  B ADDR  003DH  NOT USED  
SP . . . . . . . . . . . . . . .  D ADDR  0081H  PREDEFINED  
STACK. . . . . . . . . . . . . .  D ADDR  0040H  
START. . . . . . . . . . . . . .  C ADDR  0033H  
STOP . . . . . . . . . . . . . .  C ADDR  0C76H  
STOPC. . . . . . . . . . . . . .  C ADDR  0C86H  
STOPNOT. . . . . . . . . . . . .  B ADDR  0040H  
STOPPED. . . . . . . . . . . . .  B ADDR  0038H  
STOPTIMER. . . . . . . . . . . .  D ADDR  0033H  
STR_CALIB. . . . . . . . . . . .  C ADDR  0DEEH  NOT USED  
STR_ERR_1SPOM_C. . . . . . . . .  C ADDR  0E0FH  
STR_ERR_2SPOM_C. . . . . . . . .  C ADDR  0E35H  
STR_ERR_SKRD . . . . . . . . . .  C ADDR  0EC0H  
STR_ERR_SKRH . . . . . . . . . .  C ADDR  0E85H  
STR_ERR_ZAST_C . . . . . . . . .  C ADDR  0E5FH  
STR_INIT . . . . . . . . . . . .  C ADDR  0D86H  
STR_STOP . . . . . . . . . . . .  C ADDR  0DADH  NOT USED  
TCON . . . . . . . . . . . . . .  D ADDR  0088H  PREDEFINED  
TH0. . . . . . . . . . . . . . .  D ADDR  008CH  PREDEFINED  
TH1. . . . . . . . . . . . . . .  D ADDR  008DH  PREDEFINED  
TI . . . . . . . . . . . . . . .  B ADDR  0099H  PREDEFINED  
TIME0. . . . . . . . . . . . . .  C ADDR  0C62H  
TIME1. . . . . . . . . . . . . .  C ADDR  0C64H  
TIME10MS . . . . . . . . . . . .  C ADDR  0C60H  
TIME2. . . . . . . . . . . . . .  C ADDR  0C68H  
TIME3. . . . . . . . . . . . . .  C ADDR  0C6CH  
TIME4. . . . . . . . . . . . . .  C ADDR  0C73H  
TIMERCONST . . . . . . . . . . .    NUMB  00FAH  
TL0. . . . . . . . . . . . . . .  D ADDR  008AH  PREDEFINED  
TL1. . . . . . . . . . . . . . .  D ADDR  008BH  PREDEFINED  
TMOD . . . . . . . . . . . . . .  D ADDR  0089H  PREDEFINED  
TR0. . . . . . . . . . . . . . .  B ADDR  008CH  PREDEFINED  
TR1. . . . . . . . . . . . . . .  B ADDR  008EH  PREDEFINED  
U1_MB2C. . . . . . . . . . . . .  C ADDR  026FH  
U2_MB2C. . . . . . . . . . . . .  C ADDR  04E8H  
U3_MB1C. . . . . . . . . . . . .  C ADDR  081DH  
UP . . . . . . . . . . . . . . .  B ADDR  0020H  
UP1. . . . . . . . . . . . . . .  C ADDR  015CH  
UP1A . . . . . . . . . . . . . .  C ADDR  0179H  
UP1_MB1. . . . . . . . . . . . .  C ADDR  0279H  
UP1_MB1C . . . . . . . . . . . .  C ADDR  02AFH  NOT USED  
UP1_MB2. . . . . . . . . . . . .  C ADDR  01BCH  
UP1_MB2A . . . . . . . . . . . .  C ADDR  01C8H  
UP1_STOP . . . . . . . . . . . .  C ADDR  02B2H  
UP2. . . . . . . . . . . . . . .  C ADDR  03D5H  
UP2A . . . . . . . . . . . . . .  C ADDR  03F2H  
UP2_MB1. . . . . . . . . . . . .  C ADDR  04F2H  
UP2_MB2. . . . . . . . . . . . .  C ADDR  0435H  
UP2_MB2A . . . . . . . . . . . .  C ADDR  0441H  
UP2_STOP . . . . . . . . . . . .  C ADDR  051FH  
UP3. . . . . . . . . . . . . . .  C ADDR  0736H  
UP3A . . . . . . . . . . . . . .  C ADDR  0753H  
UP3ERR . . . . . . . . . . . . .  C ADDR  077DH  
UP3ERR_CONTINUE. . . . . . . . .  C ADDR  078DH  
UP3_MB1. . . . . . . . . . . . .  C ADDR  0812H  
DEBUG                                                                                                         PAGE 59

UP3_MB2. . . . . . . . . . . . .  C ADDR  07A9H  
UP3_MB2A . . . . . . . . . . . .  C ADDR  07B5H  
UP3_MB2ERR . . . . . . . . . . .  C ADDR  07DFH  
UP3_MB2ERR_CONTINUE. . . . . . .  C ADDR  07EFH  
UPOLD. . . . . . . . . . . . . .  B ADDR  003AH  
WAITFORTIMER . . . . . . . . . .  C ADDR  0C95H  
WRITEPORTS . . . . . . . . . . .  C ADDR  0D3CH  
WRNOT. . . . . . . . . . . . . .  B ADDR  00B6H  
